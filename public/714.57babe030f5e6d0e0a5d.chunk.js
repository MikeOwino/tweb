"use strict";(this.webpackChunktweb=this.webpackChunktweb||[]).push([[714],{1425:(e,t,s)=>{s.d(t,{lh:()=>l,dJ:()=>u,br:()=>p,ZP:()=>h});var i=s(5003);class n{constructor(e){this.items=new Map,this.locked=!1,this.observer=new IntersectionObserver((t=>{if(this.locked)return;const s=[];t.forEach((e=>{const t=e.target;this.items.get(t)!==e.isIntersecting&&(this.items.set(t,e.isIntersecting),s[e.isIntersecting?"unshift":"push"]({target:t,visible:e.isIntersecting}))})),s.forEach((t=>{e(t.target,t.visible)}))}))}getVisible(){const e=[];return this.items.forEach(((t,s)=>{t&&e.push(s)})),e}clearVisible(){const e=this.getVisible();for(const t of e)this.items.set(t,!1)}isVisible(e){return this.items.get(e)}disconnect(){this.observer.disconnect(),this.items.clear()}refresh(){this.observer.disconnect();const e=[...this.items.keys()];for(const t of e)this.observer.observe(t)}refreshVisible(){const e=this.getVisible();for(const t of e)this.observer.unobserve(t);for(const t of e)this.observer.observe(t)}observe(e){this.items.set(e,!1),this.observer.observe(e)}unobserve(e){this.observer.unobserve(e),this.items.delete(e)}unlock(){this.locked=!1}unlockAndRefresh(){this.unlock(),this.refresh()}lock(){this.locked=!0}}var a=s(6724);function r(e,t){const s=[];let i=-1;for(;-1!==(i=e.findIndex(t));)s.push(e.splice(i,1)[0]);return s}var o=s(1655),d=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class l{constructor(e=8){this.parallelLimit=e,this.queueId=0,this.queue=[],this.inProcess=new Set,this.lockPromise=null,this.unlockResolve=null,this.log=(0,i.kg)("LL",i.v9.Error),this.processQueue=(0,a.Z)((()=>this._processQueue()),20,!1)}clear(){this.inProcess.clear(),this.queue.length=0}lock(){this.lockPromise||(this.lockPromise=new Promise(((e,t)=>{this.unlockResolve=e})))}unlock(){this.unlockResolve&&(this.unlockResolve(),this.unlockResolve=this.lockPromise=null,this.processQueue())}processItem(e){return d(this,void 0,void 0,(function*(){if(!this.lockPromise){this.inProcess.add(e);try{yield this.loadItem(e)}catch(e){["NO_ENTRY_FOUND","STORAGE_OFFLINE"].includes(e)||this.log.error("loadMediaQueue error:",e)}this.inProcess.delete(e),this.processQueue()}}))}loadItem(e){return e.load()}getItem(){return this.queue.shift()}addElement(e,t){this.queue[e](t),this.processQueue()}_processQueue(e){if(!(!this.queue.length||this.lockPromise||this.parallelLimit>0&&this.inProcess.size>=this.parallelLimit))do{if(e?(0,o.Z)(this.queue,e):e=this.getItem(),!e)break;this.processItem(e),e=null}while(this.inProcess.size<this.parallelLimit&&this.queue.length)}push(e){this.addElement("push",e)}unshift(e){this.addElement("unshift",e)}}class c extends l{constructor(e=8){super(e),this.parallelLimit=e,this.queue=[],this.inProcess=new Set}lock(){super.lock(),this.intersector.lock()}unlock(){super.unlock(),this.intersector.unlock()}unlockAndRefresh(){super.unlock(),this.intersector.unlockAndRefresh()}clear(){super.clear(),this.intersector.disconnect()}refresh(){this.intersector.refresh()}loadItem(e){return e.load(e.div)}addElement(e,t){if(this.queue.find((e=>e.div===t.div&&e.load===t.load)))return!1;for(const e of this.inProcess)if(e.div===t.div&&e.load===t.load)return!1;return this.queue[e](t),!0}setProcessQueueTimeout(){this.intersectorTimeout||(this.intersectorTimeout=window.setTimeout((()=>{this.intersectorTimeout=0,this.processQueue()}),0))}push(e){super.push(e)}unshift(e){super.unshift(e)}unobserve(e){r(this.queue,(t=>t.div===e)),this.intersector.unobserve(e)}}class h extends c{constructor(e=8){super(e),this.parallelLimit=e,this.onVisibilityChange=(e,t)=>{t&&(r(this.queue,(t=>t.div===e)).forEach((e=>{e.wasSeen=!0,this.queue.unshift(e)})),this.setProcessQueueTimeout())},this.intersector=new n(this.onVisibilityChange)}getItem(){return this.queue.findAndSplice((e=>e.wasSeen))}processItem(e){const t=Object.create(null,{processItem:{get:()=>super.processItem}});return d(this,void 0,void 0,(function*(){yield t.processItem.call(this,e),this.intersector.unobserve(e.div)}))}addElement(e,t){return!!super.addElement(e,t)&&(this.intersector.observe(t.div),t.hasOwnProperty("wasSeen")||(t.wasSeen=!1),!0)}}class u extends c{constructor(e=8,t){super(e),this.parallelLimit=e,this.onVisibilityChange=t,this._queue=new Map,this.intersector=new n(((e,t)=>{const s=r(this.queue,(t=>t.div===e));t&&(s.length?s:[this._queue.get(e)]).forEach((t=>{this.queue.unshift(t||this._queue.get(e))})),this.onVisibilityChange&&this.onVisibilityChange(e,t),this.setProcessQueueTimeout()}))}clear(){super.clear(),this._queue.clear()}observe(e){this._queue.set(e.div,e),this.intersector.observe(e.div)}}class p extends c{constructor(e=8,t){super(e),this.parallelLimit=e,this.onVisibilityChange=t,this.intersector=new n(((e,t)=>{const s=r(this.queue,(t=>t.div===e));t&&s.length&&s.forEach((e=>{this.queue.unshift(e)})),this.onVisibilityChange&&this.onVisibilityChange(e,t),this.setProcessQueueTimeout()}))}observe(e){this.intersector.observe(e)}}},3251:(e,t,s)=>{s.d(t,{I:()=>p,P:()=>r});var i=s(3228);const n=new Map,a=new Set,r='Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif';let o;const d=()=>{cancelAnimationFrame(o),o=window.requestAnimationFrame(l)},l=()=>{a.forEach(c),a.clear()};window.addEventListener("resize",(()=>{for(const[e]of n)a.add(e);d()}),{capture:!0,passive:!0});const c=e=>{let t=n.get(e);const s=!t;let{text:a,textLength:o,from:d,multiplier:l,font:c,textWidth:h,elementWidth:p}=t||{};s&&(a=e.textContent,o=a.length,d=50,l=d>0&&d/100,c=`${e.dataset.fontWeight||400} 16px ${r}`,h=u(a,c),p=e.getBoundingClientRect().width,t={text:a,textLength:o,from:d,multiplier:l,font:c,textWidth:h,elementWidth:p},n.set(e,t));const g=e.getBoundingClientRect().width,f=s||p!==g;if(!s&&f&&(t.elementWidth=p=g),f)if(h>p){e.setAttribute("title",a);let s=a,n=p;for(;s.length>3;){let t=s.length;const a=l&&(0,i.Z)(l*t<<0,1,t-2)||Math.max(t+d-1,1),r=s.substr(0,a).replace(/\s*$/,""),o=s.substr(a+1).replace(/^\s*/,"");if(s=r+o,n=u(s+"…",c),n<p){e.textContent=r+"…"+o;break}}t.elementWidth=e.getBoundingClientRect().width}else e.removeAttribute("title")};let h;function u(e,t){if(!h){const e=document.createElement("canvas");h=e.getContext("2d"),h.font=t}return h.measureText(e).width}class p extends HTMLElement{constructor(){super()}connectedCallback(){n.set(this,null),a.add(this),d()}disconnectedCallback(){n.delete(this)}}customElements.define("middle-ellipsis-element",p)},1431:(e,t,s)=>{s.d(t,{Z:()=>p});var i=s(410),n=s(6440),a=s(3512),r=s(4727),o=s(5565),d=s(5555),l=s(8598),c=s(1507),h=s(8456);const u=new WeakMap;i.GO.peerTitleWeakMap=u,a.default.addEventListener("peer_title_edit",(e=>{Array.from(document.querySelectorAll(`.peer-title[data-peer-id="${e}"]`)).forEach((e=>{const t=u.get(e);t&&t.update()}))}));class p{constructor(e){this.plainText=!1,this.onlyFirstName=!1,this.dialog=!1,this.element=document.createElement("span"),this.element.classList.add("peer-title"),this.element.setAttribute("dir","auto"),this.update(e),u.set(this.element,this)}update(e){if(e)for(let t in e)this.element.dataset[t]=e[t]?""+("boolean"==typeof e[t]?+e[t]:e[t]):"0",this[t]=e[t];let t=this.fromName;if(void 0!==t)return void 0!==this.limitSymbols&&(t=(0,h.Z)(t,this.limitSymbols,this.limitSymbols)),void(this.element.innerHTML=l.Z.wrapEmojiText(t));void 0===this.peerId&&(this.peerId=c.NM),this.peerId===a.default.myId&&this.dialog?(0,o.Z)(this.element,(0,r.i18n)(this.onlyFirstName?"Saved":"SavedMessages")):this.peerId.isUser()&&d.Z.getUser(this.peerId).pFlags.deleted?(0,o.Z)(this.element,(0,r.i18n)(this.onlyFirstName?"Deleted":"HiddenName")):this.element.innerHTML=n.Z.getPeerTitle(this.peerId,this.plainText,this.onlyFirstName,this.limitSymbols)}}},1964:(e,t,s)=>{s.d(t,{Z:()=>l});var i=s(9099),n=s(3035),a=s(3910),r=s(2738),o=s(8487),d=s(5953);class l{constructor(e){this.tempId=0,this.detached=!0,this.promise=null,this.isUpload=!1,this.cancelable=!0,this.streamable=!1,this.tryAgainOnFail=!0,this.attachMethod="append",this.onClick=e=>{e&&(0,a.d)(e),this.preloader.classList.contains("manual")?this.loadFunc&&this.loadFunc(e):this.promise&&this.promise.cancel&&this.promise.cancel()},e&&(0,d.Z)(this,e)}constructContainer(e={}){this.preloader||(this.preloader=document.createElement("div"),this.preloader.classList.add("preloader-container"),e.color&&this.preloader.classList.add("preloader-"+e.color),e.bold&&this.preloader.classList.add("preloader-bold"),this.streamable&&this.preloader.classList.add("preloader-streamable"))}constructDownloadIcon(){this.constructContainer()}construct(){this.construct=null,this.constructContainer(),this.preloader.innerHTML=`\n    <div class="you-spin-me-round">\n    <svg xmlns="http://www.w3.org/2000/svg" class="preloader-circular" viewBox="${this.streamable?"25 25 50 50":"27 27 54 54"}">\n    <circle class="preloader-path-new" cx="${this.streamable?"50":"54"}" cy="${this.streamable?"50":"54"}" r="${this.streamable?19:24}" fill="none" stroke-miterlimit="10"/>\n    </svg>\n    </div>`,this.streamable?this.totalLength=118.61124420166016:this.totalLength=149.82473754882812,this.cancelable?(this.preloader.innerHTML+='\n      <svg xmlns="http://www.w3.org/2000/svg" class="preloader-close" viewBox="0 0 24 24">\n        <g fill="none" fill-rule="evenodd">\n          <polygon points="0 0 24 0 24 24 0 24"/>\n          <path fill="#000" fill-rule="nonzero" d="M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z"/>\n        </g>\n      </svg>\n      <svg xmlns="http://www.w3.org/2000/svg" class="preloader-download" viewBox="0 0 24 24">\n        <g fill="none" fill-rule="evenodd">\n          <polygon points="0 0 24 0 24 24 0 24"/>\n          <path fill="#000" fill-rule="nonzero" d="M5,19 L19,19 C19.5522847,19 20,19.4477153 20,20 C20,20.5128358 19.6139598,20.9355072 19.1166211,20.9932723 L19,21 L5,21 C4.44771525,21 4,20.5522847 4,20 C4,19.4871642 4.38604019,19.0644928 4.88337887,19.0067277 L5,19 L19,19 L5,19 Z M11.8833789,3.00672773 L12,3 C12.5128358,3 12.9355072,3.38604019 12.9932723,3.88337887 L13,4 L13,13.585 L16.2928932,10.2928932 C16.6533772,9.93240926 17.2206082,9.90467972 17.6128994,10.2097046 L17.7071068,10.2928932 C18.0675907,10.6533772 18.0953203,11.2206082 17.7902954,11.6128994 L17.7071068,11.7071068 L12.7071068,16.7071068 C12.3466228,17.0675907 11.7793918,17.0953203 11.3871006,16.7902954 L11.2928932,16.7071068 L6.29289322,11.7071068 C5.90236893,11.3165825 5.90236893,10.6834175 6.29289322,10.2928932 C6.65337718,9.93240926 7.22060824,9.90467972 7.61289944,10.2097046 L7.70710678,10.2928932 L11,13.585 L11,4 C11,3.48716416 11.3860402,3.06449284 11.8833789,3.00672773 L12,3 L11.8833789,3.00672773 Z"/>\n        </g>\n      </svg>',this.downloadSvg=this.preloader.lastElementChild,this.cancelSvg=this.downloadSvg.previousElementSibling):this.preloader.classList.add("preloader-swing"),this.circle=this.preloader.firstElementChild.firstElementChild.firstElementChild,this.cancelable&&(0,r.fc)(this.preloader,this.onClick)}setDownloadFunction(e){this.loadFunc=e}setManual(){this.preloader.classList.add("manual"),this.setProgress(0)}attachPromise(e){if(this.isUpload&&this.promise)return;this.promise=e;const t=--this.tempId,s=Date.now(),i=i=>{if(e.notify=e.notifyAll=null,t!==this.tempId)return;const a=Date.now()-s;if(!i&&this.cancelable){this.setProgress(100);const e=150;a<e?this.detach():setTimeout((()=>{t===this.tempId&&this.detach()}),e)}else this.tryAgainOnFail?(this.attach(this.preloader.parentElement),(0,n.T2)((()=>{this.setManual()}))):this.detach();this.promise=e=null};e.then((()=>i(null))).catch((e=>i(e))),e.addNotifyListener&&e.addNotifyListener((e=>{if(t!==this.tempId)return;const s=e.done/e.total*100;this.setProgress(s)}))}attach(e,t=!1,s){if(this.construct&&this.construct(),this.preloader.parentElement&&this.preloader.classList.remove("manual"),this.detached=!1,s&&this.attachPromise(s),this.detached||this.preloader.parentElement!==e){const t=(0,o.Z)(this.preloader)?1:2;this.preloader.parentElement!==e&&e[this.attachMethod](this.preloader),(0,i.Z)(this.preloader,"is-visible",!0,200,void 0,t)}this.cancelable&&t&&this.setProgress(0)}detach(){this.detached||(this.detached=!0,this.preloader&&this.preloader.parentElement&&(0,i.Z)(this.preloader,"is-visible",!1,200,(()=>{this.preloader.remove()}),1))}setProgress(e){if(this.totalLength||(0,o.Z)(this.circle))if(0!==e)try{this.totalLength||(this.totalLength=this.circle.getTotalLength()),this.circle.style.strokeDasharray=Math.max(5,e/100*this.totalLength)+", "+this.totalLength}catch(e){}else this.circle.style.strokeDasharray=""}}},1174:(e,t,s)=>{s.d(t,{Z:()=>a});var i=s(5269);const n=new Set(["image/jpeg","image/png","image/bmp"]);i.Z&&n.add("image/webp");const a=n},2131:(e,t,s)=>{s.d(t,{Z:()=>i});const i=!!(null===navigator||void 0===navigator?void 0:navigator.vibrate)},5844:(e,t,s)=>{s.d(t,{Z:()=>r});var i=s(4762);const n=!!document.createElement("video").canPlayType("video/quicktime")||i.IS_SAFARI||i.IS_APPLE_MOBILE,a=new Set(["image/gif","video/mp4","video/webm"]);n&&a.add("video/quicktime");const r=a},393:(e,t,s)=>{s.d(t,{Z:()=>a});var i=s(4762);const n=!!document.createElement("video").canPlayType("video/webm")&&!i.IS_SAFARI&&!i.IS_APPLE_MOBILE;window.IS_WEBM_SUPPORTED=n;const a=n},6690:(e,t,s)=>{function i(e){return[...new Set(e)]}s.d(t,{Z:()=>i})},6519:(e,t,s)=>{function i(e,t,s,i){const n=t[s];if(void 0===i&&-1!==(i=e.indexOf(t))){const t=e[i-1],a=e[i+1];if((!t||t[s]>=n)&&(!a||a[s]<=n))return i;e.splice(i,1)}const a=e.length;if(!a||n<=e[a-1][s])return e.push(t)-1;if(n>=e[0][s])return e.unshift(t),0;for(let i=0;i<a;i++)if(n>e[i][s])return e.splice(i,0,t),i;return console.error("wtf",e,t),e.indexOf(t)}s.d(t,{Z:()=>i})},8938:(e,t,s)=>{function i(e){}s.d(t,{Z:()=>i})},5916:(e,t,s)=>{s.d(t,{Z:()=>i});class i{constructor(e){this.assets=e,this.tempId=0}playSound(e,t=!1){++this.tempId,this.assetName=e;try{const s=this.createAudio();s.autoplay=!0,s.src="assets/audio/"+e,s.loop=t,s.play()}catch(t){console.error("playSound",e,t)}}playSoundIfDifferent(e,t){this.assetName!==e&&this.playSound(e,t)}createAudio(){let{audio:e}=this;return e||(e=this.audio=new Audio,e.play(),e)}stopSound(){this.audio&&this.audio.pause()}cancelDelayedPlay(){++this.tempId}playSoundWithTimeout(e,t,s){const i=++this.tempId;setTimeout((()=>{this.tempId===i&&this.playSound(e,t)}),s)}}},6705:(e,t,s)=>{s.d(t,{Z:()=>f});var i=s(3725),n=s(8594),a=s(3035);const r=[];let o=!1;function d(e,t="push"){return e.items.length?(e.promise=(0,i.b)(),r[t](e),l(),e.promise):Promise.resolve([])}function l(){o||function(e){if(!e.items.length)return e.promise.resolve([]),Promise.resolve([]);const t=e.items.slice(),s=[];return new Promise(((i,r)=>{const o=()=>{return d=this,l=void 0,h=function*(){const d=performance.now();do{yield(0,n.e9)();const i=e.process.apply(e.context,t.shift());let a;if(i instanceof Promise)try{a=yield i}catch(e){return void r(e)}else a=i;s.push(a)}while(t.length>0&&performance.now()-d<6);t.length>0?(0,a.T2)(o):i(s)},new((c=void 0)||(c=Promise))((function(e,t){function s(e){try{n(h.next(e))}catch(e){t(e)}}function i(e){try{n(h.throw(e))}catch(e){t(e)}}function n(t){var n;t.done?e(t.value):(n=t.value,n instanceof c?n:new c((function(e){e(n)}))).then(s,i)}n((h=h.apply(d,l||[])).next())}));var d,l,c,h};(0,a.T2)(o)})).then(e.promise.resolve,e.promise.reject)}(r.shift()).finally((()=>{o=!1,r.length&&l()}))}const c="filter"in(document.createElement("canvas").getContext("2d")||{});let h,u;function p(e,t,s){return new Promise((i=>{const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const a=n.getContext("2d",{alpha:!1});c?(a.filter=`blur(${t}px)`,a.drawImage(e,2*-t,2*-t,n.width+4*t,n.height+4*t)):(a.drawImage(e,0,0),u(a,0,0,n.width,n.height,t,s)),i(n.toDataURL())}))}h=c?Promise.resolve():s.e(77).then(s.bind(s,7077)).then((e=>{u=e.default}));const g=new Map;function f(e,t=2,s=2){if(!e)return console.error("no dataUri for blur",e),Promise.resolve(e);if(g.size>1e3&&g.clear(),g.has(e))return g.get(e);const i=new Promise((i=>{h.then((()=>{const n=new Image;n.onload=()=>{c?p(n,t,s).then(i):d({items:[[n,t,s]],context:null,process:p},"unshift").then((e=>{i(e[0])}))},n.src=e}))}));return g.set(e,i),i}},3306:(e,t,s)=>{function i(e){const t=e.length,s=new Uint8Array(Math.ceil(t/2));let i=0;t%2&&(s[i++]=parseInt(e.charAt(0),16));for(let n=i;n<t;n+=2)s[i++]=parseInt(e.substr(n,2),16);return s}s.d(t,{Z:()=>i})},1549:(e,t,s)=>{function i(e){const t=e.length,s=new Array(t);for(let i=0;i<t;++i)s[i]=(e[i]<16?"0":"")+(e[i]||0).toString(16);return s.join("")}s.d(t,{Z:()=>i})},6654:(e,t,s)=>{function i(e,t){return e instanceof Promise?e.then(t):t(e)}s.d(t,{Z:()=>i})},467:(e,t,s)=>{s.d(t,{ST:()=>r,ZP:()=>d,gV:()=>l});var i=s(6718);const n=/[`~!@#$%^&*()\-_=+\[\]\\|{}'";:\/?.>,<]+/g,a=/^\s+|\s$/g;function r(e){return e.replace(n,"").replace(a,"")}function o(e){return e.replace(/[^A-Za-z0-9]/g,(e=>{const t=i.ZP.LatinizeMap[e];return void 0!==t?t:e}))}function d(e,t=!0){const s="%"===e.charAt(0);return e=r(e),t&&(e=o(e)),e=e.toLowerCase(),s&&(e="%"+e),e}function l(e,t={}){const s=t.includeTag&&"%"===e.charAt(0);return t.clearBadChars&&(e=r(e)),t.latinize&&(e=o(e)),t.ignoreCase&&(e=e.toLowerCase()),s&&(e="%"+e),e}},5705:(e,t,s)=>{function i(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content}s.d(t,{Z:()=>i})},2614:(e,t,s)=>{function i(e){const t=document.createElement("span");return t.innerHTML=e,t}s.d(t,{Z:()=>i})},6740:(e,t,s)=>{s.d(t,{ZP:()=>a,cj:()=>r});const i={},n=(e,t)=>{e instanceof HTMLImageElement||e instanceof HTMLVideoElement?e.src=t:e instanceof SVGImageElement?e.setAttributeNS(null,"href",t):e.style.backgroundImage="url("+t+")"};function a(e,t,s,a=!0){if(!t)return console.error("renderImageFromUrl: no url?",e,t),void(s&&s());if(i[t]&&a||e instanceof HTMLVideoElement)e&&n(e,t),s&&s();else{const a=e instanceof HTMLImageElement,r=a?e:new Image;r.src=t,r.addEventListener("load",(()=>{!a&&e&&n(e,t),i[t]=!0,s&&s()}),{once:!0}),s&&r.addEventListener("error",(e=>{console.error("Render image from url failed:",e,t,r),s()}))}}function r(e,t,s){return new Promise((i=>{a(e,t,i,s)}))}},6056:(e,t,s)=>{s.d(t,{hf:()=>u,il:()=>d,nD:()=>h,ud:()=>l,xD:()=>c,zr:()=>o});var i=s(4755),n=s(5418),a=s(4762),r=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};function o(e){let t,s;return e instanceof HTMLVideoElement?(t=e.videoWidth,s=e.videoHeight):(t=e.naturalWidth,s=e.naturalHeight),n={media:e,mediaSize:(0,i.CJ)(t,s),boxSize:(0,i.CJ)(320,240),quality:.9},new Promise((e=>{var t,s;const i=document.createElement("canvas"),a=n.mediaSize.aspectFitted(n.boxSize);i.width=a.width*window.devicePixelRatio,i.height=a.height*window.devicePixelRatio,i.getContext("2d").drawImage(n.media,0,0,i.width,i.height),i.toBlob((t=>{e({blob:t,size:a})}),null!==(t=n.mimeType)&&void 0!==t?t:"image/jpeg",null!==(s=n.quality)&&void 0!==s?s:1)}));var n}function d(e){return new Promise(((t,s)=>{e.onseeked=()=>{e.onseeked=()=>{o(e).then(t),e.onseeked=void 0},e.currentTime=0},e.onerror=s,e.currentTime=Math.min(e.duration,1)}))}function l(e){return r(this,void 0,void 0,(function*(){const t=yield function(e){return new Promise(((t,s)=>{const i=document.createElement("video");i.volume=0,i.addEventListener("loadedmetadata",(()=>t(i)),{once:!0}),i.addEventListener("error",s,{once:!0}),i.src=e}))}(e);return Promise.race([(0,n.w)(2e3),d(t)])}))}function c(e,t=e.HAVE_METADATA,s){return new Promise((i=>{e.readyState>=t?i():e.addEventListener(a.IS_APPLE_MOBILE&&!s?"loadeddata":"canplay",(()=>i()),{once:!0})}))}function h(e,t=!1){return r(this,void 0,void 0,(function*(){const s=[],i=(e,n)=>r(this,void 0,void 0,(function*(){if(e.isDirectory){const t=e.createReader();yield new Promise(((e,s)=>{t.readEntries((t=>r(this,void 0,void 0,(function*(){for(const e of t)yield i(e,n);e()}))))}))}else if(e)if(t)s.push(e.type);else{const t=n.getAsFile(),i=e instanceof File?e:e instanceof DataTransferItem?e.getAsFile():yield new Promise(((s,i)=>e.file(s,(e=>s(t)))));if(!i)return;s.push(i)}}));if(e instanceof DragEvent&&e.dataTransfer.files&&!e.dataTransfer.items)for(let i=0;i<e.dataTransfer.files.length;i++){const n=e.dataTransfer.files[i];s.push(t?n.type:n)}else{const s=(e.dataTransfer||e.clipboardData||e.originalEvent.clipboardData).items,n=[];for(let e=0;e<s.length;++e){const a=s[e];if("file"===a.kind){const e=(t?a:a.webkitGetAsEntry())||a.getAsFile();n.push(i(e,a))}}yield Promise.all(n)}return s}))}function u(e){const t=document.createElement("input");t.type="file",t.style.display="none",e&&(t.accept=e),document.body.append(t);const s=new Promise(((e,s)=>{t.addEventListener("change",(t=>{const i=t.target.files[0];i?e(i):s("NO_FILE_SELECTED")}),{once:!0})})).finally((()=>{t.remove()}));return t.click(),s}},8079:(e,t,s)=>{function i(e,t){return t?e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,""):e.replace(/-/g,"+").replace(/_/g,"/")}s.d(t,{Z:()=>i})},8939:(e,t,s)=>{s.d(t,{Z:()=>a});var i=s(4727);const n={s:"Seconds",m:"Minutes",h:"Hours",d:"Days",w:"Weeks"};function a(e,t){const s=function(e,t=2){e||(e=1);let s=[];const i=[{m:1,t:"s"},{m:60,t:"m"},{m:60,t:"h"},{m:24,t:"d"},{m:7,t:"w"}];let n=1;i.forEach(((t,a)=>{if(n*=t.m,e<n)return;const r=i[a===i.length-1?a:a+1].m;s.push({duration:e/n%r|0,type:t.t})}));const a=s.slice(-t).reverse();for(let e=a.length-1;e>=0;--e)0===a[e].duration&&a.splice(e,1);return a}(e,2);if(t){const e=s.map((e=>i.default.format(n[e.type],!0,[e.duration])));return(0,i.join)(e,!1,t)}const a=s.map((e=>(0,i.i18n)(n[e.type],[e.duration]))),r=document.createElement("span");return r.append(...(0,i.join)(a,!1)),r}},3624:(e,t,s)=>{s.d(t,{k:()=>i});const i=()=>{let e={cleaned:!1};return{clean:()=>{e.cleaned=!0,e={cleaned:!1}},get:t=>{const s=e;return()=>!s.cleaned&&(!t||t())}}}},2575:(e,t,s)=>{function i(e,t=" "){const s=e.toString().split(".");return s[0]=s[0].replace(/\B(?=(\d{3})+(?!\d))/g,t),s.join(".")}s.d(t,{Z:()=>i})},8027:(e,t,s)=>{function i(e,t){const s={writable:!0,configurable:!0},i={};t.forEach((t=>{e.hasOwnProperty(t)||(i[t]=s)})),Object.defineProperties(e,i)}s.d(t,{Z:()=>i})},7401:(e,t,s)=>{function i(e,t="asc"){if(!e)return[];const s=e instanceof Map?[...e.keys()]:Object.keys(e).map((e=>+e));return"asc"===t?s.sort(((e,t)=>e-t)):s.sort(((e,t)=>t-e))}s.d(t,{Z:()=>i})},4463:(e,t,s)=>{function i(e,t,s){"byteLength"in s[e]&&(s[e]=[...s[e]]),t&&t[e]!==s[e]&&(t[e].length=s[e].length,s[e].forEach(((s,i)=>{t[e][i]=s})),s[e]=t[e])}s.d(t,{Z:()=>i})},3442:(e,t,s)=>{function i(e,t){if(!e)return t;for(var s in e)t.hasOwnProperty(s)||delete e[s];for(var s in t)e[s]=t[s];return e}s.d(t,{Z:()=>i})},5393:(e,t,s)=>{s.d(t,{D:()=>i,Z:()=>a});var i,n=s(410);!function(e){e[e.None=0]="None",e[e.Top=1]="Top",e[e.Bottom=2]="Bottom",e[e.Both=3]="Both"}(i||(i={}));class a{constructor(){this.sliceConstructor=a.getSliceConstructor(this);const e=this.constructSlice();this.slices=[e]}static getSliceConstructor(e){return class extends Array{constructor(){super(...arguments),this.end=i.None}isEnd(t){if((this.end&t)===t)return!0;let s=!1;if(t===i.Top){const i=e.last;s=!!(i.end&t)&&this.includes(i[i.length-1])}else if(t===i.Bottom){const i=e.first;s=!!(i.end&t)&&this.includes(i[0])}else if(t===i.Both)return this.isEnd(i.Top)&&this.isEnd(i.Bottom);return s&&this.setEnd(t),s}setEnd(e){this.end|=e}unsetEnd(e){this.end&=~e}splice(t,s,...n){const a=super.splice(t,s,...n);if(!this.length){const t=e.slices,s=t.indexOf(this);-1!==s&&(1===t.length?this.unsetEnd(i.Both):t.splice(s,1))}return a}}}constructSlice(...e){const t=new this.sliceConstructor(e.length);for(let s=0,i=e.length;s<i;++s)t[s]=e[s];return t}insertSlice(e,t=!0){if(!e.length)return;const s=this.slices[0];if(!s.length)return s.push(...e),s;const i=e[e.length-1],n=e[0];let a,r=-1,o=-1,d=0;for(;d<this.slices.length&&(a=this.slices[d],r=a.indexOf(i),o=a.indexOf(n),-1===o||-1===r)&&-1===o&&-1===r;++d);if(-1!==o&&-1!==r);else if(-1!==o){const t=e.slice(a.length-o);a.push(...t)}else if(-1!==r){const t=e.slice(0,e.length-r-1);a.unshift(...t)}else{let t=0;for(const s=this.slices.length;t<s;++t){const s=this.slices[t];if(e[0]>s[0])break}this.slices.splice(t,0,this.constructSlice(...e)),d=t}return t?this.flatten(d):void 0}flatten(e){if(this.slices.length>=2)for(let t=0,s=this.slices.length;t<s-1;++t){const i=this.slices[t],n=this.slices[t+1];-1!==i.indexOf(n[0])&&(i.setEnd(n.end),this.slices.splice(t+1,1),t<e&&--e,--s,--t,this.insertSlice(n,!1))}return this.slices[e]}get first(){return this.slices[0]}get last(){return this.slices[this.slices.length-1]}get slice(){return this.first}get length(){return this.slice.length}findSlice(e){for(let t=0,s=this.slices.length;t<s;++t){const s=this.slices[t],i=s.indexOf(e);if(-1!==i)return{slice:s,index:i}}}findSliceOffset(e){let t;for(let s=0;s<this.slices.length;++s){let i=0;if(t=this.slices[s],!(t.length<2))for(;i<t.length;i++)if(e>=t[i])return{slice:t,offset:e===t[i]?i:i-1}}if(t&&t.isEnd(i.Top))return{slice:t,offset:t.length}}sliceMe(e,t,s){let n=this.slice,a=0,r=0;if(e){const t=this.findSliceOffset(e);if(!t)return;n=t.slice,a=r=t.offset,n.includes(e)&&(r+=1)}let o=Math.max(r+t,0),d=r+t+s;const l=n.slice(o,d),c=t<0?s+t:s,h=Math.abs(t),u=n.length-r>=c||!!n.isEnd(i.Top)&&(l.setEnd(i.Top),!0),p=r-h>=0||!!n.isEnd(i.Bottom)&&(l.setEnd(i.Bottom),!0);return{slice:l,offsetIdOffset:a,fulfilled:i.None|(u&&p?i.Both:(u?i.Top:i.None)|(p?i.Bottom:i.None))}}unshift(...e){let t=this.first;t.length?t.isEnd(i.Bottom)||(t=this.constructSlice(),t.setEnd(i.Bottom),this.slices.unshift(t)):t.setEnd(i.Bottom),t.unshift(...e)}push(...e){let t=this.last;t.length?t.isEnd(i.Top)||(t=this.constructSlice(),t.setEnd(i.Top),this.slices.push(t)):t.setEnd(i.Top),t.push(...e)}delete(e){const t=this.findSlice(e);return!!t&&(t.slice.splice(t.index,1),!0)}}n.GO&&(n.GO.SlicedArray=a)},4847:(e,t,s)=>{function i(e){const t=e.replace("input","");return t[0].toLowerCase()+t.slice(1)}s.d(t,{Z:()=>i})},3738:(e,t,s)=>{function i(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}s.d(t,{Z:()=>i})},8456:(e,t,s)=>{function i(e,t,s=t+10){return(e=e.trim()).length>s&&(e=e.slice(0,t)+"..."),e}s.d(t,{Z:()=>i})},241:(e,t,s)=>{s.d(t,{Z:()=>i});const i=new class{constructor(){this.width=0,this.height=0;const e="visualViewport"in window?window.visualViewport:window,t=()=>{this.width=e.width||e.innerWidth,this.height=e.height||e.innerHeight};e.addEventListener("resize",t),t()}}},5185:(e,t,s)=>{s.d(t,{Z:()=>v});var i=s(410),n=s(5003),a=s(9518),r=s(3512),o=s(5555),d=s(8138),l=s(6440),c=s(4687),h=s(8045),u=s(8938),p=s(319),g=s(8598),f=s(4159);const m=new class{constructor(){this.updatesState={pendingPtsUpdates:[],pendingSeqUpdates:{},syncPending:null,syncLoading:null},this.channelStates={},this.attached=!1,this.log=(0,n.kg)("UPDATES",n.v9.Error|n.v9.Warn|n.v9.Log),this.debug=i.ZP,this.processUpdateMessage=(e,t={})=>{const s={date:e.date,seq:e.seq,seqStart:e.seq_start};switch(this.debug&&this.log.debug("processUpdateMessage",e),e._){case"updatesTooLong":case"new_session_created":this.forceGetDifference();break;case"updateShort":this.processUpdate(e.update,s);break;case"updateShortMessage":case"updateShortChatMessage":{(0,u.Z)(e),this.debug&&this.log.debug("updateShortMessage | updateShortChatMessage",Object.assign({},e));const t=e.pFlags.out,i=e.from_id||(t?r.default.myId:e.user_id),n=e.chat_id?e.chat_id.toPeerId(!0):e.user_id.toPeerId(!1)||r.default.myId;this.processUpdate({_:"updateNewMessage",message:{_:"message",pFlags:e.pFlags,id:e.id,from_id:l.Z.getOutputPeer(i.toPeerId()),peer_id:l.Z.getOutputPeer(n),date:e.date,message:e.message,fwd_from:e.fwd_from,reply_to:e.reply_to,entities:e.entities},pts:e.pts,pts_count:e.pts_count},s);break}case"updatesCombined":case"updates":o.Z.saveApiUsers(e.users,t.override),d.Z.saveApiChats(e.chats,t.override),e.updates.forEach((e=>{this.processUpdate(e,s)}));break;default:this.log.warn("Unknown update message",e)}}}setProxy(){const e=this;this.updatesState=new Proxy(this.updatesState,{set:function(t,s,i){return t[s]=i,e.saveUpdatesState(),!0}})}saveUpdatesState(){const e=this.updatesState;c.default.pushToState("updates",{seq:e.seq,pts:e.pts,date:e.date})}popPendingSeqUpdate(){const e=this.updatesState,t=e.seq+1,s=e.pendingSeqUpdates[t];if(!s)return!1;const i=s.updates;for(let e=0,t=i.length;e<t;++e)this.saveUpdate(i[e]);return e.seq=s.seq,s.date&&e.date<s.date&&(e.date=s.date),delete e.pendingSeqUpdates[t],!this.popPendingSeqUpdate()&&e.syncPending&&e.syncPending.seqAwaiting&&e.seq>=e.syncPending.seqAwaiting&&(e.syncPending.ptsAwaiting?delete e.syncPending.seqAwaiting:(clearTimeout(e.syncPending.timeout),e.syncPending=null)),!0}popPendingPtsUpdate(e){const t=e?this.getChannelState(e):this.updatesState;if(!t.pendingPtsUpdates.length)return!1;t.pendingPtsUpdates.sort(((e,t)=>e.pts-t.pts));let s=t.pts,i=0,n=0;for(let e=0,a=t.pendingPtsUpdates.length;e<a;++e){const a=t.pendingPtsUpdates[e];s+=a.pts_count,s>=a.pts&&(i=a.pts,n=e)}if(!i)return!1;this.debug&&this.log.debug("pop pending pts updates",i,t.pendingPtsUpdates.slice(0,n+1)),t.pts=i;for(let e=0;e<=n;++e){const s=t.pendingPtsUpdates[e];this.saveUpdate(s)}return t.pendingPtsUpdates.splice(0,n+1),!t.pendingPtsUpdates.length&&t.syncPending&&(t.syncPending.seqAwaiting?delete t.syncPending.ptsAwaiting:(clearTimeout(t.syncPending.timeout),t.syncPending=null)),!0}forceGetDifference(){this.updatesState.syncLoading||this.getDifference()}processLocalUpdate(e){this.processUpdateMessage({_:"updateShort",update:e})}getDifference(e=!1){const t=this.updatesState;let s=t.syncLoading;s||(t.pendingSeqUpdates={},t.pendingPtsUpdates=[]),t.syncPending&&(clearTimeout(t.syncPending.timeout),t.syncPending=null);const i=a.Z.invokeApi("updates.getDifference",{pts:t.pts,pts_total_limit:e?1200:void 0,date:t.date,qts:-1},{timeout:2147483647}).then((s=>{if(this.debug&&this.log.debug("Get diff result",s),"updates.differenceEmpty"===s._)return this.debug&&this.log.debug("apply empty diff",s.seq),t.date=s.date,void(t.seq=s.seq);if(e&&r.default.dispatchEvent("state_synchronizing"),"updates.differenceTooLong"!==s._){o.Z.saveApiUsers(s.users),d.Z.saveApiChats(s.chats),s.other_updates.forEach((e=>{switch(e._){case"updateChannelTooLong":case"updateNewChannelMessage":case"updateEditChannelMessage":return void this.processUpdate(e)}this.saveUpdate(e)})),s.new_messages.forEach((e=>{this.saveUpdate({_:"updateNewMessage",message:e,pts:t.pts,pts_count:0})}));const e="updates.difference"===s._?s.state:s.intermediate_state;t.seq=e.seq,t.pts=e.pts,t.date=e.date}else t.pts=s.pts,t.date=(Date.now()/1e3|0)+h.Z.serverTimeOffset,delete t.seq,this.channelStates={},this.log.warn("getDifference:",s._),r.default.dispatchEvent("state_cleared");if("updates.differenceSlice"===s._)return this.getDifference();this.debug&&this.log.debug("finished get diff")}));return s||this.justAName(t,i),i}getChannelDifference(e){const t=this.getChannelState(e),s=t.syncLoading;s||(t.pendingPtsUpdates=[]),t.syncPending&&(clearTimeout(t.syncPending.timeout),t.syncPending=null);const i=a.Z.invokeApi("updates.getChannelDifference",{channel:d.Z.getChannelInput(e),filter:{_:"channelMessagesFilterEmpty"},pts:t.pts,limit:30},{timeout:2147483647}).then((s=>{if(this.debug&&this.log.debug("Get channel diff result",s),t.pts="pts"in s?s.pts:void 0,"updates.channelDifferenceEmpty"!==s._){if("updates.channelDifferenceTooLong"===s._)return this.debug&&this.log.debug("channel diff too long",s),delete this.channelStates[e],void this.saveUpdate({_:"updateChannelReload",channel_id:e});if(o.Z.saveApiUsers(s.users),d.Z.saveApiChats(s.chats),this.debug&&this.log.debug("applying",s.other_updates.length,"channel other updates"),s.other_updates.forEach((e=>{this.saveUpdate(e)})),this.debug&&this.log.debug("applying",s.new_messages.length,"channel new messages"),s.new_messages.forEach((e=>{this.saveUpdate({_:"updateNewChannelMessage",message:e,pts:t.pts,pts_count:0})})),this.debug&&this.log.debug("apply channel diff",t.pts),"updates.channelDifference"===s._&&!s.pFlags.final)return this.getChannelDifference(e);this.debug&&this.log.debug("finished channel get diff")}else this.debug&&this.log.debug("apply channel empty diff",s)}));return s||this.justAName(t,i,e),i}justAName(e,t,s){e.syncLoading=t,r.default.dispatchEvent("state_synchronizing",s),t.then((()=>{e.syncLoading=null,r.default.dispatchEvent("state_synchronized",s)}),(()=>{e.syncLoading=null}))}addChannelState(e,t){if(!t)throw new Error("Add channel state without pts "+e);return!(e in this.channelStates)&&(this.channelStates[e]={pts:t,pendingPtsUpdates:[],syncPending:null,syncLoading:null},!0)}getChannelState(e,t){return void 0===this.channelStates[e]&&this.addChannelState(e,t),this.channelStates[e]}processUpdate(e,t={}){var s;let i;switch(e._){case"updateNewChannelMessage":case"updateEditChannelMessage":i=l.Z.getPeerId(e.message.peer_id).toChatId();break;case"updateChannelTooLong":if(i=e.channel_id,!(i in this.channelStates))return!1;break;default:"channel_id"in e&&"pts"in e&&(i=e.channel_id)}const{pts:n,pts_count:a}=e,r=i?this.getChannelState(i,n):this.updatesState;if(r.syncLoading)return!1;if("updateChannelTooLong"===e._)return(!r.lastPtsUpdateTime||r.lastPtsUpdateTime<Date.now()-6)&&this.getChannelDifference(i),!1;if("updateNewMessage"===e._||"updateEditMessage"===e._||"updateNewChannelMessage"===e._||"updateEditChannelMessage"===e._){const t=e.message,n=l.Z.getPeerId(t.peer_id),a=t.fwd_from||{};let r;if(t.from_id&&!o.Z.hasUser(l.Z.getPeerId(t.from_id),t.pFlags.post)&&(r="author")||a.from_id&&!o.Z.hasUser(l.Z.getPeerId(a.from_id),!!a.from_id.channel_id)&&(r="fwdAuthor")||(null===(s=a.from_id)||void 0===s?void 0:s.channel_id)&&!d.Z.hasChat(a.from_id.channel_id,!0)&&(r="fwdChannel")||n.isUser()&&!o.Z.hasUser(n)&&(r="toPeer User")||n.isAnyChat()&&!d.Z.hasChat(n.toChatId())&&(r="toPeer Chat"))return this.log.warn("Not enough data for message update",n,r,t),i&&d.Z.hasChat(i)?this.getChannelDifference(i):this.forceGetDifference(),!1}else if(i&&!d.Z.hasChat(i))return!1;let c,h;if(n){if(r.pts+(a||0)<n)return this.debug&&this.log.warn("Pts hole",r,e,i&&d.Z.getChat(i)),r.pendingPtsUpdates.push(e),r.syncPending||r.syncLoading||(r.syncPending={timeout:window.setTimeout((()=>{r.syncPending=null,r.syncLoading||(i?this.getChannelDifference(i):this.getDifference())}),6)}),r.syncPending.ptsAwaiting=!0,!1;if(n>r.pts)r.pts=n,c=!0,r.lastPtsUpdateTime=Date.now();else if(a)return!1;i&&t.date&&this.updatesState.date<t.date&&(this.updatesState.date=t.date)}else if(!i&&t.seq>0){const s=t.seq,i=t.seqStart||s;if(i!==r.seq+1&&i>r.seq)return this.debug&&this.log.warn("Seq hole",r,r.syncPending&&r.syncPending.seqAwaiting),void 0===r.pendingSeqUpdates[i]&&(r.pendingSeqUpdates[i]={seq:s,date:t.date,updates:[]}),r.pendingSeqUpdates[i].updates.push(e),r.syncPending||(r.syncPending={timeout:window.setTimeout((()=>{r.syncPending=null,r.syncLoading||this.getDifference()}),6)}),(!r.syncPending.seqAwaiting||r.syncPending.seqAwaiting<i)&&(r.syncPending.seqAwaiting=i),!1;r.seq!==s&&(r.seq=s,t.date&&r.date<t.date&&(r.date=t.date),h=!0)}this.saveUpdate(e),c?this.popPendingPtsUpdate(i):h&&this.popPendingSeqUpdate()}saveUpdate(e){r.default.dispatchEvent(e._,e)}attach(){this.attached||(this.log("attach"),this.attached=!0,c.default.getState().then((({updates:e})=>{const t=c.default.newVersion;e&&e.pts&&e.date?(Object.assign(this.updatesState,e),this.log("will get difference",Object.assign({},e)),this.getDifference(!0)):(this.log("will get new state"),this.updatesState.syncLoading=new Promise((e=>{a.Z.invokeApi("updates.getState",{},{noErrorBox:!0}).then((t=>{this.updatesState.seq=t.seq,this.updatesState.pts=t.pts,this.updatesState.date=t.date,this.saveUpdatesState(),this.updatesState.syncLoading=null,e()}))}))),a.Z.setUpdatesProcessor(this.processUpdateMessage),this.setProxy(),t&&this.updatesState.syncLoading.then((()=>{fetch("changelogs/"+t.split(" ")[0]+".md").then((e=>200===e.status&&e.ok&&e.text()||Promise.reject())).then((e=>{e=`**Telegram Web${f.Z.suffix} was updated to version ${t}**\n\n`+e;const s=[],i={_:"updateServiceNotification",entities:s,message:g.Z.parseMarkdown(e,s),type:"local",pFlags:{},inbox_date:Date.now()/1e3|0,media:void 0};this.processLocalUpdate(i)})).catch(p.Z)}))})))}};i.GO.apiUpdatesManager=m;const v=m},9256:(e,t,s)=>{s.d(t,{Z:()=>p});var i=s(6740),n=s(5565),a=s(9674),r=s(1507),o=s(8598),d=s(3512),l=s(7309),c=s(6440),h=s(3714),u=s(5555);const p=new class{constructor(){this.savedAvatarURLs={}}isAvatarCached(e){return!!this.savedAvatarURLs[e]}removeFromAvatarsCache(e){this.savedAvatarURLs[e]&&delete this.savedAvatarURLs[e]}loadAvatar(e,t,s){const i=c.Z.getInputPeerById(e);let n,a=!1,r=this.savedAvatarURLs[e];if(r&&r[s])"string"!=typeof r[s]?n=r[s]:(n=Promise.resolve(r[s]),a=!0);else{r||(r=this.savedAvatarURLs[e]={});const a={_:"inputPeerPhotoFileLocation",pFlags:{},peer:i,photo_id:t.photo_id};"photo_big"===s&&(a.pFlags.big=!0);const o={dcId:t.dc_id,location:a},d=l.Z.download(o);n=r[s]=d.then((e=>r[s]=URL.createObjectURL(e)))}return{cached:a,loadPromise:n}}putAvatar(e,t,s,r,o=new Image,l=!1){let c,u,p,{cached:g,loadPromise:f}=this.loadAvatar(t,s,r);if(o.classList.add("avatar-photo"),g)u=()=>{(0,n.Z)(e,o),e.dataset.color=""};else{const l=d.default.settings.animationsEnabled;if(l&&o.classList.add("fade-in"),"photo_big"===r){const i=this.putAvatar(e,t,s,"photo_small");c=i.loadPromise,p=i.thumbImage}else if(s.stripped_thumb){p=new Image,e.classList.add("avatar-relative"),p.classList.add("avatar-photo","avatar-photo-thumbnail");const t=h.Z.getPreviewURLFromBytes(s.stripped_thumb);c=(0,i.cj)(p,t).then((()=>{(0,n.Z)(e,p)}))}u=()=>{p?e.append(o):(0,n.Z)(e,o),setTimeout((()=>{e.childElementCount&&a.Z.mutateElement(o,(()=>{e.dataset.color="",l&&o.classList.remove("fade-in"),p&&p.remove()}))}),l?200:0)}}const m=f.then((e=>(0,i.cj)(o,e))).then(u);return{cached:g,loadPromise:c||m,thumbImage:p}}s(e,t,s,i){e.innerHTML=t,e.dataset.color=s,e.classList.remove("tgico-saved","tgico-deletedaccount","tgico-reply_filled"),i&&e.classList.add(i)}putPhoto(e,t,s=!1,i="",n=!1,a){var l;const h=d.default.myId;if(t===h&&s)return void this.s(e,"","","tgico-saved");if(t!==r.NM&&t.isUser()){const s=u.Z.getUser(t);if(s&&s.pFlags&&s.pFlags.deleted)return void this.s(e,"",c.Z.getPeerColorById(t),"tgico-deletedaccount")}const p=c.Z.getPeerPhoto(t),g=!!p,f=!!e.firstElementChild&&!e.firstElementChild.classList.contains("emoji");if(!g||!f||!this.savedAvatarURLs[t]){let n,a="";if(!t||t===h&&s||(a=c.Z.getPeerColorById(t)),t===r.hj)return void this.s(e,"",a,"tgico-reply_filled");n=i?o.Z.getAbbreviation(i):null!==(l=c.Z.getPeer(t).initials)&&void 0!==l?l:"",this.s(e,n,a,"")}if(g){const s=a?"photo_big":"photo_small";return this.putAvatar(e,t,p,s,void 0,n)}}}},8138:(e,t,s)=>{s.d(t,{Z:()=>v});var i=s(410),n=s(8479),a=s(6848),r=s(5880),o=s(3442),d=s(9518),l=s(8598),c=s(3512),h=s(5185),u=s(6440),p=s(4687),g=s(5555),f=s(677);const m=new class{constructor(){this.storage=p.default.storages.chats,this.onChatUpdated=(e,t)=>{var s;h.Z.processUpdateMessage(t),(null===(s=null==t?void 0:t.updates)||void 0===s?void 0:s.length)&&this.isChannel(e)&&c.default.dispatchEvent("invalidate_participants",e)},this.clear(!0),c.default.addMultipleEventsListeners({updateChannelParticipant:e=>{d.Z.clearCache("channels.getParticipants",(t=>t.channel.channel_id===e.channel_id))},updateChatDefaultBannedRights:e=>{const t=u.Z.getPeerId(e.peer).toChatId(),s=this.chats[t];s&&(s.default_banned_rights=e.default_banned_rights,c.default.dispatchEvent("chat_update",t))}}),p.default.getState().then((e=>{const t=p.default.storagesResults.chats;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];s&&(this.chats[s.id]=s)}p.default.addEventListener("peerNeeded",(e=>{e.isUser()||this.storage.getFromCache(e.toChatId())||this.storage.set({[e.toChatId()]:this.getChat(e.toChatId())})})),p.default.addEventListener("peerUnneeded",(e=>{!e.isUser()&&this.storage.getFromCache(e.toChatId())&&this.storage.delete(e.toChatId())}))}))}clear(e=!1){if(e)this.chats={};else{const e=p.default.storagesResults.chats;for(const t in this.chats)t&&(p.default.isPeerNeeded(t.toPeerId(!0))||(e.findAndSplice((e=>e.id===t)),this.storage.delete(t),delete this.chats[t]))}}saveApiChats(e,t){e.saved||(e.saved=!0,e.forEach((e=>this.saveApiChat(e,t))))}saveApiChat(e,t){var s,i;if("chatEmpty"===e._)return;const n=this.chats[e.id];if(void 0===e.pFlags&&(e.pFlags={}),e.pFlags.min&&void 0!==n)return;e.initials=l.o.getAbbreviation(e.title),"channel"===e._&&void 0===e.participants_count&&void 0!==n&&n.participants_count&&(e.participants_count=n.participants_count);let a=!1,r=!1;void 0===n?this.chats[e.id]=e:((null===(s=n.photo)||void 0===s?void 0:s.photo_id)!==(null===(i=e.photo)||void 0===i?void 0:i.photo_id)&&(a=!0),n.title!==e.title&&(r=!0),(0,o.Z)(n,e),c.default.dispatchEvent("chat_update",e.id));const d=e.id.toPeerId(!0);a&&c.default.dispatchEvent("avatar_update",d),r&&c.default.dispatchEvent("peer_title_edit",d),p.default.isPeerNeeded(d)&&this.storage.set({[e.id]:e})}getChat(e){return this.chats[e]||{_:"chatEmpty",id:e,deleted:!0,access_hash:"",pFlags:{}}}getChatTyped(e){return this.getChat(e)}combineParticipantBannedRights(e,t){const s=this.getChat(e);if(s.default_banned_rights){t=(0,n.Z)(t);const e=s.default_banned_rights.pFlags;for(let s in e)t.pFlags[s]=e[s]}return t}hasRights(e,t,s,i){const n=this.getChat(e);if("chatEmpty"===n._)return!1;if(n.pFlags.deactivated&&"view_messages"!==t)return!1;const a=void 0===s;if(n.pFlags.creator&&a)return!0;if("chatForbidden"===n._||"channelForbidden"===n._||n.pFlags.kicked||n.pFlags.left&&!n.pFlags.megagroup)return!1;if(!s&&!(s=n.admin_rights||n.banned_rights||n.default_banned_rights))return!1;let r={};switch(s&&(r=s.pFlags),t){case"embed_links":case"send_games":case"send_gifs":case"send_inline":case"send_media":case"send_messages":case"send_polls":case"send_stickers":if(!i&&n.pFlags.left)return!1;if("chatBannedRights"===s._&&r[t])return!1;if("channel"===n._&&!n.pFlags.megagroup&&!r.post_messages)return!1;break;case"delete_messages":case"manage_call":return!!r[t];case"pin_messages":return"chatAdminRights"===s._?r[t]||!!r.post_messages:!r[t];case"change_info":case"invite_users":return"chatAdminRights"===s._?r[t]:!r[t];case"change_type":case"delete_chat":return!1;case"ban_users":case"change_permissions":return"chatAdminRights"===s._&&!!r.ban_users;case"view_participants":return!("chat"!==n._&&n.pFlags.broadcast&&!n.pFlags.creator&&!n.admin_rights)}return!0}editChatDefaultBannedRights(e,t){const s=this.getChat(e);return s.default_banned_rights&&s.default_banned_rights.until_date===t.until_date&&(0,a.Z)(s.default_banned_rights.pFlags,t.pFlags)?Promise.resolve():d.Z.invokeApi("messages.editChatDefaultBannedRights",{peer:u.Z.getInputPeerById(e.toPeerId(!0)),banned_rights:t}).then(this.onChatUpdated.bind(this,e))}isChannel(e){const t=this.chats[e];return!(!t||"channel"!==t._&&"channelForbidden"!==t._)}isMegagroup(e){const t=this.chats[e];return!(!t||"channel"!==t._||!t.pFlags.megagroup)}isBroadcast(e){return this.isChannel(e)&&!this.isMegagroup(e)}isInChat(e){let t=!0;const s=this.getChat(e);return("channelForbidden"===s._||"chatForbidden"===s._||"chatEmpty"===s._||s.pFlags.left||s.pFlags.kicked||s.pFlags.deactivated)&&(t=!1),t}getChannelInput(e){const t=this.getChat(e);return"chatEmpty"!==t._&&t.access_hash?{_:"inputChannel",channel_id:e,access_hash:t.access_hash||"0"}:{_:"inputChannelEmpty"}}getInputPeer(e){return this.isChannel(e)?this.getChannelInputPeer(e):this.getChatInputPeer(e)}getChatInputPeer(e){return{_:"inputPeerChat",chat_id:e}}getChannelInputPeer(e){return{_:"inputPeerChannel",channel_id:e,access_hash:this.getChat(e).access_hash||0}}hasChat(e,t){const s=this.chats[e];return(0,r.Z)(s)&&(t||!s.pFlags.min)}getChatPhoto(e){const t=this.getChat(e);return t&&t.photo||{_:"chatPhotoEmpty"}}getChatString(e){const t=this.getChat(e);return this.isChannel(e)?(this.isMegagroup(e)?"s":"c")+e+"_"+t.access_hash:"g"+e}createChannel(e){return d.Z.invokeApi("channels.createChannel",e).then((e=>{h.Z.processUpdateMessage(e);const t=e.chats[0].id;return c.default.dispatchEvent("history_focus",{peerId:t.toPeerId(!0)}),t}))}inviteToChannel(e,t){const s=this.getChannelInput(e),i=t.map((e=>g.Z.getUserInput(e)));return d.Z.invokeApi("channels.inviteToChannel",{channel:s,users:i}).then(this.onChatUpdated.bind(this,e))}createChat(e,t){return d.Z.invokeApi("messages.createChat",{users:t.map((e=>g.Z.getUserInput(e))),title:e}).then((e=>{h.Z.processUpdateMessage(e);const t=e.chats[0].id;return c.default.dispatchEvent("history_focus",{peerId:t.toPeerId(!0)}),t}))}leaveChannel(e){return d.Z.invokeApi("channels.leaveChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}joinChannel(e){return d.Z.invokeApi("channels.joinChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}addChatUser(e,t,s=100){return d.Z.invokeApi("messages.addChatUser",{chat_id:e,user_id:g.Z.getUserInput(t),fwd_limit:s}).then(this.onChatUpdated.bind(this,e))}deleteChatUser(e,t){return d.Z.invokeApi("messages.deleteChatUser",{chat_id:e,user_id:g.Z.getUserInput(t)}).then(this.onChatUpdated.bind(this,e))}leaveChat(e){return this.deleteChatUser(e,g.Z.getSelf().id)}leave(e){return this.isChannel(e)?this.leaveChannel(e):this.leaveChat(e)}delete(e){return this.isChannel(e)?this.deleteChannel(e):this.deleteChat(e)}deleteChannel(e){return d.Z.invokeApi("channels.deleteChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}deleteChat(e){return d.Z.invokeApi("messages.deleteChat",{chat_id:e})}migrateChat(e){const t=this.getChat(e);return"channel"===t._?Promise.resolve(t.id):d.Z.invokeApi("messages.migrateChat",{chat_id:e}).then((t=>(this.onChatUpdated(e,t),t.updates.find((e=>"updateChannel"===e._)).channel_id)))}updateUsername(e,t){return d.Z.invokeApi("channels.updateUsername",{channel:this.getChannelInput(e),username:t}).then((s=>(s&&(this.getChat(e).username=t),s)))}editPhoto(e,t){const s={_:"inputChatUploadedPhoto",file:t};let i;return i=this.isChannel(e)?d.Z.invokeApi("channels.editPhoto",{channel:this.getChannelInput(e),photo:s}):d.Z.invokeApi("messages.editChatPhoto",{chat_id:e,photo:s}),i.then((e=>{h.Z.processUpdateMessage(e)}))}editTitle(e,t){let s;return s=this.isChannel(e)?d.Z.invokeApi("channels.editTitle",{channel:this.getChannelInput(e),title:t}):d.Z.invokeApi("messages.editChatTitle",{chat_id:e,title:t}),s.then((e=>{h.Z.processUpdateMessage(e)}))}editAbout(e,t){const s=e.toPeerId(!0);return d.Z.invokeApi("messages.editChatAbout",{peer:u.Z.getInputPeerById(s),about:t}).then((e=>(e&&c.default.dispatchEvent("peer_bio_edit",s),e)))}getParticipantPeerId(e){return e.peer?u.Z.getPeerId(e.peer):e.user_id.toPeerId()}editBanned(e,t,s){const i="object"!=typeof t?t:this.getParticipantPeerId(t);return d.Z.invokeApi("channels.editBanned",{channel:this.getChannelInput(e),participant:u.Z.getInputPeerById(i),banned_rights:s}).then((n=>{if(this.onChatUpdated(e,n),"object"==typeof t){const n=Date.now()/1e3|0;h.Z.processLocalUpdate({_:"updateChannelParticipant",channel_id:e,date:n,actor_id:void 0,qts:void 0,user_id:i,prev_participant:t,new_participant:Object.keys(s.pFlags).length?{_:"channelParticipantBanned",date:n,banned_rights:s,kicked_by:g.Z.getSelf().id,peer:u.Z.getOutputPeer(i),pFlags:{}}:void 0})}}))}clearChannelParticipantBannedRights(e,t){return this.editBanned(e,t,{_:"chatBannedRights",until_date:0,pFlags:{}})}kickFromChannel(e,t){return this.editBanned(e,t,{_:"chatBannedRights",until_date:0,pFlags:{view_messages:!0}})}kickFromChat(e,t){return this.isChannel(e)?this.kickFromChannel(e,t):this.deleteChatUser(e,t.toUserId())}resolveChannel(e){return d.Z.invokeApiSingle("channels.getChannels",{id:[{_:"inputChannel",channel_id:e,access_hash:"0"}]}).then((e=>{this.saveApiChats(e.chats)}))}togglePreHistoryHidden(e,t){return this.migrateChat(e).then((e=>d.Z.invokeApi("channels.togglePreHistoryHidden",{channel:this.getChannelInput(e),enabled:t}))).then((e=>{h.Z.processUpdateMessage(e)}))}toggleSignatures(e,t){return d.Z.invokeApi("channels.toggleSignatures",{channel:this.getChannelInput(e),enabled:t}).then((e=>{h.Z.processUpdateMessage(e)}))}toggleNoForwards(e,t){return d.Z.invokeApi("messages.toggleNoForwards",{peer:this.getInputPeer(e),enabled:t}).then((e=>{h.Z.processUpdateMessage(e)}))}setChatAvailableReactions(e,t){return d.Z.invokeApi("messages.setChatAvailableReactions",{peer:this.getInputPeer(e),available_reactions:t}).then((e=>{h.Z.processUpdateMessage(e)}))}isRestricted(e){const t=this.getChat(e),s=t.restriction_reason;return!!(t.pFlags.restricted&&s&&(0,f.X)(s))}getSendAs(e){return d.Z.invokeApiSingleProcess({method:"channels.getSendAs",params:{peer:this.getChannelInputPeer(e)},processResult:e=>(g.Z.saveApiUsers(e.users),m.saveApiChats(e.chats),e.peers)})}};i.GO.appChatsManager=m;const v=m},1592:(e,t,s)=>{s.d(t,{Z:()=>P});var i=s(8801),n=s(2003),a=s(9043),r=s(8598),o=s(7309),d=s(3714),l=s(6705),c=s(9518),h=s(410),u=s(632),p=s(3512),g=s(5269),f=s(393),m=s(8027),v=s(5880),_=s(4463);const y={mov:"video/quicktime",gif:"image/gif",pdf:"application/pdf"},I=new class{constructor(){this.docs={},this.savingLottiePreview={},this.downloading=new Map,this.onServiceWorkerFail=()=>{for(const e in this.docs){const t=this.docs[e];t.supportsStreaming&&(delete t.supportsStreaming,delete o.Z.getCacheContext(t).url)}},c.Z.onServiceWorkerFail=this.onServiceWorkerFail}saveDoc(e,t){if("documentEmpty"===e._)return;const s=this.docs[e.id];e.file_reference&&((0,_.Z)("file_reference",s,e),n.Z.saveContext(e.file_reference,t)),s||(this.docs[e.id]=e);for(let t=0,s=e.attributes.length;t<s;++t){const s=e.attributes[t];switch(s._){case"documentAttributeFilename":e.file_name=r.o.wrapPlainText(s.file_name),e.fileName=r.o.wrapEmojiText(s.file_name);break;case"documentAttributeAudio":e.duration=s.duration,e.audioTitle=r.o.wrapEmojiText(s.title),e.audioPerformer=r.o.wrapEmojiText(s.performer),e.type=s.pFlags.voice&&"audio/ogg"===e.mime_type?"voice":"audio";break;case"documentAttributeVideo":e.duration=s.duration,e.w=s.w,e.h=s.h,s.pFlags.round_message?e.type="round":e.type="video";break;case"documentAttributeSticker":if(void 0!==s.alt&&(e.stickerEmojiRaw=s.alt,e.stickerEmoji=r.o.wrapRichText(e.stickerEmojiRaw,{noLinks:!0,noLinebreaks:!0})),s.stickerset&&("inputStickerSetEmpty"===s.stickerset._?delete s.stickerset:"inputStickerSetID"===s.stickerset._&&(e.stickerSetInput=s.stickerset)),"image/webp"===e.mime_type&&(e.thumbs||g.Z))e.type="sticker",e.sticker=1;else if("video/webm"===e.mime_type){if(!f.Z)return;e.type="sticker",e.sticker=3,e.animated=!0}break;case"documentAttributeImageSize":e.type="photo",e.w=s.w,e.h=s.h;break;case"documentAttributeAnimated":"image/gif"!==e.mime_type&&"video/mp4"!==e.mime_type||(e.type="gif"),e.animated=!0}}if(e.mime_type)e.mime_type===y.pdf?e.type="pdf":e.mime_type===y.gif&&(e.type="gif");else{const t=(e.file_name||"").split(".").pop(),s=t&&y[t.toLowerCase()];if(s)e.mime_type=s;else switch(e.type){case"gif":case"video":case"round":e.mime_type="video/mp4";break;case"sticker":e.mime_type="image/webp";break;case"audio":e.mime_type="audio/mpeg";break;case"voice":e.mime_type="audio/ogg";break;default:e.mime_type="application/octet-stream"}}if("voice"!==e.type&&"round"!==e.type||(e.file_name=e.fileName=e.type+"_"+(0,u.xE)(new Date(1e3*e.date),{monthAsNumber:!0,leadingZero:!0}).replace(/[:\.]/g,"-").replace(", ","_")),c.Z.isServiceWorkerOnline()&&("gif"===e.type&&e.size>8e6||"audio"===e.type||"video"===e.type)){e.supportsStreaming=!0;const t=o.Z.getCacheContext(e);t.url||(t.url=this.getFileURL(e))}return e.file_name||(e.file_name=e.fileName=""),"application/x-tgsticker"===e.mime_type&&"AnimatedSticker.tgs"===e.file_name&&(e.type="sticker",e.animated=!0,e.sticker=2),s?Object.assign(s,e):e}getDoc(e){return(0,v.Z)(e)?e:this.docs[e]}getMediaInput(e){return{_:"inputMediaDocument",id:{_:"inputDocument",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference},ttl_seconds:0}}getInput(e,t){return{_:"inputDocumentFileLocation",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference,thumb_size:t}}getFileDownloadOptions(e,t,s,i){const n=this.getInput(e,null==t?void 0:t.type);let a;return a=t?e.sticker?"image/webp":"image/jpeg":e.mime_type||"application/octet-stream",{dcId:e.dc_id,location:n,size:t?t.size:e.size,mimeType:a,fileName:e.file_name,queueId:s,onlyCache:i}}getFileURL(e,t=!1,s){let n;return n=t?"download":s?"thumb":e.supportsStreaming?"stream":"document",(0,i.q)(n,this.getFileDownloadOptions(e,s))}getThumbURL(e,t){let s=Promise.resolve();const i=o.Z.getCacheContext(e,t.type);return i.url||(s="bytes"in t?(0,l.Z)(d.Z.getPreviewURLFromBytes(t.bytes,!!e.sticker)).then((e=>{i.url=e})):d.Z.preloadPhoto(e,t)),{thumb:t,cacheContext:i,promise:s}}getThumb(e,t=!0){const s=d.Z.choosePhotoSize(e,0,0,!t);return"photoSizeEmpty"===s._?null:this.getThumbURL(e,s)}getInputFileName(e,t){return(0,i.P)(this.getInput(e,t),{fileName:e.file_name})}downloadDoc(e,t,s){const i=this.getInputFileName(e);let n=o.Z.getDownload(i);if(n)return n;const r=this.getFileDownloadOptions(e,void 0,t,s);n=o.Z.download(r),this.downloading.set(e.id,n),p.default.dispatchEvent("download_start",e.id);const d=o.Z.getCacheContext(e),l=n;return l.then((e=>{d.url=URL.createObjectURL(e),d.downloaded=e.size}),(()=>{})).finally((()=>{this.downloading.delete(e.id)})),"voice"!==e.type||a.Z.isPlaySupported()||(n=l.then((e=>{return t=this,s=void 0,n=function*(){const t=new FileReader;return yield new Promise(((s,i)=>{t.onloadend=e=>{const t=new Uint8Array(e.target.result);a.Z.decode(t).then((e=>{d.url=e.url,s()}),(e=>{delete d.downloaded,i(e)}))},t.readAsArrayBuffer(e)})),e},new((i=void 0)||(i=Promise))((function(e,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(r,o)}d((n=n.apply(t,s||[])).next())}));var t,s,i,n}))),n.then((()=>{p.default.dispatchEvent("document_downloaded",e)})),n}isSavingLottiePreview(e,t){const s=e.id+"-"+t;return!!this.savingLottiePreview[s]}saveLottiePreview(e,t,s){const i=e.id+"-"+s;if(this.savingLottiePreview[i])return;e.stickerCachedThumbs||((0,m.Z)(e,["stickerCachedThumbs"]),e.stickerCachedThumbs={});const n=e.stickerCachedThumbs[s];n&&n.w>=t.width&&n.h>=t.height||(this.savingLottiePreview[i]=!0,t.toBlob((n=>{const a={url:URL.createObjectURL(n),w:t.width,h:t.height};e.stickerCachedThumbs[s]=a,delete this.savingLottiePreview[i]})))}saveDocFile(e,t){const s=this.downloadDoc(e,t);return s.then((()=>{const t=o.Z.getCacheContext(e);o.Z.createDownloadAnchor(t.url,e.file_name)})),s}};h.GO.appDocsManager=I;const P=I},5667:(e,t,s)=>{s.d(t,{Z:()=>_});var i=s(3512),n=s(6440),a=s(7223),r=s(5185),o=s(8598),d=s(8045),l=s(9518),c=s(632),h=s(410),u=s(7922),p=s(9492),g=s(8938),f=s(5880),m=s(6848);const v=new class{constructor(){this.drafts={},this.getAllDraftPromise=null,u.Z.get("drafts").then((e=>{this.drafts=e||{}})),i.default.addMultipleEventsListeners({updateDraftMessage:e=>{const t=n.Z.getPeerId(e.peer);this.saveDraft(t,e.threadId,e.draft,{notify:!0})}})}getKey(e,t){return e+(t?"_"+t:"")}getDraft(e,t){return this.drafts[this.getKey(e,t)]}addMissedDialogs(){return this.getAllDrafts().then((()=>{for(const e in this.drafts){if(-1!==e.indexOf("_"))continue;const t=e.toPeerId();a.Z.getDialogOnly(t)||a.Z.reloadConversation(t)}}))}getAllDrafts(){return this.getAllDraftPromise||(this.getAllDraftPromise=l.Z.invokeApi("messages.getAllDrafts").then((e=>{(r.Z.updatesState.syncLoading||Promise.resolve()).then((()=>{r.Z.processUpdateMessage(e)}))})))}saveDraft(e,t,s,n={}){const a=this.processApiDraft(s),r=this.getKey(e,t);return a?this.drafts[r]=a:delete this.drafts[r],u.Z.set({drafts:this.drafts}),n.notify&&i.default.dispatchEvent("draft_updated",{peerId:e,threadId:t,draft:a,force:n.force}),a}draftsAreEqual(e,t){if(typeof e!=typeof t)return!1;if(!(0,f.Z)(e))return!0;if(e._!==t._)return!1;if("draftMessage"===e._&&t._===e._){if(e.reply_to_msg_id!==t.reply_to_msg_id)return!1;if(!(0,m.Z)(e.entities,t.entities))return!1;if(e.message!==t.message)return!1;if(e.pFlags.no_webpage!==t.pFlags.no_webpage)return!1}return!0}isEmptyDraft(e){return!e||"draftMessageEmpty"===e._||!(e.reply_to_msg_id>0)&&!e.message.length}processApiDraft(e){if(!e||"draftMessage"!==e._)return;const t=o.Z.parseEntities(e.message),s=e.entities||[],i=o.Z.mergeEntities(s.slice(),t);return e.rMessage=o.Z.wrapDraftText(e.message,{entities:i}),e.reply_to_msg_id&&(e.reply_to_msg_id=p.Z.generateMessageId(e.reply_to_msg_id)),e}syncDraft(e,t,s,i=!0,r=!1){return o=this,h=void 0,f=function*(){const o=this.getDraft(e,t);if(this.draftsAreEqual(o,s))return!0;let h,u={peer:n.Z.getInputPeerById(e),message:""};if(this.isEmptyDraft(s))h={_:"draftMessageEmpty"};else{(0,g.Z)(s);let e=s.message,t=s.entities;s.reply_to_msg_id&&(u.reply_to_msg_id=p.Z.getServerMessageId(s.reply_to_msg_id)),(null==t?void 0:t.length)&&(u.entities=a.Z.getInputEntities(t)),s.pFlags.no_webpage&&(u.no_webpage=s.pFlags.no_webpage),u.message=e}const f=h||s;return f.date=(0,c.bz)(!0)+d.Z.serverTimeOffset,this.saveDraft(e,t,f,{notify:!0,force:r}),!(i&&!t)||l.Z.invokeApi("messages.saveDraft",u)},new((u=void 0)||(u=Promise))((function(e,t){function s(e){try{n(f.next(e))}catch(e){t(e)}}function i(e){try{n(f.throw(e))}catch(e){t(e)}}function n(t){var n;t.done?e(t.value):(n=t.value,n instanceof u?n:new u((function(e){e(n)}))).then(s,i)}n((f=f.apply(o,h||[])).next())}));var o,h,u,f}clearAllDrafts(){return l.Z.invokeApi("messages.clearAllDrafts").then((e=>{if(e)for(const e in this.drafts){const[t,s]=e.split("_");i.default.dispatchEvent("draft_updated",{peerId:t.toPeerId(),threadId:s?+s:void 0,draft:void 0})}}))}clearDraft(e,t){const s={_:"draftMessageEmpty"};t?this.syncDraft(e,t,s,!1,!0):this.saveDraft(e,t,s,{notify:!0,force:!0})}setDraft(e,t,s,i){const n={_:"draftMessage",date:Date.now()/1e3|0,message:s,pFlags:{},entities:i};t?this.syncDraft(e,t,n,!1,!0):this.saveDraft(e,t,n,{notify:!0,force:!0})}};h.GO.appDraftsManager=v;const _=v},2459:(e,t,s)=>{s.d(t,{Z:()=>Z});var i=s(410),n=s(5916),a=s(3442),r=s(144),o=s(7298),d=s(9078),l=s(2207),c=s(1677),h=s(4081),u=s(9125),p=s(5424),g=s(312),f=s(6752),m=s(5003),v=s(9518),_=s(1507),y=s(3512),I=s(5185),P=s(8138),S=s(6440),M=s(5555),w=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};const C=new class{constructor(){this.makeSsrcsFromParticipant=e=>{var t,s;return[this.makeSsrcFromParticipant(e,"audio",e.source),(null===(t=e.video)||void 0===t?void 0:t.audio_source)&&this.makeSsrcFromParticipant(e,"audio",e.video.audio_source),e.video&&this.makeSsrcFromParticipant(e,"video",e.video.source_groups,e.video.endpoint),(null===(s=e.presentation)||void 0===s?void 0:s.audio_source)&&this.makeSsrcFromParticipant(e,"audio",e.presentation.audio_source),e.presentation&&this.makeSsrcFromParticipant(e,"video",e.presentation.source_groups,e.presentation.endpoint)].filter(Boolean)},this.log=(0,m.kg)("GROUP-CALLS"),this.groupCalls=new Map,this.participants=new Map,this.nextOffsets=new Map,y.default.addMultipleEventsListeners({updateGroupCall:e=>{this.saveGroupCall(e.call,e.chat_id)},updateGroupCallParticipants:e=>{this.saveGroupCall(e.call);const t=e.call.id;this.saveApiParticipants(t,e.participants)}}),y.default.addEventListener("group_call_update",(e=>{if("groupCallDiscarded"===e._){const{currentGroupCall:t}=this;(null==t?void 0:t.id)===e.id&&t.hangUp(!1,!1,!0),this.participants.delete(e.id)}})),this.audioAsset=new n.Z(["group_call_connect.mp3","group_call_end.mp3","group_call_start.mp3","voip_onallowtalk.mp3"])}get groupCall(){return this.currentGroupCall}getCachedParticipants(e){let t=this.participants.get(e);return t||this.participants.set(e,t=new Map),t}prepareToSavingNextOffset(e){const t=this.nextOffsets,s=t.get(e);return{nextOffset:s,setNextOffset:i=>{t.get(e)===s&&t.set(e,i)}}}saveApiParticipant(e,t,s){const{currentGroupCall:i}=this,n=this.getCachedParticipants(e),r=S.Z.getPeerId(t.peer),o=n.get(r),d=t.pFlags.left;if(!o&&d)return;t.pFlags.muted||t.pFlags.can_self_unmute||(t.pFlags.can_self_unmute=!0);const l=(null==i?void 0:i.id)===e;o?((0,a.Z)(o,t),t=o):n.set(r,t),l&&i.onParticipantUpdate(t,this.doNotDispatchParticipantUpdate);const c=this.getGroupCall(e);if("groupCall"===(null==c?void 0:c._)){let e=!1;d?(--c.participants_count,e=!0):!t.pFlags.just_joined||o||t.pFlags.self||(++c.participants_count,e=!0),e&&y.default.dispatchEvent("group_call_update",c)}d&&n.delete(r),o&&this.doNotDispatchParticipantUpdate!==r&&y.default.dispatchEvent("group_call_participant",{groupCallId:e,participant:t})}saveApiParticipants(e,t,s){t.saved||(t.saved=!0,t.forEach((t=>this.saveApiParticipant(e,t,s))))}editParticipant(e,t,s){return w(this,void 0,void 0,(function*(){if(!Object.keys(s).length)return;if(t){const{currentGroupCall:i}=this,n=(null==i?void 0:i.id)===e&&t.pFlags.self;if(n&&void 0!==s.muted&&!i.isSharingAudio&&(delete s.muted,!Object.keys(s).length))return;const a=s.muted;void 0!==a&&t.pFlags.self&&(a?t.pFlags.muted=!0:t.pFlags.can_self_unmute&&delete t.pFlags.muted),void 0!==s.raiseHand&&(s.raiseHand?t.raise_hand_rating="1":delete t.raise_hand_rating),n&&(void 0!==s.videoStopped&&(s.videoStopped?delete t.video:t.video=this.generateSelfVideo(i.connections.main.sources.video)),!t.pFlags.muted&&t.pFlags.can_self_unmute&&i.setMuted(!1),i.dispatchEvent("state",i.state)),y.default.dispatchEvent("group_call_participant",{groupCallId:e,participant:t})}const i=t.pFlags.self?_.NM:S.Z.getPeerId(t.peer),n=yield v.Z.invokeApiSingle("phone.editGroupCallParticipant",{call:C.getGroupCallInput(e),participant:i===_.NM?S.Z.getInputPeerSelf():S.Z.getInputPeerById(i),muted:s.muted,volume:s.volume,raise_hand:s.raiseHand,video_paused:s.videoPaused,video_stopped:s.videoStopped,presentation_paused:s.presentationPaused});I.Z.processUpdateMessage(n)}))}getGroupCall(e){return this.groupCalls.get(e)}getGroupCallFull(e,t){return w(this,void 0,void 0,(function*(){const s=this.getGroupCall(e);if(s&&"inputGroupCall"!==s._&&!t)return s;const i=this.getCachedParticipants(e).size?0:100;return v.Z.invokeApiSingleProcess({method:"phone.getGroupCall",params:{call:this.getGroupCallInput(e),limit:i},processResult:t=>{M.Z.saveApiUsers(t.users),P.Z.saveApiChats(t.chats),this.saveApiParticipants(e,t.participants,!0);const s=this.saveGroupCall(t.call);return i&&void 0===this.nextOffsets.get(e)&&this.nextOffsets.set(e,t.participants_next_offset),s}})}))}saveGroupCall(e,t){const s=this.groupCalls.get(e.id),i="inputGroupCall"!==e._&&(!s||"groupCallDiscarded"!==s._);return s?(i&&(0,a.Z)(s,e),e=s):this.groupCalls.set(e.id,e),i&&y.default.dispatchEvent("group_call_update",e),e}startConnectingSound(){this.stopConnectingSound(),this.audioAsset.playSoundWithTimeout("group_call_connect.mp3",!0,2500)}stopConnectingSound(){this.audioAsset.stopSound(),this.audioAsset.cancelDelayedPlay()}setCurrentGroupCall(e){this.currentGroupCall=e,e&&y.default.dispatchEvent("group_call_instance",e)}createGroupCall(e,t,s){return w(this,void 0,void 0,(function*(){const i=yield v.Z.invokeApi("phone.createGroupCall",{peer:S.Z.getInputPeerById(e.toPeerId(!0)),random_id:(0,r.d)(32),schedule_date:t,title:s});return I.Z.processUpdateMessage(i),i.updates.find((e=>"updateGroupCall"===e._)).call}))}joinGroupCall(e,t,s=!0,i,n){return w(this,void 0,void 0,(function*(){let a;return this.audioAsset.createAudio(),this.log(`joinGroupCall chatId=${e} id=${t} muted=${s} rejoin=${i}`),a=i?this.currentGroupCall.connections.main.streamManager:yield function(e,t){return s=this,i=void 0,a=function*(){const s={audio:(0,u.Z)(),video:t&&(0,g.Z)()},i=new h.Z(c.iK);try{const t=yield(0,p.Z)(s,e);i.addStream(t,"input")}catch(e){console.error("joinGroupCall getStream error",e,s),i.inputStream=new MediaStream}return i},new((n=void 0)||(n=Promise))((function(e,t){function r(e){try{d(a.next(e))}catch(e){t(e)}}function o(e){try{d(a.throw(e))}catch(e){t(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(r,o)}d((a=a.apply(s,i||[])).next())}));var s,i,n,a}(s,n),this.joinGroupCallInternal(e,t,a,s,i,n)}))}joinGroupCallInternal(e,t,s,i,n=!1,a){return w(this,void 0,void 0,(function*(){const r=this.log.bindPrefix("joinGroupCallInternal");r("start",t);const o="main";let{currentGroupCall:c}=this;if(!c||!n){c=new d.Z({chatId:e,id:t}),c.fixSafariAudio(),c.addEventListener("state",(e=>{this.currentGroupCall===c&&e===l.Z.CLOSED&&(this.setCurrentGroupCall(null),this.stopConnectingSound(),this.audioAsset.playSound("group_call_end.mp3"),y.default.dispatchEvent("chat_update",c.chatId))})),c.groupCall=yield this.getGroupCallFull(t);const h=c.createConnectionInstance({streamManager:s,type:o,options:{type:o,isMuted:i,joinVideo:a,rejoin:n}}),u=h.createPeerConnection();return u.addEventListener("negotiationneeded",(()=>{h.negotiate()})),u.addEventListener("track",(e=>{r("ontrack",e),c.onTrack(e)})),u.addEventListener("iceconnectionstatechange",(()=>{c.dispatchEvent("state",c.state);const{iceConnectionState:e}=u;switch("disconnected"===e||"checking"===e||"new"===e?this.startConnectingSound():this.stopConnectingSound(),e){case"checking":case"completed":case"disconnected":case"new":break;case"closed":case"failed":c.hangUp();break;case"connected":c.joined||(c.joined=!0,this.audioAsset.playSound("group_call_start.mp3"),this.getGroupCallParticipants(t).then((({participants:e})=>{this.saveApiParticipants(t,[...e.values()])})))}})),h.createDescription(),h.createDataChannel(),h.appendStreamToConference(),this.setCurrentGroupCall(c),r("set currentGroupCall",t,c),this.startConnectingSound(),h.negotiate()}c.handleUpdateGroupCallParticipants=!1,c.updatingSdp=!1,r("update currentGroupCall",t,c)}))}getGroupCallInput(e){const t=this.getGroupCall(e);return{_:"inputGroupCall",id:t.id,access_hash:t.access_hash}}generateSelfVideo(e,t){return e&&{_:"groupCallParticipantVideo",pFlags:{},endpoint:"",source_groups:e.sourceGroups,audio_source:t}}generateSelfParticipant(){var e,t;const s=this.currentGroupCall.connections.main.sources,i=null===(e=this.currentGroupCall.connections.presentation)||void 0===e?void 0:e.sources;return{_:"groupCallParticipant",pFlags:{can_self_unmute:!0,self:!0},source:s.audio.source,video:this.generateSelfVideo(s.video),presentation:i&&this.generateSelfVideo(i.video,null===(t=i.audio)||void 0===t?void 0:t.source),date:(0,o.Z)(!0),peer:S.Z.getOutputPeer(y.default.myId)}}makeSsrcFromParticipant(e,t,s,i){return(0,f.z_)(t,s,i)}getGroupCallParticipants(e){return w(this,void 0,void 0,(function*(){const{nextOffset:t,setNextOffset:s}=this.prepareToSavingNextOffset(e);return""!==t&&(yield v.Z.invokeApiSingleProcess({method:"phone.getGroupParticipants",params:{call:this.getGroupCallInput(e),ids:[],sources:[],offset:t||"",limit:100},processResult:t=>{const i=t.count===t.participants.length?"":t.next_offset;P.Z.saveApiChats(t.chats),M.Z.saveApiUsers(t.users),this.saveApiParticipants(e,t.participants),s(i)}})),{participants:this.getCachedParticipants(e),isEnd:""===this.nextOffsets.get(e)}}))}hangUp(e,t=!1,s=!1){return w(this,void 0,void 0,(function*(){this.log(`hangUp start id=${e} discard=${t} rejoin=${s}`);const{currentGroupCall:i}=this;(null==i?void 0:i.id)===e&&i.hangUp(t,s)}))}toggleMuted(e){return this.changeUserMuted(_.NM,e)}changeUserMuted(e,t){const{currentGroupCall:s}=this;if(!s)return;const i=s.getParticipantByPeerId(e);return _.NM===e&&i.pFlags.can_self_unmute&&(t=void 0===t?!i.pFlags.muted:t),this.editParticipant(s.id,i,{muted:t})}};i.GO&&(i.GO.appGroupCallsManager=C);const Z=C},9492:(e,t,s)=>{s.d(t,{Z:()=>r});var i=s(410);class n{constructor(){this.tempNum=0}generateMessageId(e,t=!1){const s=n.MESSAGE_ID_OFFSET,i=t?++this.tempNum:0;return e>=s?t?e+(i&n.MESSAGE_ID_INCREMENT-1):e:s+(e*n.MESSAGE_ID_INCREMENT+(i&n.MESSAGE_ID_INCREMENT-1))}getServerMessageId(e){return this.clearMessageId(e,!0)}clearMessageId(e,t){const s=n.MESSAGE_ID_OFFSET;if(e<s)return e;const i=n.MESSAGE_ID_INCREMENT-1,a=e&i;return a!==i&&(e-=a+1),t?(e-s)/n.MESSAGE_ID_INCREMENT:e}incrementMessageId(e,t){return this.generateMessageId(this.getServerMessageId(e)+t)}}n.MESSAGE_ID_INCREMENT=65536,n.MESSAGE_ID_OFFSET=4294967295;const a=new n;i.GO&&(i.GO.appMessagesIdsManager=a);const r=a},7223:(e,t,s)=>{s.d(t,{Z:()=>pe});var i=s(1425),n=s(1964),a=s(3725),r=s(632),o=s(6056),d=s(144),l=s(4727),c=s(5003),h=s(9518),u=s(2003),p=s(8045),g=s(8598),f=s(3512),m=s(7381),v=s(5393),_=s(1507),y=s(6761),I=s(6947),P=s(7625),S=s(1655),M=s(6519),w=s(8027),C=s(3442);const Z=void 0;class b{constructor(e,t,s,i,n,a,r,o,d,l){this.appMessagesManager=e,this.appChatsManager=t,this.appPeersManager=s,this.appUsersManager=i,this.appDraftsManager=n,this.appNotificationsManager=a,this.appStateManager=r,this.apiUpdatesManager=o,this.serverTimeManager=d,this.appMessagesIdsManager=l,this.folders={},this.onUpdateFolderPeers=e=>{e.folder_peers.forEach((e=>{var t;const{folder_id:s,peer:i}=e,n=this.appPeersManager.getPeerId(i),a=this.dropDialog(n)[0];a&&((null===(t=a.pFlags)||void 0===t?void 0:t.pinned)&&this.handleDialogUnpinning(a,s),a.folder_id=s,this.generateIndexForDialog(a),this.pushDialog(a)),this.appMessagesManager.scheduleHandleNewDialogs(n,a)}))},this.onUpdateDialogPinned=e=>{var t;const s=null!==(t=e.folder_id)&&void 0!==t?t:0,i=this.appPeersManager.getPeerId(e.peer.peer),n=this.getDialogOnly(i);n&&(e.pFlags.pinned?n.pFlags.pinned=!0:this.handleDialogUnpinning(n,s),this.generateIndexForDialog(n)),this.appMessagesManager.scheduleHandleNewDialogs(i,n)},this.onUpdatePinnedDialogs=e=>{var t;const s=null!==(t=e.folder_id)&&void 0!==t?t:0,i=e=>{this.pinnedOrders[s].length=0,e.reverse(),e.forEach((e=>{n[e]=!0;const t=this.getDialogOnly(e);this.appMessagesManager.scheduleHandleNewDialogs(e,t),t&&(t.pFlags.pinned=!0,this.generateIndexForDialog(t))}));const t=this.getFolderDialogs(s,!1);for(const e of t){if(!e.pFlags.pinned)break;const t=e.peerId;n[t]||this.appMessagesManager.scheduleHandleNewDialogs(t)}},n={};e.order?i(e.order.map((e=>this.appPeersManager.getPeerId(e.peer)))):h.Z.invokeApi("messages.getPinnedDialogs",{folder_id:s}).then((e=>{this.applyDialogs(e),i(e.dialogs.map((e=>e.peerId)))}))},this.storage=this.appStateManager.storages.dialogs,this.dialogs=this.storage.getCache(),this.clear(!0),f.default.addEventListener("language_change",(()=>{const e=i.getSelf().id.toPeerId(!1);if(this.getDialogOnly(e)){const t=s.getPeerSearchText(e);this.dialogsIndex.indexObject(e,t)}}));const c=e=>{const t=this.getCachedDialogs(!1);for(let s=0;s<t.length;++s)this.processDialogForFilter(t[s],e)};f.default.addEventListener("filter_order",(()=>{const e=this.getCachedDialogs(!1);for(const e in this.folders)+e>1&&delete this.folders[e];for(let t=0;t<e.length;++t){const s=e[t];for(let e=0;e<=10;++e)s[`index_${e}`]=void 0;this.processDialogForFilters(s)}})),f.default.addEventListener("filter_update",c),f.default.addEventListener("filter_new",c),f.default.addEventListener("filter_delete",(e=>{const t=this.getCachedDialogs(!1),s=`index_${e.orderIndex}`;for(let e=0;e<t.length;++e)delete t[e][s];delete this.folders[e.id]})),f.default.addEventListener("dialog_notify_settings",(e=>{this.processDialogForFilters(e)})),f.default.addEventListener("chat_update",(e=>{const t=this.appChatsManager.getChat(e),s=e.toPeerId(!0);t.pFlags.left&&this.getDialogOnly(s)&&this.dropDialogOnDeletion(s)})),f.default.addMultipleEventsListeners({updateFolderPeers:this.onUpdateFolderPeers,updateDialogPinned:this.onUpdateDialogPinned,updatePinnedDialogs:this.onUpdatePinnedDialogs}),r.getState().then((e=>{this.pinnedOrders=e.pinnedOrders||{},this.pinnedOrders[0]||(this.pinnedOrders[0]=[]),this.pinnedOrders[1]||(this.pinnedOrders[1]=[]);const t=r.storagesResults.dialogs;t.length&&I.Z.freezeSaving(this.setDialogsFromState.bind(this,t),["chats","dialogs","messages","users"]),this.allDialogsLoaded=e.allDialogsLoaded||{}}))}setDialogsFromState(e){for(let t=0,s=e.length;t<s;++t){const s=e[t];if(s){s.top_message=this.appMessagesIdsManager.getServerMessageId(s.top_message),s.topMessage&&this.appMessagesManager.saveMessages([s.topMessage]);for(let e=0;e<=10;++e)delete s[`index_${e}`];this.saveDialog(s,void 0,!0),this.appMessagesManager.getMessageByPeer(s.peerId,s.top_message).deleted&&this.appMessagesManager.reloadConversation(s.peerId)}}}isDialogsLoaded(e){return!!this.allDialogsLoaded[e]}setDialogsLoaded(e,t){e===Z&&t?(this.allDialogsLoaded[0]=t,this.allDialogsLoaded[1]=t):this.allDialogsLoaded[e]=t,this.allDialogsLoaded[0]&&this.allDialogsLoaded[1]&&(this.allDialogsLoaded[void 0]=!0),this.appStateManager.pushToState("allDialogsLoaded",this.allDialogsLoaded)}clear(e=!1){this.pinnedOrders={0:[],1:[]},e?this.allDialogsLoaded={}:(this.appStateManager.storagesResults.dialogs.length=0,this.storage.clear(),this.setDialogsLoaded(0,!1),this.setDialogsLoaded(1,!1),this.setDialogsLoaded(Z,!1),this.savePinnedOrders()),this.folders={},this.dialogsOffsetDate={},this.dialogsNum=0,this.dialogsIndex=new m.Z({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0}),this.cachedResults={query:"",count:0,dialogs:[],folderId:0}}handleDialogUnpinning(e,t){delete e.pFlags.pinned,(0,S.Z)(this.pinnedOrders[t],e.peerId),this.savePinnedOrders()}savePinnedOrders(){this.appStateManager.pushToState("pinnedOrders",this.pinnedOrders)}resetPinnedOrder(e){this.pinnedOrders[e]=[]}getPinnedOrders(e){return this.pinnedOrders[e]}getOffsetDate(e){const t=this.dialogsOffsetDate[e]||0;return e!==Z||t?t:Math.min(this.getOffsetDate(0),this.getOffsetDate(1))}getFolder(e){var t;return null!==(t=this.folders[e])&&void 0!==t?t:this.folders[e]={dialogs:[],id:e,unreadMessagesCount:0,unreadDialogsCount:0}}getFolderDialogs(e,t=!0){if(e===Z)return this.getCachedDialogs(t);const s=this.getFolder(e);return t?s.dialogs.filter((e=>void 0===e.migratedTo)):s.dialogs}getCachedDialogs(e){return this.getFolderDialogs(0,e).concat(this.getFolderDialogs(1,e))}setDialogIndexInFilter(e,t,s){var i;let n;if(this.appMessagesManager.filtersStorage.testDialogForFilter(e,s)){const t=s.pinnedPeerIds.indexOf(e.peerId);n=-1!==t?this.generateDialogIndex(this.generateDialogPinnedDateByIndex(s.pinned_peers.length-1-t),!0):(null===(i=e.pFlags)||void 0===i?void 0:i.pinned)?this.generateIndexForDialog(e,!0):e.index}return e[t]=n}getDialog(e,t,s=!0){const i=[];void 0===t?i.push(this.getFolder(0).dialogs,this.getFolder(1).dialogs):i.push(this.getFolderDialogs(t,!1));for(let t of i){let i=0,n=0;for(let a=t.length;i<a;++i){const a=t[i];if(a.peerId===e)return[a,i-n];s&&void 0!==a.migratedTo&&++n}}return[]}getDialogOnly(e){return this.dialogs[e]}generateDialogIndex(e,t){return void 0===e&&(e=(0,r.bz)(!0)+this.serverTimeManager.serverTimeOffset),65536*e+(t?0:65535&++this.dialogsNum)}processDialogForFilters(e){const t=this.appMessagesManager.filtersStorage.filters;for(const s in t){const i=t[s];this.processDialogForFilter(e,i)}}processDialogForFilter(e,t){const s=this.getDialogIndexKey(t.id),i=this.getFolder(t.id).dialogs,n=i.findIndex((t=>t.peerId===e.peerId)),a=i[n],r=a&&a[s],o=this.setDialogIndexInFilter(e,s,t);r!==o&&((!r&&o||n&&!o)&&this.prepareFolderUnreadCountModifyingByDialog(t.id,e,!!o),-1!==n&&i.splice(n,1),o&&(0,M.Z)(i,e,s,-1))}prepareDialogUnreadCountModifying(e){const t=[this.prepareFolderUnreadCountModifyingByDialog(e.folder_id,e)],s=this.appMessagesManager.filtersStorage.filters;for(const i in s){const n=s[i];this.appMessagesManager.filtersStorage.testDialogForFilter(e,n)&&t.push(this.prepareFolderUnreadCountModifyingByDialog(n.id,e))}return()=>t.forEach((e=>e()))}prepareFolderUnreadCountModifyingByDialog(e,t,s){const i=this.appMessagesManager.getDialogUnreadCount(t);if(void 0===s)return()=>{const s=this.appMessagesManager.getDialogUnreadCount(t),n=s-i,a=s&&!i||!s&&i?i?-1:1:0;this.modifyFolderUnreadCount(e,n,a)};this.modifyFolderUnreadCount(e,s?i:-i,i?s?1:-1:0)}modifyFolderUnreadCount(e,t,s){if(!t&&!s)return;const i=this.getFolder(e);t&&(i.unreadMessagesCount=Math.max(0,i.unreadMessagesCount+t)),s&&(i.unreadDialogsCount=Math.max(0,i.unreadDialogsCount+s)),void 0===i.dispatchUnreadTimeout&&(i.dispatchUnreadTimeout=y.Z.setTimeout((()=>{i.dispatchUnreadTimeout=void 0,f.default.dispatchEvent("folder_unread",i)}),0))}generateIndexForDialog(e,t=!1,s){var i;let n,a=0;if(e.pFlags.pinned&&!t)a=this.generateDialogPinnedDate(e),n=!0;else{s||(s=this.appMessagesManager.getMessageByPeer(e.peerId,e.top_message)),a=s.date||a;const t=this.appPeersManager.isChannel(e.peerId)&&e.peerId.toChatId();if(t){const e=this.appChatsManager.getChat(t);(!a||e.date&&e.date>a)&&(a=e.date)}"draftMessage"===(null===(i=e.draft)||void 0===i?void 0:i._)&&e.draft.date>a&&(a=e.draft.date)}a||(a=(0,r.bz)(!0));const o=this.generateDialogIndex(a,n);if(t)return o;e.index=o}generateDialogPinnedDateByIndex(e){return 2147418112+(65535&e)}generateDialogPinnedDate(e){const t=this.pinnedOrders[e.folder_id],s=t.indexOf(e.peerId);let i=s;return-1===s&&(i=t.push(e.peerId)-1,this.savePinnedOrders()),this.generateDialogPinnedDateByIndex(i)}setDialogToState(e){const{peerId:t,pts:s}=e,i=this.appMessagesManager.getHistoryStorage(t),n=this.appMessagesManager.getMessagesStorage(t),a=i.history.slice;let r;for(let e=0,s=a.length;e<s;++e){const s=a[e],i=this.appMessagesManager.getMessageFromStorage(n,s);if(!i.pFlags.is_outgoing&&!i.deleted){r=i;const e=i.viaBotId||i.fromId;e!==t&&this.appStateManager.requestPeerSingle(e,"topMessage",t);break}}if(e.topMessage=r,t.isAnyChat()&&s){const i=this.apiUpdatesManager.getChannelState(t.toChatId(),s).pts;e.pts=i}this.storage.set({[t]:e}),this.appStateManager.requestPeerSingle(t,"dialog")}pushDialog(e,t,s,i){const{folder_id:n,peerId:a}=e,r=this.getFolderDialogs(n,!1),o=r.findIndex((e=>e.peerId===a));if(-1!==o&&r.splice(o,1),this.dialogs[a]=e,this.setDialogToState(e),void 0===t&&(t=this.getDialogOffsetDate(e)),this.processDialogForFilters(e),t&&!e.pFlags.pinned){if(i){const e=this.dialogsOffsetDate[void 0];(!e||t<e)&&(this.dialogsOffsetDate[void 0]=t)}const a=this.dialogsOffsetDate[n];if(!a||t<a){if(!s&&!this.isDialogsLoaded(n))return void this.clearDialogFromState(e,!0);this.dialogsOffsetDate[n]=t}}-1===o&&this.prepareFolderUnreadCountModifyingByDialog(n,e,!0),(0,M.Z)(r,e,"index",-1)}dropDialog(e){const t=this.getDialog(e,void 0,!1),[s,i]=t;if(s){delete this.dialogs[e],this.getFolder(s.folder_id).dialogs.splice(i,1);const t=void 0!==(0,S.Z)(this.pinnedOrders[s.folder_id],e);this.processDialogForFilters(s),this.dialogsIndex.indexObject(e,""),t&&this.savePinnedOrders(),this.clearDialogFromState(s,!1)}return t}clearDialogFromState(e,t){const s=e.peerId;this.appStateManager.releaseSinglePeer(s,"topMessage"),this.appStateManager.releaseSinglePeer(s,"dialog"),this.storage.delete(s,t)}dropDialogWithEvent(e){const t=this.dropDialog(e);return t.length&&f.default.dispatchEvent("dialog_drop",{peerId:e,dialog:t[0]}),t}dropDialogOnDeletion(e){this.dropDialogWithEvent(e),f.default.dispatchEvent("peer_deleted",e)}applyDialogs(e){(0,P.Z)(e.dialogs,((t,s)=>{"dialogFolder"===t._&&e.dialogs.splice(s,1)})),this.appUsersManager.saveApiUsers(e.users),this.appChatsManager.saveApiChats(e.chats),this.appMessagesManager.saveMessages(e.messages);const t={};e.dialogs.forEach((e=>{const s=this.appPeersManager.getPeerId(e.peer);let i=e.top_message;const n=this.appMessagesManager.pendingTopMsgs[s];n&&(!i||this.appMessagesManager.getMessageByPeer(s,n).date>this.appMessagesManager.getMessageByPeer(s,i).date)&&(e.top_message=i=n,this.appMessagesManager.getHistoryStorage(s).maxId=n),i||e.draft&&"draftMessage"===e.draft._?(this.saveDialog(e),t[s]=e):this.dropDialogWithEvent(s);const a=this.appMessagesManager.newUpdatesAfterReloadToHandle[s];if(void 0!==a){for(const e of a)a.delete(e),this.apiUpdatesManager.saveUpdate(e);a.size||delete this.appMessagesManager.newUpdatesAfterReloadToHandle[s]}})),Object.keys(t).length&&f.default.dispatchEvent("dialogs_multiupdate",t)}getDialogOffsetDate(e){return this.appMessagesManager.getMessageByPeer(e.peerId,e.top_message).date||0}saveDialog(e,t,s,i){var n,a;void 0===t&&(t=null!==(n=e.folder_id)&&void 0!==n?n:0);const r=this.appPeersManager.getPeerId(e.peer);if(!r)return void console.error("saveConversation no peerId???",e,t);"dialog"!==e._&&console.error("saveConversation not regular dialog",e,Object.assign({},e));const o=this.appPeersManager.isChannel(r)?r.toChatId():_.NM;if(r.isAnyChat()){const e=this.appChatsManager.getChat(r.toChatId());if("channelForbidden"===e._||e.pFlags.left||e.pFlags.kicked)return}const d=this.appPeersManager.getPeerSearchText(r);this.dialogsIndex.indexObject(r,d);const l=this.getDialogOnly(r);let c,h;if(e.top_message){c=this.appMessagesIdsManager.generateMessageId(e.top_message);const t=(null==l?void 0:l.top_message)&&this.appMessagesManager.getMessageByPeer(r,l.top_message);(null===(a=null==t?void 0:t.pFlags)||void 0===a?void 0:a.is_outgoing)&&l.top_message>=c&&(c=l.top_message),h=this.appMessagesManager.getMessageByPeer(r,c)}else c=this.appMessagesManager.generateTempMessageId(r),h={_:"message",id:c,mid:c,from_id:this.appPeersManager.getOutputPeer(this.appUsersManager.getSelf().id.toPeerId(!1)),peer_id:this.appPeersManager.getOutputPeer(r),deleted:!0,pFlags:{out:!0},date:0,message:""},this.appMessagesManager.saveMessages([h],{isOutgoing:!0});if((null==h?void 0:h.pFlags)||this.appMessagesManager.log.error("saveConversation no message:",e,h),!o&&r.isAnyChat()){const t=this.appChatsManager.getChat(r.toChatId());if(t&&t.migrated_to&&t.pFlags.deactivated){const s=this.appPeersManager.getPeerId(t.migrated_to);this.appMessagesManager.migratedFromTo[r]=s,this.appMessagesManager.migratedToFrom[s]=r,e.migratedTo=s}}if(e.top_message=c,e.read_inbox_max_id=this.appMessagesIdsManager.generateMessageId(l&&!e.read_inbox_max_id?l.read_inbox_max_id:e.read_inbox_max_id),e.read_outbox_max_id=this.appMessagesIdsManager.generateMessageId(l&&!e.read_outbox_max_id?l.read_outbox_max_id:e.read_outbox_max_id),void 0===e.folder_id&&"dialog"===e._&&(e.folder_id=l?l.folder_id:t),e.draft=this.appDraftsManager.saveDraft(r,0,e.draft),e.peerId=r,h.pFlags.is_outgoing){const t=h.pFlags.out;c>e[t?"read_outbox_max_id":"read_inbox_max_id"]?(h.pFlags.unread=!0,e.unread_count||t||++e.unread_count):delete h.pFlags.unread}const u=this.appMessagesManager.getHistoryStorage(r),p=u.history.slice;p.length?p.isEnd(v.D.Bottom)||(u.history.insertSlice([c]).setEnd(v.D.Bottom),u.count||(u.count=1),this.appMessagesManager.mergeReplyKeyboard(u,h)&&f.default.dispatchEvent("history_reply_markup",{peerId:r})):(u.history.unshift(c),u.count||(u.count=1),this.appMessagesManager.mergeReplyKeyboard(u,h)&&f.default.dispatchEvent("history_reply_markup",{peerId:r})),u.maxId=c,u.readMaxId=e.read_inbox_max_id,u.readOutboxMaxId=e.read_outbox_max_id,this.appNotificationsManager.savePeerSettings({peerId:r,settings:e.notify_settings}),o&&e.pts&&this.apiUpdatesManager.addChannelState(o,e.pts),this.generateIndexForDialog(e),(0,w.Z)(e,["index_0","index_1","index_2","index_3","index_4","index_5","index_6","index_7","index_8","index_9","index_10"]),l&&(0,C.Z)(l,e),this.pushDialog(e,h.date,s,i)}getDialogIndexKey(e){return e>1?`index_${this.appMessagesManager.filtersStorage.getFilter(e).orderIndex}`:"index"}getDialogs(e="",t,s=20,i=0,n=!1){const a={};if(i>1){const r=[],o=this.appUsersManager.fillContacts();o.cached||r.push(o.promise);const d=this.appMessagesManager.filtersStorage.reloadMissingPeerIds(i);if(d&&r.push(d),r.length)return a.cached=!1,a.promise=Promise.all(r).then((()=>this.getDialogs(e,t,s,i,n).promise)),a}const r=i>1||this.getOffsetDate(i)?Z:i;let o=this.getFolderDialogs(i,n);const d=this.getDialogIndexKey(i);if(e){if(!s||this.cachedResults.query!==e||this.cachedResults.folderId!==i){this.cachedResults.query=e,this.cachedResults.folderId=i;const t=this.dialogsIndex.search(e),s=[];for(const e in this.dialogs){const n=this.dialogs[e];t.has(n.peerId)&&n.folder_id===i&&s.push(n)}s.sort(((e,t)=>t[d]-e[d])),this.cachedResults.dialogs=s,this.cachedResults.count=s.length}o=this.cachedResults.dialogs}else this.cachedResults.query="";let l=0;if(t>0)for(let e=o.length;l<e&&!(t>o[l][d]);++l);const c=this.isDialogsLoaded(r),h=o.length>=l+s;if(e||c||h){const i=o.slice(l,l+s);return a.cached=!0,a.promise=Promise.resolve({dialogs:i,count:c?o.length:null,isTopEnd:o.length&&(i[0]&&i[0]===o[0]||o[0][d]<t),isEnd:(e||c)&&l+s>=o.length}),a}return a.cached=!1,a.promise=this.appMessagesManager.getTopMessages(s,r).then((e=>{if(n&&(o=this.getFolderDialogs(i,n)),l=0,t>0)for(let e=o.length;l<e&&!(t>o[l][d]);++l);const a=o.slice(l,l+s);return{dialogs:a,count:void 0===e.count?o.length:e.count,isTopEnd:o.length&&(a[0]&&a[0]===o[0]||o[0][d]<t),isEnd:e.isEnd}})),a}}var k=s(8479);const E=[["pinned_peers","pinnedPeerIds"],["exclude_peers","excludePeerIds"],["include_peers","includePeerIds"]];class A{constructor(e,t,s,i,n,a,r){this.appMessagesManager=e,this.appPeersManager=t,this.appUsersManager=s,this.appNotificationsManager=i,this.appStateManager=n,this.apiUpdatesManager=a,this.rootScope=r,this.onUpdateDialogFilter=e=>{e.filter?this.saveDialogFilter(e.filter):this.filters[e.id]&&(this.rootScope.dispatchEvent("filter_delete",this.filters[e.id]),delete this.filters[e.id]),this.appStateManager.pushToState("filters",this.filters)},this.onUpdateDialogFilterOrder=e=>{this.orderIndex=1,e.order.forEach(((e,t)=>{const s=this.filters[e];delete s.orderIndex,this.setOrderIndex(s)})),this.rootScope.dispatchEvent("filter_order",e.order),this.appStateManager.pushToState("filters",this.filters)},this.clear(!0),this.filters={},this.appStateManager.getState().then((e=>{(0,C.Z)(this.filters,e.filters);for(const e in this.filters){const t=this.filters[e];t.hasOwnProperty("orderIndex")&&t.orderIndex>=this.orderIndex&&(this.orderIndex=t.orderIndex+1)}})),r.addMultipleEventsListeners({updateDialogFilter:this.onUpdateDialogFilter,updateDialogFilters:e=>{const t=(0,k.Z)(this.filters);this.getDialogFilters(!0).then((e=>{for(const s in t){const t=+s;e.find((e=>e.id===t))||this.onUpdateDialogFilter({_:"updateDialogFilter",id:t})}this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:e.map((e=>e.id))})}))},updateDialogFilterOrder:this.onUpdateDialogFilterOrder})}clear(e=!1){e?(this.filters={},this.reloadedPeerIds=new Set):((0,C.Z)(this.filters,{}),this.reloadedPeerIds.clear()),this.orderIndex=1}testDialogForFilter(e,t){const s=e.peerId;if(!this.appMessagesManager.getDialogOnly(s))return!1;if(t.excludePeerIds.includes(s))return!1;if(t.includePeerIds.includes(s))return!0;const i=t.pFlags;if(i.exclude_archived&&1===e.folder_id)return!1;if(i.exclude_read&&!this.appMessagesManager.isDialogUnread(e))return!1;if(i.exclude_muted&&this.appNotificationsManager.isPeerLocalMuted(s)&&(!e.unread_mentions_count||!e.unread_count))return!1;if(this.appPeersManager.isAnyChat(s)){if(i.broadcasts&&this.appPeersManager.isBroadcast(s))return!0;if(i.groups&&this.appPeersManager.isAnyGroup(s))return!0}else{const e=s.toUserId();if(this.appUsersManager.isBot(e))return!!i.bots;if(i.non_contacts&&!this.appUsersManager.isContact(e))return!0;if(i.contacts&&this.appUsersManager.isContact(e))return!0}return!1}testDialogForFilterId(e,t){return this.testDialogForFilter(e,this.filters[t])}getFilter(e){return this.filters[e]}toggleDialogPin(e,t){const s=this.filters[t],i=s.pinnedPeerIds.indexOf(e),n=-1!==i;if(n&&(s.pinned_peers.splice(i,1),s.pinnedPeerIds.splice(i,1)),!n){if(s.pinned_peers.length>=this.rootScope.config.pinned_infolder_count_max)return Promise.reject({type:"PINNED_DIALOGS_TOO_MUCH"});s.pinned_peers.unshift(this.appPeersManager.getInputPeerById(e)),s.pinnedPeerIds.unshift(e)}return this.updateDialogFilter(s)}createDialogFilter(e,t){const s=Math.max(1,...Object.keys(this.filters).map((e=>+e)));return(e=(0,k.Z)(e)).id=s+1,this.updateDialogFilter(e,void 0,t)}updateDialogFilter(e,t=!1,s=!1){const i=t?0:1;return h.Z.invokeApi("messages.updateDialogFilter",{flags:i,id:e.id,filter:t?void 0:this.getOutputDialogFilter(e)}).then((i=>{if(i&&(this.onUpdateDialogFilter({_:"updateDialogFilter",id:e.id,filter:t?void 0:e}),s)){const t=[];for(const e in this.filters){const s=this.filters[e];++s.orderIndex,t.push(s)}e.orderIndex=1;const s=t.sort(((e,t)=>e.orderIndex-t.orderIndex)).map((e=>e.id));this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:s})}return i}))}getOutputDialogFilter(e){const t=(0,k.Z)(e);return this.filterIncludedPinnedPeers(e),t}filterIncludedPinnedPeers(e){(0,P.Z)(e.includePeerIds,((t,s)=>{e.pinnedPeerIds.includes(t)&&(e.include_peers.splice(s,1),e.includePeerIds.splice(s,1))}))}reloadMissingPeerIds(e,t="pinned_peers"){const s=[],i=this.getFilter(e),n=i&&i[t];if(null==n?void 0:n.length){const e=n.filter(((e,t)=>{const s=this.appPeersManager.getPeerId(e);return!this.reloadedPeerIds.has(s)&&!this.appMessagesManager.getDialogOnly(s)}));if(e.length){const t=e.map((e=>{const t=this.appPeersManager.getPeerId(e),s=this.appMessagesManager.reloadConversation(e);return s.then((()=>{this.reloadedPeerIds.add(t)})),s})),i=Promise.all(t);s.push(i)}}return s.length?Promise.all(s):void 0}getDialogFilters(e=!1){return t=this,s=void 0,n=function*(){const t=Object.keys(this.filters);if(t.length&&!e)return t.map((e=>this.filters[e])).sort(((e,t)=>e.orderIndex-t.orderIndex));const s=yield h.Z.invokeApiSingle("messages.getDialogFilters");for(const t of s)this.saveDialogFilter(t,e);return s},new((i=void 0)||(i=Promise))((function(e,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(r,o)}d((n=n.apply(t,s||[])).next())}));var t,s,i,n}saveDialogFilter(e,t=!0){E.forEach((([t,s])=>{e[s]=e[t].map((e=>this.appPeersManager.getPeerId(e)))})),this.filterIncludedPinnedPeers(e),e.include_peers=e.pinned_peers.concat(e.include_peers),e.includePeerIds=e.pinnedPeerIds.concat(e.includePeerIds);const s=this.filters[e.id];s?Object.assign(s,e):this.filters[e.id]=e,this.setOrderIndex(e),t?this.rootScope.dispatchEvent("filter_update",e):s||this.rootScope.dispatchEvent("filter_new",e)}setOrderIndex(e){e.hasOwnProperty("orderIndex")?e.orderIndex>=this.orderIndex&&(this.orderIndex=e.orderIndex+1):e.orderIndex=this.orderIndex++,this.appStateManager.pushToState("filters",this.filters)}}var D=s(5185),T=s(8138),F=s(1592),U=s(7309),x=s(6440),L=s(3714),R=s(7995),O=s(4687),N=s(5555),B=s(646),j=s(5667),G=s(8801),H=s(8209),z=s(410),q=s(9090),V=s(1431),W=s(5705),$=s(2614),K=s(8939),J=s(9256),Q=s(5228),Y=s(3624),X=s(8938),ee=s(9492),te=s(1174),se=s(5844),ie=s(2459),ne=s(6689),ae=s(677),re=s(7401),oe=s(6848),de=s(3738),le=s(8456);function ce(e,t){if(e.length<t)return[e];let s=0,i=0,n=0;const a=[],r=r=>{let o=e.slice(i,r);const d=n++;o.length>t&&(ce(o.slice(t),t).forEach((e=>{a[n++]=e})),o=o.slice(0,t)),i=r,s=0,a[d]=(a[d]||"")+o};let o=0;for(;;){let i=e.indexOf(" ",o);if(-1===i){o!==e.length-1&&r();break}i+=" ".length;const n=i-o;s+n>t&&r(s),o=i,s+=n}return a}var he=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};const ue=new class{constructor(){this.pendingByRandomId={},this.pendingByMessageId={},this.pendingAfterMsgs={},this.pendingTopMsgs={},this.tempFinalizeCallbacks={},this.sendSmthLazyLoadQueue=new i.lh(10),this.needSingleMessages=new Map,this.fetchSingleMessagesPromise=null,this.maxSeenId=0,this.migratedFromTo={},this.migratedToFrom={},this.newMessagesHandleTimeout=0,this.newMessagesToHandle={},this.newDialogsToHandle={},this.newUpdatesAfterReloadToHandle={},this.notificationsHandlePromise=0,this.notificationsToHandle={},this.reloadConversationsPeers=new Map,this.log=(0,c.kg)("MESSAGES",c.v9.Error|c.v9.Debug|c.v9.Log|c.v9.Warn),this.groupedTempId=0,this.typings={},this.unreadMentions={},this.goToNextMentionPromises={},this.handleNewMessages=()=>{clearTimeout(this.newMessagesHandleTimeout),this.newMessagesHandleTimeout=0,f.default.dispatchEvent("history_multiappend",this.newMessagesToHandle),this.newMessagesToHandle={}},this.handleNewDialogs=()=>{let e=0;const t=this.newDialogsToHandle;for(const s in t){const i=t[s];i?(this.dialogsStorage.pushDialog(i),x.Z.isChannel(s.toPeerId())||(e=Math.max(e,i.top_message||0))):(this.reloadConversation(s.toPeerId()),delete t[s])}0!==e&&this.incrementMaxSeenId(e),f.default.dispatchEvent("dialogs_multiupdate",t),this.newDialogsToHandle={}},this.handleNotifications=()=>{window.clearTimeout(this.notificationsHandlePromise),this.notificationsHandlePromise=0;for(const e in this.notificationsToHandle){const t=e.toPeerId();if(f.default.peerId===t&&!f.default.idle.isIDLE)continue;const s=this.notificationsToHandle[t];this.getNotifyPeerSettings(t).then((({muted:e,peerTypeNotifySettings:t})=>{const i=s.topMessage;!e&&i.pFlags.unread&&i.pFlags.unread&&this.notifyAboutMessage(i,{fwdCount:s.fwdCount,peerTypeNotifySettings:t})}))}this.notificationsToHandle={}},this.onUpdateMessageId=e=>{const t=e.random_id,s=this.pendingByRandomId[t];if(s){const{peerId:i,tempId:n,threadId:a,storage:r}=s,o=ee.Z.generateMessageId(e.id),d=this.getMessageFromStorage(r,o);d.deleted?this.pendingByMessageId[o]=t:([this.getHistoryStorage(i),a?this.getHistoryStorage(i,a):void 0].filter(Boolean).forEach((e=>{e.history.delete(n)})),this.finalizePendingMessageCallbacks(r,n,d))}},this.onUpdateNewMessage=e=>{var t;const s=e.message,i=this.getMessagePeer(s),n=this.getMessagesStorage(i),a=this.getDialogOnly(i),r="updateNewDiscussionMessage"===e._;this.saveMessages([s],{storage:new Map});const o=this.getThreadKey(s),d=o?+o.split("_")[1]:void 0;if(d&&!r&&this.threadsStorage[i]&&this.threadsStorage[i][d]){const e={_:"updateNewDiscussionMessage",message:s};this.onUpdateNewMessage(e)}if(!a&&!r){let s=!0;if(i.isAnyChat()&&(s=T.Z.isInChat(i.toChatId())),s){const s=null!==(t=this.newUpdatesAfterReloadToHandle[i])&&void 0!==t?t:this.newUpdatesAfterReloadToHandle[i]=new Set;if(s.has(e))return void this.log.error("here we go again",i);e.ignoreExisting=!0,s.add(e),this.scheduleHandleNewDialogs(i)}return}this.saveMessages([s],{storage:n});const l=this.checkPendingMessage(s),c=this.getHistoryStorage(i,r?d:void 0);r||this.updateMessageRepliesIfNeeded(s);const h=e.ignoreExisting;if(c.history.findSlice(s.mid)){if(!h)return!1}else{const e=c.history.first;if(e.isEnd(v.D.Bottom)){let t=0;for(const i=e.length;t<i&&!(s.mid>e[t]);++t);e.splice(t,0,s.mid)}else c.history.unshift(s.mid);null!==c.count&&c.count++}this.mergeReplyKeyboard(c,s)&&f.default.dispatchEvent("history_reply_markup",{peerId:i});const u=s.fromId;if(u.isUser()&&!s.pFlags.out&&s.from_id){N.Z.forceUserOnline(u,s.date);const e={_:"sendMessageCancelAction"};let t;t=i.isUser()?{_:"updateUserTyping",action:e,user_id:u}:x.Z.isChannel(i)?{_:"updateChannelUserTyping",action:e,channel_id:i.toChatId(),from_id:x.Z.getOutputPeer(u),top_msg_id:d?ee.Z.getServerMessageId(d):void 0}:{_:"updateChatUserTyping",action:e,chat_id:i.toChatId(),from_id:x.Z.getOutputPeer(u)},D.Z.processLocalUpdate(t)}if(l||this.handleNewMessage(i,s.mid),r)return;const p=!s.pFlags.out&&s.pFlags.unread;if(a){if(p&&s.mid>a.top_message){const e=this.dialogsStorage.prepareDialogUnreadCountModifying(a);++a.unread_count,s.pFlags.mentioned&&(++a.unread_mentions_count,this.modifyCachedMentions(i,s.mid,!0)),e()}s.mid>=a.top_message&&this.setDialogTopMessage(s,a)}if(p){const e=i;let t=this.notificationsToHandle[e];void 0===t&&(t=this.notificationsToHandle[e]={fwdCount:0,fromId:_.NM}),t.fromId!==u&&(t.fromId=u,t.fwdCount=0),s.fwd_from&&++t.fwdCount,t.topMessage=s,this.notificationsHandlePromise||(this.notificationsHandlePromise=window.setTimeout(this.handleNotifications,0))}},this.onUpdateMessageReactions=e=>{var t,s,i;const{peer:n,msg_id:a,reactions:r}=e,o=ee.Z.generateMessageId(a),d=x.Z.getPeerId(n),l=this.getMessageByPeer(d,o);if("message"!==l._)return;const c=null==r?void 0:r.recent_reactions;if((null==c?void 0:c.length)&&l.pFlags.out){const e=c[c.length-1],t=l.reactions,s=null==t?void 0:t.recent_reactions;x.Z.getPeerId(e.peer_id)===f.default.myId||s&&!(s.length<=c.length)||s&&(0,oe.Z)(e,s[s.length-1])||this.getNotifyPeerSettings(d).then((({muted:t,peerTypeNotifySettings:s})=>{!t&&s.show_previews&&this.notifyAboutMessage(l,{userReaction:e,peerTypeNotifySettings:s})}))}const h=null!==(t=null==r?void 0:r.results)&&void 0!==t?t:[],u=null!==(i=null===(s=l.reactions)||void 0===s?void 0:s.results)&&void 0!==i?i:[],p=h.filter((e=>{const t=u.find((t=>t.reaction===e.reaction));return l.pFlags.out&&(!t||e.count>t.count)||e.pFlags.chosen&&(!t||!t.pFlags.chosen)}));l.reactions=r,f.default.dispatchEvent("message_reactions",{message:l,changedResults:p}),e.local||this.setDialogToStateIfMessageIsTop(l)},this.onUpdateDialogUnreadMark=e=>{const t=x.Z.getPeerId(e.peer.peer),s=this.getDialogOnly(t);if(s){const i=this.dialogsStorage.prepareDialogUnreadCountModifying(s);e.pFlags.unread?s.pFlags.unread_mark=!0:delete s.pFlags.unread_mark,i(),f.default.dispatchEvent("dialogs_multiupdate",{[t]:s}),this.dialogsStorage.setDialogToState(s)}else this.scheduleHandleNewDialogs(t)},this.onUpdateEditMessage=e=>{const t=e.message,s=this.getMessagePeer(t),i=ee.Z.generateMessageId(t.id),n=this.getMessagesStorage(s);if(!n.has(i))return;const a=this.getMessageFromStorage(n,i);this.saveMessages([t],{storage:n});const r=this.getMessageFromStorage(n,i);this.handleEditedMessage(a,r);const o=this.getDialogOnly(s),d=o&&o.top_message===i;if(t.clear_history)d&&f.default.dispatchEvent("dialog_flush",{peerId:s});else{if("message"===(null==a?void 0:a._)&&!(0,oe.Z)(a.reactions,r.reactions)){const e=r.reactions;return r.reactions=a.reactions,void D.Z.processLocalUpdate({_:"updateMessageReactions",peer:x.Z.getOutputPeer(s),msg_id:t.id,reactions:e})}if(f.default.dispatchEvent("message_edit",{storage:n,peerId:s,mid:i}),d||t.grouped_id){const e={};e[s]=o,f.default.dispatchEvent("dialogs_multiupdate",e),this.dialogsStorage.setDialogToState(o)}}},this.onUpdateReadHistory=e=>{const t=e.channel_id,s=ee.Z.generateMessageId(e.max_id||e.read_max_id),i=ee.Z.generateMessageId(e.top_msg_id),n=t?t.toPeerId(!0):x.Z.getPeerId(e.peer),a="updateReadHistoryOutbox"===e._||"updateReadChannelOutbox"===e._||"updateReadChannelDiscussionOutbox"===e._||void 0,r=this.getMessagesStorage(n),o=(0,re.Z)(r,"desc"),d=this.getDialogOnly(n),l=e.still_unread_count;let c=0,h=0,u=!1;const p=this.getHistoryStorage(n,i);if(n.isUser()&&a&&N.Z.forceUserOnline(n),i){const e=this.threadsToReplies[n+"_"+i];if(e){const[t,s]=e.split("_");this.updateMessage(t.toPeerId(),+s,"replies_updated")}}const g=!i&&d&&this.dialogsStorage.prepareDialogUnreadCountModifying(d);for(let e=0,t=o.length;e<t;e++){const t=o[e];if(t>s)continue;const p=r.get(t);if(p.pFlags.out===a){if(!p.pFlags.unread)break;if(i){const e=p.reply_to;if(!e||(e.reply_to_top_id||e.reply_to_msg_id)!==i)continue}p.pFlags.unread&&(delete p.pFlags.unread,u||(u=!0),p.pFlags.out||i||!d||(void 0===l&&(c=--d.unread_count),p.pFlags.mentioned&&(h=--d.unread_mentions_count,this.modifyCachedMentions(n,p.mid,!1))),q.Z.cancel("msg"+t))}}if(a?p.readOutboxMaxId=s:p.readMaxId=s,!i&&d){if(a?d.read_outbox_max_id=s:d.read_inbox_max_id=s,!a){let e;void 0!==l?e=l:c<0||!this.getReadMaxIdIfUnread(n)?e=0:c&&d.top_message>s&&(e=c),void 0!==e&&(d.unread_count=e),(h<0||!d.unread_count)&&(d.unread_mentions_count=0)}g&&g(),this.dialogsStorage.processDialogForFilters(d),f.default.dispatchEvent("dialog_unread",{peerId:n}),this.dialogsStorage.setDialogToState(d)}if(u&&f.default.dispatchEvent("messages_read"),!i&&t){const e=n+"_";for(const t in this.threadsToReplies)if(0===t.indexOf(e)){const[e,s]=this.threadsToReplies[t].split("_");f.default.dispatchEvent("replies_updated",this.getMessageByPeer(e.toPeerId(),+s))}}},this.onUpdateReadMessagesContents=e=>{const t=e.channel_id,s=e.messages.map((e=>ee.Z.generateMessageId(e))),i=t?t.toPeerId(!0):this.getMessageById(s[0]).peerId;for(let e=0,t=s.length;e<t;++e){const t=s[e],n=this.getMessageByPeer(i,t);n.deleted?this.fixDialogUnreadMentionsIfNoMessage(i):n.pFlags.media_unread&&(delete n.pFlags.media_unread,this.setDialogToStateIfMessageIsTop(n),!n.pFlags.out&&n.pFlags.mentioned&&this.modifyCachedMentions(i,t,!1))}f.default.dispatchEvent("messages_media_read",{peerId:i,mids:s})},this.onUpdateChannelAvailableMessages=e=>{const t=e.channel_id.toPeerId(!0),s=this.getHistoryStorage(t).history.slice,i=ee.Z.generateMessageId(e.available_min_id),n=s.filter((e=>e<=i));e.messages=n,this.onUpdateDeleteMessages(e)},this.onUpdateDeleteMessages=e=>{const t=e.channel_id,s=e.messages.map((e=>ee.Z.generateMessageId(e))),i=t?t.toPeerId(!0):this.getMessageById(s[0]).peerId;if(!i)return;h.Z.clearCache("messages.getSearchCounters",(e=>x.Z.getPeerId(e.peer)===i));const n=new Set;for(const e of s){const t=this.getMessageByPeer(i,e),s=this.getThreadKey(t);s&&this.threadsStorage[i]&&this.threadsStorage[i][+s.split("_")[1]]&&n.add(s)}const a=this.handleDeletedMessages(i,this.getMessagesStorage(i),s),r=Array.from(n).map((e=>{const[t,s]=e.split("_");return this.getHistoryStorage(t.toPeerId(),+s)})),o=this.getHistoryStorage(i);[o].concat(r).forEach((e=>{for(const t of a.msgs)e.history.delete(t);a.count&&e.count&&(e.count=Math.max(0,e.count-a.count))})),f.default.dispatchEvent("history_delete",{peerId:i,msgs:a.msgs});const d=this.getDialogOnly(i);if(d){const e=a.unreadMentions||a.unread,t=e&&this.dialogsStorage.prepareDialogUnreadCountModifying(d);if(a.unread&&(d.unread_count=Math.max(0,d.unread_count-a.unread)),a.unreadMentions&&(d.unread_mentions_count=d.unread_count?Math.max(0,d.unread_mentions_count-a.unreadMentions):0),e&&(t(),f.default.dispatchEvent("dialog_unread",{peerId:i})),a.msgs.has(d.top_message)){const e=o.history.first;if(e.isEnd(v.D.Bottom)&&e.length){const t=e[0],s=this.getMessageByPeer(i,t);this.setDialogTopMessage(s,d)}else this.reloadConversation(i)}}},this.onUpdateChannel=e=>{const t=e.channel_id,s=t.toPeerId(!0),i=T.Z.getChat(t),n=T.Z.isInChat(t);(!!i.username||!i.pFlags.left)!=(void 0!==this.historiesStorage[s])&&(delete this.historiesStorage[s],f.default.dispatchEvent("history_forbidden",s)),!!this.getDialogOnly(s)!==n&&(n?this.reloadConversation(s):this.dialogsStorage.dropDialogOnDeletion(s)),f.default.dispatchEvent("channel_update",t)},this.onUpdateChannelReload=e=>{const t=e.channel_id.toPeerId(!0);this.dialogsStorage.dropDialog(t),delete this.historiesStorage[t],this.reloadConversation(t).then((()=>{f.default.dispatchEvent("history_reload",t)}))},this.onUpdateChannelMessageViews=e=>{const t=e.views,s=e.channel_id.toPeerId(!0),i=ee.Z.generateMessageId(e.id),n=this.getMessageByPeer(s,i);!n.deleted&&void 0!==n.views&&n.views<t&&(n.views=t,f.default.dispatchEvent("message_views",{peerId:s,mid:i,views:t}),this.setDialogToStateIfMessageIsTop(n))},this.onUpdateServiceNotification=e=>{const t=_.yF,s=t,i=this.generateTempMessageId(s),n={_:"message",id:i,from_id:x.Z.getOutputPeer(t),peer_id:x.Z.getOutputPeer(s),pFlags:{unread:!0},date:(e.inbox_date||(0,r.bz)(!0))+p.Z.serverTimeOffset,message:e.message,media:e.media,entities:e.entities};N.Z.hasUser(t)||N.Z.saveApiUsers([{_:"user",id:t,pFlags:{verified:!0},access_hash:"0",first_name:"Telegram",phone:"42777"}]),this.saveMessages([n],{isOutgoing:!0}),e.inbox_date&&(this.pendingTopMsgs[s]=i,this.onUpdateNewMessage({_:"updateNewMessage",message:n,pts:void 0,pts_count:void 0}))},this.onUpdatePinnedMessages=e=>{const t="updatePinnedChannelMessages"===e._?e.channel_id:void 0,s=t?t.toPeerId(!0):x.Z.getPeerId(e.peer),i=e.messages.map((e=>ee.Z.generateMessageId(e))),n=this.getMessagesStorage(s),a=i.filter((e=>!n.has(e)));(a.length?Promise.all(a.map((e=>this.wrapSingleMessage(s,e)))):Promise.resolve()).finally((()=>{var t;const a=null===(t=e.pFlags)||void 0===t?void 0:t.pinned;if(a)for(const e of i)n.get(e).pFlags.pinned=!0;else for(const e of i)delete n.get(e).pFlags.pinned;delete this.pinnedMessages[s],O.default.getState().then((e=>{delete e.hiddenPinnedMessages[s],f.default.dispatchEvent("peer_pinned_messages",{peerId:s,mids:i,pinned:a})}))}))},this.onUpdateNotifySettings=e=>{const{peer:t,notify_settings:s}=e;if("notifyPeer"===t._){const e=x.Z.getPeerId(t.peer),i=this.getDialogOnly(e);i&&(i.notify_settings=s,f.default.dispatchEvent("dialog_notify_settings",i),this.dialogsStorage.setDialogToState(i))}},this.onUpdateNewScheduledMessage=e=>{const t=e.message,s=this.getMessagePeer(t),i=this.scheduledMessagesStorage[s];if(i){const e=ee.Z.generateMessageId(t.id),n=this.getMessageFromStorage(i,e);this.saveMessages([t],{storage:i,isScheduled:!0});const a=this.getMessageFromStorage(i,e);n.deleted?this.checkPendingMessage(t)||f.default.dispatchEvent("scheduled_new",{peerId:s,mid:t.mid}):(this.handleEditedMessage(n,a),f.default.dispatchEvent("message_edit",{storage:i,peerId:s,mid:t.mid}))}},this.onUpdateDeleteScheduledMessages=e=>{const t=x.Z.getPeerId(e.peer),s=this.scheduledMessagesStorage[t];if(s){const i=e.messages.map((e=>ee.Z.generateMessageId(e)));this.handleDeletedMessages(t,s,i),f.default.dispatchEvent("scheduled_delete",{peerId:t,mids:i})}},this.clear(),f.default.addMultipleEventsListeners({updateMessageID:this.onUpdateMessageId,updateNewDiscussionMessage:this.onUpdateNewMessage,updateNewMessage:this.onUpdateNewMessage,updateNewChannelMessage:this.onUpdateNewMessage,updateDialogUnreadMark:this.onUpdateDialogUnreadMark,updateEditMessage:this.onUpdateEditMessage,updateEditChannelMessage:this.onUpdateEditMessage,updateMessageReactions:this.onUpdateMessageReactions,updateReadChannelDiscussionInbox:this.onUpdateReadHistory,updateReadChannelDiscussionOutbox:this.onUpdateReadHistory,updateReadHistoryInbox:this.onUpdateReadHistory,updateReadHistoryOutbox:this.onUpdateReadHistory,updateReadChannelInbox:this.onUpdateReadHistory,updateReadChannelOutbox:this.onUpdateReadHistory,updateChannelReadMessagesContents:this.onUpdateReadMessagesContents,updateReadMessagesContents:this.onUpdateReadMessagesContents,updateChannelAvailableMessages:this.onUpdateChannelAvailableMessages,updateDeleteMessages:this.onUpdateDeleteMessages,updateDeleteChannelMessages:this.onUpdateDeleteMessages,updateChannel:this.onUpdateChannel,updateChannelReload:this.onUpdateChannelReload,updateChannelMessageViews:this.onUpdateChannelMessageViews,updateServiceNotification:this.onUpdateServiceNotification,updatePinnedMessages:this.onUpdatePinnedMessages,updatePinnedChannelMessages:this.onUpdatePinnedMessages,updateNotifySettings:this.onUpdateNotifySettings,updateNewScheduledMessage:this.onUpdateNewScheduledMessage,updateDeleteScheduledMessages:this.onUpdateDeleteScheduledMessages}),f.default.addEventListener("notify_peer_type_settings",(({key:e,settings:t})=>{let s;s="notifyUsers"===e?e=>e.peerId.isUser():"notifyBroadcasts"===e?e=>e.peerId.isBroadcast():e=>x.Z.isAnyGroup(e.peerId),this.dialogsStorage.getFolderDialogs(0).concat(this.dialogsStorage.getFolderDialogs(1)).filter(s).forEach((e=>{f.default.dispatchEvent("dialog_notify_settings",e)}))})),f.default.addEventListener("webpage_updated",(({id:e,msgs:t})=>{t.forEach((({peerId:t,mid:s,isScheduled:i})=>{const n=i?this.getScheduledMessagesStorage(t):this.getMessagesStorage(t),a=this.getMessageFromStorage(n,s);a&&(a.media={_:"messageMediaWebPage",webpage:B.Z.getWebPage(e)},f.default.dispatchEvent("message_edit",{storage:n,peerId:t,mid:s}))}))})),f.default.addEventListener("draft_updated",(({peerId:e,threadId:t,draft:s})=>{if(t)return;const i=this.getDialogOnly(e);if(i){if(!t){i.draft=s;let t=!1;s||ee.Z.getServerMessageId(i.top_message)?(this.dialogsStorage.generateIndexForDialog(i),this.dialogsStorage.pushDialog(i)):(this.dialogsStorage.dropDialog(e),t=!0),f.default.dispatchEvent("dialog_draft",{peerId:e,dialog:i,drop:t,draft:s,index:i.index})}}else this.reloadConversation(e)})),f.default.addEventListener("poll_update",(({poll:e})=>{const t=R.Z.pollToMessages[e.id];if(t)for(const e of t){const[t,s]=e.split("_"),i=this.getMessageByPeer(t.toPeerId(),+s);this.setDialogToStateIfMessageIsTop(i)}})),O.default.getState().then((e=>{e.maxSeenMsgId&&(this.maxSeenId=e.maxSeenMsgId)}))}clear(){this.middleware?this.middleware.clean():this.middleware=(0,Y.k)(),this.messagesStorageByPeerId={},this.groupedMessagesStorage={},this.scheduledMessagesStorage={},this.historiesStorage={},this.threadsStorage={},this.searchesStorage={},this.pinnedMessages={},this.threadsServiceMessagesIdsStorage={},this.threadsToReplies={},this.dialogsStorage&&this.dialogsStorage.clear(),this.filtersStorage&&this.filtersStorage.clear()}construct(){this.filtersStorage=new A(this,x.Z,N.Z,q.Z,O.default,D.Z,f.default),this.dialogsStorage=new b(this,T.Z,x.Z,N.Z,j.Z,q.Z,O.default,D.Z,p.Z,ee.Z)}getInputEntities(e){const t=(0,k.Z)(e);return t.forEach((e=>{"messageEntityMentionName"===e._&&(e._="inputMessageEntityMentionName",e.user_id=N.Z.getUserInput(e.user_id))})),t}invokeAfterMessageIsSent(e,t,s){var i,n;const r=null!==(i=this.tempFinalizeCallbacks[e])&&void 0!==i?i:this.tempFinalizeCallbacks[e]={},o=null!==(n=r[t])&&void 0!==n?n:r[t]={deferred:(0,a.b)()};return o.callback=s,o.deferred}editMessage(e,t,s={}){const{mid:i,peerId:n}=e;if(e.pFlags.is_outgoing)return this.invokeAfterMessageIsSent(i,"edit",(e=>this.editMessage(e,t,s)));let a=s.entities||[];t&&(t=g.o.parseMarkdown(t,a));const r=s.scheduleDate||(e.pFlags.is_scheduled?e.date:void 0);return h.Z.invokeApi("messages.editMessage",{peer:x.Z.getInputPeerById(n),id:e.id,message:t,media:s.newMedia,entities:a.length?this.getInputEntities(a):void 0,no_webpage:s.noWebPage,schedule_date:r}).then((e=>{D.Z.processUpdateMessage(e)}),(e=>{if(this.log.error("editMessage error:",e),!e||"MESSAGE_NOT_MODIFIED"!==e.type)return e&&"MESSAGE_EMPTY"===e.type&&(e.handled=!0),Promise.reject(e);e.handled=!0}))}sendText(e,t,s={}){if(!t.trim())return Promise.resolve();s.threadId&&!s.replyToMsgId&&(s.replyToMsgId=s.threadId);const i=f.default.config.message_length_max;if(t.length>i){const n=ce(t,i);t=n[0],n.length>1&&delete s.webPage;for(let t=1;t<n.length;++t)setTimeout((()=>{this.sendText(e,n[t],s)}),t)}e=x.Z.getPeerMigratedTo(e)||e;let n=s.entities||[];s.viaBotId||(t=g.o.parseMarkdown(t,n));let a=this.getInputEntities(n);a.length||(a=void 0);const r=this.generateOutgoingMessage(e,s);r.entities=n,r.message=t;const o=s.replyToMsgId?ee.Z.getServerMessageId(s.replyToMsgId):void 0,d=x.Z.isChannel(e);s.webPage&&(r.media={_:"messageMediaWebPage",webpage:s.webPage});const l=e=>{e?r.error=!0:delete r.error,f.default.dispatchEvent("messages_pending")};return r.send=()=>{l(!1);const i={};this.pendingAfterMsgs[e]&&(i.afterMessageId=this.pendingAfterMsgs[e].messageId);const n=s.sendAsPeerId?x.Z.getInputPeerById(s.sendAsPeerId):void 0;let c;return c=s.viaBotId?h.Z.invokeApiAfter("messages.sendInlineBotResult",{peer:x.Z.getInputPeerById(e),random_id:r.random_id,reply_to_msg_id:o||void 0,query_id:s.queryId,id:s.resultId,clear_draft:s.clearDraft,send_as:n},i):h.Z.invokeApiAfter("messages.sendMessage",{no_webpage:s.noWebPage,peer:x.Z.getInputPeerById(e),message:t,random_id:r.random_id,reply_to_msg_id:o||void 0,entities:a,clear_draft:s.clearDraft,schedule_date:s.scheduleDate||void 0,silent:s.silent,send_as:n},i),this.pendingAfterMsgs[e]=i,c.then((e=>{if("updateShortSentMessage"===e._){const t=r.promise;delete r.promise;const i=(0,k.Z)(r);r.promise=t,i.date=e.date,i.id=e.id,i.media=e.media,i.entities=e.entities,this.wrapMessageEntities(i),e.pFlags.out&&(i.pFlags.out=!0),e={_:"updates",users:[],chats:[],seq:0,date:void 0,updates:[{_:"updateMessageID",random_id:r.random_id,id:i.id},{_:s.scheduleDate?"updateNewScheduledMessage":d?"updateNewChannelMessage":"updateNewMessage",message:i,pts:e.pts,pts_count:e.pts_count}]}}else e.updates&&e.updates.forEach((e=>{"updateDraftMessage"===e._&&(e.local=!0)}));D.Z.processUpdateMessage(e),r.promise.resolve()}),(e=>{l(!0),r.promise.reject(e)})).finally((()=>{this.pendingAfterMsgs[e]===i&&delete this.pendingAfterMsgs[e]}))},this.beforeMessageSending(r,{isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft}),r.promise}sendFile(e,t,s={}){e=x.Z.getPeerMigratedTo(e)||e;const i=this.generateOutgoingMessage(e,s),r=s.replyToMsgId?ee.Z.getServerMessageId(s.replyToMsgId):void 0;let d,l;const c="mime_type"in t?t.mime_type:t.type,u=t instanceof File?t.name:"",p=!(t instanceof File||t instanceof Blob);let m=s.caption||"";this.log("sendFile",t,c);const v=s.entities||[];m&&(m=g.o.parseMarkdown(m,v));const _=[],y=te.Z.has(c);let I,P,S;if(p)d="document",l="";else if(0===c.indexOf("audio/")||["video/ogg"].indexOf(c)>=0){d="audio",l="audio."+("ogg"===c.split("/")[1]?"ogg":"mp3"),S="sendMessageUploadAudioAction",s.isVoiceMessage&&(d="voice",i.pFlags.media_unread=!0);let e={_:"documentAttributeAudio",pFlags:{voice:s.isVoiceMessage},waveform:s.waveform,duration:s.duration||0};_.push(e)}else if(s.isMedia)if(y){d="photo",l="photo."+c.split("/")[1],S="sendMessageUploadPhotoAction";const e={_:"photoSize",w:s.width,h:s.height,type:"full",location:null,size:t.size};I={_:"photo",id:""+i.id,sizes:[e],w:s.width,h:s.height};const n=U.Z.getCacheContext(I,e.type);n.downloaded=t.size,n.url=s.objectURL||"",I=L.Z.savePhoto(I)}else if(se.Z.has(c)){d="video",l="video.mp4",S="sendMessageUploadVideoAction";const e={_:"documentAttributeVideo",pFlags:{round_message:s.isRoundMessage,supports_streaming:!0},duration:s.duration,w:s.width,h:s.height};_.push(e),s.noSound&&t.size>10240&&t.size<10485760&&_.push({_:"documentAttributeAnimated"})}else d="document",l="document."+c.split("/")[1],S="sendMessageUploadDocumentAction";else d="document",l="document."+c.split("/")[1],S="sendMessageUploadDocumentAction";if(_.push({_:"documentAttributeFilename",file_name:u||l}),-1!==["document","video","audio","voice"].indexOf(d)&&!p){const e=[];P={_:"document",id:""+i.id,duration:s.duration,attributes:_,w:s.width,h:s.height,thumbs:e,mime_type:c,size:t.size};const n=U.Z.getCacheContext(P);let a;if(n.downloaded=t.size,n.url=s.objectURL||"",y)_.push({_:"documentAttributeImageSize",w:s.width,h:s.height}),a={_:"photoSize",w:s.width,h:s.height,type:"full",size:t.size};else if("video"===d&&s.thumb){a={_:"photoSize",w:s.thumb.size.width,h:s.thumb.size.height,type:"local-thumb",size:s.thumb.blob.size};const e=U.Z.getCacheContext(P,a.type);e.downloaded=a.size,e.url=s.thumb.url}a&&e.push(a),P=F.Z.saveDoc(P)}this.log("sendFile",d,l,t.type,s);const M=p?void 0:new n.Z({attachMethod:"prepend",tryAgainOnFail:!1,isUpload:!0}),w=(0,a.b)();M&&(M.attachPromise(w),w.cancel=()=>{const e=new Error("Download canceled");e.name="AbortError",w.reject(e)},w.catch((t=>{"AbortError"!==t.name||b||(this.log("cancelling upload",C),this.cancelPendingMessage(i.random_id),this.setTyping(e,{_:"sendMessageCancelAction"}),(null==k?void 0:k.cancel)&&k.cancel())})));const C=p?void 0:{_:I?"messageMediaPhoto":"messageMediaDocument",pFlags:{},preloader:M,photo:I,document:P,promise:w};i.entities=v,i.message=m,i.media=p?{_:"messageMediaDocument",pFlags:{},document:t}:C;const Z=e=>{e?i.error=!0:delete i.error,f.default.dispatchEvent("messages_pending")};let b=!1,k=null;return i.send=()=>{if(p){const{id:e,access_hash:s,file_reference:i}=t,n={_:"inputMediaDocument",id:{_:"inputDocument",id:e,access_hash:s,file_reference:i}};w.resolve(n)}else if(t instanceof File||t instanceof Blob){const n=()=>{let n;return b&&!i.error||(b=!1,k=U.Z.upload(t),w.notifyAll({done:0,total:t.size})),"video"===d&&s.objectURL&&(n=new Promise(((e,t)=>{(s.thumb&&s.thumb.blob?Promise.resolve(s.thumb):(0,o.ud)(s.objectURL)).then((s=>{s?U.Z.upload(s.blob).then(e,t):e(null)}),t)}))),k&&k.then((e=>he(this,void 0,void 0,(function*(){let t;if(delete i.media.preloader,e.name=l,b=!0,t="photo"===d?{_:"inputMediaUploadedPhoto",file:e}:{_:"inputMediaUploadedDocument",file:e,mime_type:c,pFlags:{force_file:"sendMessageUploadDocumentAction"===S||void 0},attributes:_},n)try{const e=yield n;t.thumb=e}catch(e){this.log.error("sendFile thumb upload error:",e)}w.resolve(t)}))),(()=>{Z(!0)})),k.addNotifyListener((t=>{const s=Math.max(1,Math.floor(100*t.done/t.total));S&&this.setTyping(e,{_:S,progress:0|s}),w.notifyAll(t)})),w};s.isGroupedItem?n():this.sendSmthLazyLoadQueue.push({load:n})}return w},this.beforeMessageSending(i,{isGroupedItem:s.isGroupedItem,isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft}),s.isGroupedItem||(w.then((t=>(this.setTyping(e,{_:"sendMessageCancelAction"}),h.Z.invokeApi("messages.sendMedia",{background:s.background,peer:x.Z.getInputPeerById(e),media:t,message:m,random_id:i.random_id,reply_to_msg_id:r,schedule_date:s.scheduleDate,silent:s.silent,entities:v,clear_draft:s.clearDraft,send_as:s.sendAsPeerId?x.Z.getInputPeerById(s.sendAsPeerId):void 0}).then((e=>{D.Z.processUpdateMessage(e)}),(e=>{if("photo"===d&&400===e.code&&("PHOTO_INVALID_DIMENSIONS"===e.type||"PHOTO_SAVE_FILE_INVALID"===e.type))return e.handled=!0,d="document",void i.send();throw Z(!0),e}))))),w.then(i.promise.resolve,i.promise.reject)),{message:i,promise:w}}sendAlbum(e,t,s={}){return he(this,void 0,void 0,(function*(){if(s.threadId&&!s.replyToMsgId&&(s.replyToMsgId=s.threadId),1===t.length)return this.sendFile(e,t[0],Object.assign(Object.assign({},s),s.sendFileDetails[0]));e=x.Z.getPeerMigratedTo(e)||e;const i=s.replyToMsgId?ee.Z.getServerMessageId(s.replyToMsgId):void 0;let n=s.caption||"",r=s.entities||[];n&&(n=g.o.parseMarkdown(n,r)),this.log("sendAlbum",t,s);const o=""+ ++this.groupedTempId,d=t.map(((t,a)=>{const d=s.sendFileDetails[a],l=Object.assign({isGroupedItem:!0,isMedia:s.isMedia,scheduleDate:s.scheduleDate,silent:s.silent,replyToMsgId:i,threadId:s.threadId,sendAsPeerId:s.sendAsPeerId,groupId:o},d);return 0===a&&(l.caption=n,l.entities=r),this.sendFile(e,t,l).message}));s.clearDraft&&setTimeout((()=>{j.Z.clearDraft(e,s.threadId)}),0);const l=(e,t)=>{t?e.error=!0:delete e.error,f.default.dispatchEvent("messages_pending")},c=x.Z.getInputPeerById(e),u=t=>{this.setTyping(e,{_:"sendMessageCancelAction"});const n=(0,a.b)();return this.sendSmthLazyLoadQueue.push({load:()=>h.Z.invokeApi("messages.sendMultiMedia",{peer:c,multi_media:t,reply_to_msg_id:i,schedule_date:s.scheduleDate,silent:s.silent,clear_draft:s.clearDraft,send_as:s.sendAsPeerId?x.Z.getInputPeerById(s.sendAsPeerId):void 0}).then((e=>{D.Z.processUpdateMessage(e),n.resolve()}),(e=>{d.forEach((e=>l(e,!0))),n.reject(e)}))}),n},p=d.map((e=>e.send().then((e=>h.Z.invokeApi("messages.uploadMedia",{peer:c,media:e}))).then((t=>{let s;if("messageMediaPhoto"===t._){const e=L.Z.savePhoto(t.photo);s=L.Z.getMediaInput(e)}else if("messageMediaDocument"===t._){const e=F.Z.saveDoc(t.document);s=F.Z.getMediaInput(e)}const i={_:"inputSingleMedia",media:s,random_id:e.random_id,message:n,entities:r};return n&&(n="",r=[]),i})).catch((t=>{if("AbortError"===t.name)return null;throw this.log.error("sendAlbum upload item error:",t,e),l(e,!0),t}))));return Promise.all(p).then((e=>u(e.filter(Boolean))))}))}sendContact(e,t){return this.sendOther(e,N.Z.getContactMediaInput(t))}sendOther(e,t,s={}){var i;e=x.Z.getPeerMigratedTo(e)||e;const n=this.generateOutgoingMessage(e,s),a=s.replyToMsgId?ee.Z.getServerMessageId(s.replyToMsgId):void 0;let r;switch(t._){case"inputMediaPoll":{const e=""+n.id;t.poll.id=e,R.Z.savePoll(t.poll,{_:"pollResults",flags:4,total_voters:0,pFlags:{},recent_voters:[]});const{poll:s,results:i}=R.Z.getPoll(e);r={_:"messageMediaPoll",poll:s,results:i};break}case"inputMediaPhoto":r={_:"messageMediaPhoto",photo:L.Z.getPhoto(t.id.id)};break;case"inputMediaDocument":r={_:"messageMediaDocument",document:F.Z.getDoc(t.id.id)};break;case"inputMediaContact":r={_:"messageMediaContact",phone_number:t.phone_number,first_name:t.first_name,last_name:t.last_name,user_id:null!==(i=t.user_id)&&void 0!==i?i:"0",vcard:t.vcard};break;case"inputMediaGeoPoint":r={_:"messageMediaGeo",geo:s.geoPoint};break;case"inputMediaVenue":r={_:"messageMediaVenue",geo:s.geoPoint,title:t.title,address:t.address,provider:t.provider,venue_id:t.venue_id,venue_type:t.venue_type};break;case"messageMediaPending":r=t}return n.media=r,n.send=()=>{const i={};this.pendingAfterMsgs[e]&&(i.afterMessageId=this.pendingAfterMsgs[e].messageId);const r=s.sendAsPeerId?x.Z.getInputPeerById(s.sendAsPeerId):void 0;let o;return o=s.viaBotId?h.Z.invokeApiAfter("messages.sendInlineBotResult",{peer:x.Z.getInputPeerById(e),random_id:n.random_id,reply_to_msg_id:a||void 0,query_id:s.queryId,id:s.resultId,clear_draft:s.clearDraft,schedule_date:s.scheduleDate,silent:s.silent,send_as:r},i):h.Z.invokeApiAfter("messages.sendMedia",{peer:x.Z.getInputPeerById(e),media:t,random_id:n.random_id,reply_to_msg_id:a||void 0,message:"",clear_draft:s.clearDraft,schedule_date:s.scheduleDate,silent:s.silent,send_as:r},i),this.pendingAfterMsgs[e]=i,o.then((e=>{e.updates&&e.updates.forEach((e=>{"updateDraftMessage"===e._&&(e.local=!0)})),D.Z.processUpdateMessage(e)}),(e=>{f.default.dispatchEvent("messages_pending")})).finally((()=>{this.pendingAfterMsgs[e]===i&&delete this.pendingAfterMsgs[e]}))},this.beforeMessageSending(n,{isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft}),n.promise}beforeMessageSending(e,t={}){const s=e.id,i=this.getMessagePeer(e),n=t.isScheduled?this.getScheduledMessagesStorage(i):this.getMessagesStorage(i);if(t.isScheduled)this.saveMessages([e],{storage:n,isScheduled:!0,isOutgoing:!0}),setTimeout((()=>{f.default.dispatchEvent("scheduled_new",{peerId:i,mid:s})}),0);else{const a=[this.getHistoryStorage(i),t.threadId?this.getHistoryStorage(i,t.threadId):void 0];for(const e of a)e&&e.history.unshift(s);this.saveMessages([e],{storage:n,isOutgoing:!0}),this.setDialogTopMessage(e),setTimeout((()=>{f.default.dispatchEvent("history_append",{storage:n,peerId:i,mid:s})}),0)}this.pendingByRandomId[e.random_id]={peerId:i,tempId:s,threadId:t.threadId,storage:n},!t.isGroupedItem&&e.send&&setTimeout((()=>{t.clearDraft&&j.Z.clearDraft(i,t.threadId),e.send()}),0)}generateOutgoingMessage(e,t){let s;t.threadId&&!t.replyToMsgId&&(t.replyToMsgId=t.threadId);const i=x.Z.isBroadcast(e);if(i&&x.Z.getPeer(e).pFlags.signatures){const e=N.Z.getSelf();s=e.first_name+(e.last_name?" "+e.last_name:"")}return{_:"message",id:this.generateTempMessageId(e),from_id:t.sendAsPeerId?x.Z.getOutputPeer(t.sendAsPeerId):this.generateFromId(e),peer_id:x.Z.getOutputPeer(e),post_author:s,pFlags:this.generateFlags(e),date:t.scheduleDate||(0,r.bz)(!0)+p.Z.serverTimeOffset,message:"",grouped_id:t.groupId,random_id:(0,d.a)(),reply_to:this.generateReplyHeader(t.replyToMsgId,t.threadId),via_bot_id:t.viaBotId,reply_markup:t.replyMarkup,replies:this.generateReplies(e),views:i&&1,pending:!0,promise:void 0===t.groupId?(0,a.b)():void 0}}generateReplyHeader(e,t){const s={_:"messageReplyHeader",reply_to_msg_id:e||t};return t&&s.reply_to_msg_id!==t&&(s.reply_to_top_id=t),s}generateReplies(e){let t;if(x.Z.isBroadcast(e)){const s=H.default.getCachedFullChat(e.toChatId());(null==s?void 0:s.linked_chat_id)&&(t={_:"messageReplies",flags:1,pFlags:{comments:!0},channel_id:s.linked_chat_id,replies:0,replies_pts:0})}return t}generateFromId(e){return e.isAnyChat()&&(e.isBroadcast()||this.isAnonymousSending(e))?void 0:x.Z.getOutputPeer(N.Z.getSelf().id.toPeerId())}generateFlags(e){const t={};return e!==N.Z.getSelf().id&&(t.out=!0,x.Z.isChannel(e)||N.Z.isBot(e)||(t.unread=!0)),x.Z.isBroadcast(e)&&(t.post=!0),t}generateForwardHeader(e,t){const s=N.Z.getSelf().id.toPeerId(),i=t.fromId;if(i===s&&t.peerId===s&&!t.fwd_from)return;const n={_:"messageFwdHeader",flags:0,date:t.date};let a=!1;if(t.fwd_from)n.from_id=t.fwd_from.from_id,n.from_name=t.fwd_from.from_name,n.post_author=t.fwd_from.post_author;else{if(n.post_author=t.post_author,i.isUser()){const e=H.default.getCachedFullUser(i.toUserId());(null==e?void 0:e.private_forward_name)&&(n.from_name=e.private_forward_name,a=!0)}a||(n.from_id=x.Z.getOutputPeer(i))}return x.Z.isBroadcast(t.peerId)&&(t.post_author&&(n.post_author=t.post_author),n.channel_post=t.id),e!==s||a||(n.saved_from_msg_id=t.id,n.saved_from_peer=x.Z.getOutputPeer(t.peerId)),n}generateFakeAvatarMessage(e,t){const s=Number.MAX_SAFE_INTEGER,i={_:"messageService",pFlags:{},action:{_:"messageActionChannelEditPhoto",photo:t},id:s,peer_id:x.Z.getOutputPeer(e),mid:s,peerId:e,date:t.date,fromId:e};return this.getMessagesStorage(e).set(s,i),i}isAnonymousSending(e){var t,s;return e.isAnyChat()&&(null===(s=null===(t=x.Z.getPeer(e).admin_rights)||void 0===t?void 0:t.pFlags)||void 0===s?void 0:s.anonymous)}setDialogTopMessage(e,t=this.getDialogOnly(e.peerId)){t&&(t.top_message=e.mid,this.getHistoryStorage(e.peerId).maxId=e.mid,this.dialogsStorage.generateIndexForDialog(t,!1,e),this.scheduleHandleNewDialogs(e.peerId,t))}cancelPendingMessage(e){const t=this.pendingByRandomId[e];if(t){const{peerId:s,tempId:i,storage:n}=t,a=this.getHistoryStorage(s);return D.Z.processLocalUpdate({_:"updateDeleteMessages",messages:[i],pts:void 0,pts_count:void 0}),a.history.delete(i),delete this.pendingByRandomId[e],n.delete(i),!0}return!1}fillConversations(){return he(this,void 0,void 0,(function*(){const e=this.middleware.get();for(;!this.dialogsStorage.isDialogsLoaded(Z);){const t=yield this.getTopMessages(100,Z);if(!e()||t.isEnd)break}}))}getConversations(e="",t,s,i=0,n){return this.dialogsStorage.getDialogs(e,t,s,i,n)}getReadMaxIdIfUnread(e,t){var s;const i=this.getHistoryStorage(e,t);if(t){const t=this.getHistoryStorage(e),n=Math.max(null!==(s=t.readMaxId)&&void 0!==s?s:0,i.readMaxId);return!this.getMessageByPeer(e,i.maxId).pFlags.out&&n<i.maxId?n:0}{const t=this.getMessageByPeer(e,i.maxId),s=e.isUser()?Math.max(i.readMaxId,i.readOutboxMaxId):i.readMaxId;return!t.pFlags.out&&s<i.maxId?s:0}}getTopMessages(e,t,s){let i=0;void 0===s&&(s=this.dialogsStorage.getOffsetDate(t)),s&&(i=65536*s,s+=p.Z.serverTimeOffset);const n=this.middleware.get(),a={folder_id:t,offset_date:s,offset_id:0,offset_peer:x.Z.getInputPeerById(undefined),limit:100,hash:"0"};return h.Z.invokeApiSingle("messages.getDialogs",a,{noErrorBox:!0}).then((r=>{if(!n()||"messages.dialogsNotModified"===r._)return null;z.ZP&&this.log("messages.getDialogs result:",r.dialogs,Object.assign({},r.dialogs[0])),s||t===Z||this.dialogsStorage.resetPinnedOrder(t),s||Q.default.setAuthorized(!0),N.Z.saveApiUsers(r.users),T.Z.saveApiChats(r.chats),this.saveMessages(r.messages);let o=!!s,d=!1;const l={},c=t===Z?0:t,h=t===Z;(0,P.Z)(r.dialogs,(e=>{void 0===e.folder_id&&(e.folder_id=c),this.dialogsStorage.saveDialog(e,void 0,!0,h),o||x.Z.isChannel(e.peerId||x.Z.getPeerId(e.peer))||(this.incrementMaxSeenId(e.top_message),o=!0),void 0!==e.peerId&&(i&&e.index>i&&(this.scheduleHandleNewDialogs(e.peerId,e),d=!0),ee.Z.getServerMessageId(e.read_inbox_max_id)||ee.Z.getServerMessageId(e.read_outbox_max_id)||(l[e.peerId]=e,this.log.error("noIdsDialogs",e,a)))}));const u=Object.keys(l);if(u.length){const e=u.map((e=>e.toPeerId())),t=e.map((e=>this.reloadConversation(e)));Promise.all(t).then((()=>{f.default.dispatchEvent("dialogs_multiupdate",l);for(let t=0;t<e.length;++t)f.default.dispatchEvent("dialog_unread",{peerId:e[t]})}))}const p=r.count,g=this.dialogsStorage.getFolderDialogs(t,!1);let m=0;for(let e=0,t=g.length;e<t;++e)ee.Z.getServerMessageId(g[e].top_message)&&++m;const v=!p||m>=p||!r.dialogs.length;v&&this.dialogsStorage.setDialogsLoaded(t,!0),d?this.scheduleHandleNewDialogs():f.default.dispatchEvent("dialogs_multiupdate",{});const _=r.dialogs,y=100===e?_:_.slice(0,e);return{isEnd:v&&y[y.length-1]===_[_.length-1],count:p,dialogs:y}}))}forwardMessages(e,t,s,i={}){e=x.Z.getPeerMigratedTo(e)||e;for(let n=0,a=(s=s.slice().sort(((e,t)=>e-t))).length;n<a;++n){const a=s[n],r=this.getMessageByPeer(t,a);r.pFlags.is_outgoing&&(this.sendText(e,r.message,{entities:r.entities,scheduleDate:i.scheduleDate,silent:i.silent}),s.splice(n--,1))}if(!s.length)return Promise.resolve();i.dropCaptions&&(i.dropAuthor=!0);const n={},a=s.map((s=>{var a,r,o;const d=this.getMessageByPeer(t,s),l=this.generateOutgoingMessage(e,i),c=["entities","media"];i.dropAuthor||(l.fwd_from=this.generateForwardHeader(e,d),c.push("views","forwards"),(null===(a=l.fwd_from)||void 0===a?void 0:a.from_name)&&e===f.default.myId&&delete l.from_id),i.dropCaptions&&d.media||c.push("message"),c.forEach((e=>{l[e]=d[e]}));const h=null===(r=l.media)||void 0===r?void 0:r.document;return h&&["round","voice"].includes(h.type)&&(l.pFlags.media_unread=!0),d.grouped_id&&(null!==(o=n[d.grouped_id])&&void 0!==o?o:n[d.grouped_id]={tempId:""+ ++this.groupedTempId,messages:[]}).messages.push(l),l}));for(const e in n){const t=n[e];t.messages.length>1&&t.messages.forEach((e=>{e.grouped_id=t.tempId}))}a.forEach((e=>{this.beforeMessageSending(e,{isScheduled:!!i.scheduleDate||void 0})}));const r={};this.pendingAfterMsgs[e]&&(r.afterMessageId=this.pendingAfterMsgs[e].messageId);const o=h.Z.invokeApiAfter("messages.forwardMessages",{from_peer:x.Z.getInputPeerById(t),id:s.map((e=>ee.Z.getServerMessageId(e))),random_id:a.map((e=>e.random_id)),to_peer:x.Z.getInputPeerById(e),with_my_score:i.withMyScore,silent:i.silent,schedule_date:i.scheduleDate,drop_author:i.dropAuthor,drop_media_captions:i.dropCaptions,send_as:i.sendAsPeerId?x.Z.getInputPeerById(i.sendAsPeerId):void 0},r).then((e=>{this.log("forwardMessages updates:",e),D.Z.processUpdateMessage(e)})).finally((()=>{this.pendingAfterMsgs[e]===r&&delete this.pendingAfterMsgs[e]}));return this.pendingAfterMsgs[e]=r,o}generateEmptyMessage(e){return{_:"messageEmpty",id:ee.Z.getServerMessageId(e),mid:e,deleted:!0,pFlags:{}}}getMessageFromStorage(e,t){return e&&e.get(t)||this.generateEmptyMessage(t)}createMessageStorage(){return new Map}getMessagesStorage(e){var t;return null!==(t=this.messagesStorageByPeerId[e])&&void 0!==t?t:this.messagesStorageByPeerId[e]=this.createMessageStorage()}getMessageById(e){for(const t in this.messagesStorageByPeerId){if(x.Z.isChannel(t.toPeerId()))continue;const s=this.messagesStorageByPeerId[t].get(e);if(s)return s}return this.getMessageFromStorage(null,e)}getMessageByPeer(e,t){return e?this.getMessageFromStorage(this.getMessagesStorage(e),t):this.getMessageById(t)}getMessagePeer(e){return e.peer_id&&x.Z.getPeerId(e.peer_id)||_.NM}getDialogByPeerId(e){return this.dialogsStorage.getDialog(e)}getDialogOnly(e){return this.dialogsStorage.getDialogOnly(e)}reloadConversation(e){let t;if(void 0!==e){const s=x.Z.getPeerId(e);let i=this.reloadConversationsPeers.get(s);if(i&&(t=i.promise),t)return t;t=(0,a.b)(),this.reloadConversationsPeers.set(s,i={inputDialogPeer:x.Z.getInputDialogPeerById(e),promise:t})}return this.reloadConversationsPromise||(this.reloadConversationsPromise=new Promise(((e,t)=>{setTimeout((()=>{const s=[],i={};for(const[e,{inputDialogPeer:t,promise:n}]of this.reloadConversationsPeers)s.push(t),i[e]=n;this.reloadConversationsPeers.clear();const n=()=>{for(const e in i)i[e].resolve(void 0)};h.Z.invokeApi("messages.getPeerDialogs",{peers:s}).then((t=>{this.dialogsStorage.applyDialogs(t),t.dialogs.forEach((e=>{const t=e.peerId;t&&(i[t].resolve(e),delete i[t])})),n(),e()}),(e=>{n(),t(e)})).finally((()=>{this.reloadConversationsPromise=null,this.reloadConversationsPeers.size&&this.reloadConversation()}))}),0)}))),t||this.reloadConversationsPromise}doFlushHistory(e,t,s){return h.Z.invokeApiSingle("messages.deleteHistory",{just_clear:t,revoke:s,peer:e,max_id:0}).then((i=>(D.Z.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:i.pts,pts_count:i.pts_count}}),!i.offset||this.doFlushHistory(e,t,s))))}flushHistory(e,t,s){return he(this,void 0,void 0,(function*(){if(x.Z.isChannel(e)){const t=this.getHistory(e,0,1),s=t instanceof Promise?yield t:t,i=e.toChatId(),n=s.history[0]||0;return h.Z.invokeApiSingle("channels.deleteHistory",{channel:T.Z.getChannelInput(i),max_id:ee.Z.getServerMessageId(n)}).then((e=>(e&&D.Z.processLocalUpdate({_:"updateChannelAvailableMessages",channel_id:i,available_min_id:n}),e)))}return this.doFlushHistory(x.Z.getInputPeerById(e),t,s).then((()=>{[this.historiesStorage,this.threadsStorage,this.searchesStorage,this.pinnedMessages,this.pendingAfterMsgs,this.pendingTopMsgs].forEach((t=>{delete t[e]}));const s=this.needSingleMessages.get(e);if(s&&s.clear(),[this.messagesStorageByPeerId,this.scheduledMessagesStorage].forEach((t=>{const s=t[e];s&&s.clear()})),t)f.default.dispatchEvent("dialog_flush",{peerId:e});else{delete this.notificationsToHandle[e],delete this.typings[e];const t=this.reloadConversationsPeers.get(e);t&&(this.reloadConversationsPeers.delete(e),t.promise.resolve(void 0)),this.dialogsStorage.dropDialogOnDeletion(e)}}))}))}onPeerDeleted(e){}hidePinnedMessages(e){return Promise.all([O.default.getState(),this.getPinnedMessage(e)]).then((([t,s])=>{t.hiddenPinnedMessages[e]=s.maxId,f.default.dispatchEvent("peer_pinned_hidden",{peerId:e,maxId:s.maxId})}))}getPinnedMessage(e){var t;const s=null!==(t=this.pinnedMessages[e])&&void 0!==t?t:this.pinnedMessages[e]={};return s.promise?s.promise:s.maxId?Promise.resolve(s):s.promise=this.getSearch({peerId:e,inputFilter:{_:"inputMessagesFilterPinned"},maxId:0,limit:1}).then((e=>{var t;return s.count=e.count,s.maxId=null===(t=e.history[0])||void 0===t?void 0:t.mid,s})).finally((()=>{delete s.promise}))}updatePinnedMessage(e,t,s,i,n){return h.Z.invokeApi("messages.updatePinnedMessage",{peer:x.Z.getInputPeerById(e),unpin:s,silent:i,pm_oneside:n,id:ee.Z.getServerMessageId(t)}).then((e=>{D.Z.processUpdateMessage(e)}))}unpinAllMessages(e){return h.Z.invokeApiSingle("messages.unpinAllMessages",{peer:x.Z.getInputPeerById(e)}).then((t=>(D.Z.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:t.pts,pts_count:t.pts_count}}),t.offset?this.unpinAllMessages(e):(this.getMessagesStorage(e).forEach((e=>{e.pFlags.pinned&&delete e.pFlags.pinned})),f.default.dispatchEvent("peer_pinned_messages",{peerId:e,unpinAll:!0}),delete this.pinnedMessages[e],!0))))}getAlbumText(e){const t=this.groupedMessagesStorage[e];let s,i,n,a=0;for(const[e,r]of t)if(r.message){if(++a>1)break;s=r.message,i=r.totalEntities,n=r.entities}return a>1&&(s=void 0,i=void 0,n=void 0),{message:s,entities:n,totalEntities:i}}getGroupsFirstMessage(e){if(!e.grouped_id)return e;const t=this.groupedMessagesStorage[e.grouped_id];let s=Number.MAX_SAFE_INTEGER;for(const[e,i]of t)i.mid<s&&(s=i.mid);return t.get(s)}getMidsByAlbum(e){return(0,re.Z)(this.groupedMessagesStorage[e],"asc")}getMidsByMessage(e){return(null==e?void 0:e.grouped_id)?this.getMidsByAlbum(e.grouped_id):[e.mid]}filterMessages(e,t){const s=[];if(e.grouped_id){const i=this.groupedMessagesStorage[e.grouped_id];for(const[e,n]of i)t(n)&&s.push(n)}else t(e)&&s.push(e);return s}generateTempMessageId(e){const t=this.getDialogOnly(e);return ee.Z.generateMessageId((null==t?void 0:t.top_message)||0,!0)}saveMessage(e,t={}){var s,i;if(void 0===e.pFlags&&(e.pFlags={}),"messageEmpty"===e._)return void(e.deleted=!0);const n=this.getMessagePeer(e),a=t.storage||this.getMessagesStorage(n),r="peerChannel"===e.peer_id._,o=r&&T.Z.isBroadcast(n.toChatId()),d="message"===e._;t.isOutgoing&&(e.pFlags.is_outgoing=!0);const l=ee.Z.generateMessageId(e.id);e.mid=l,d&&(t.isScheduled&&(e.pFlags.is_scheduled=!0),e.grouped_id&&(null!==(s=this.groupedMessagesStorage[e.grouped_id])&&void 0!==s?s:this.groupedMessagesStorage[e.grouped_id]=new Map).set(l,e),e.via_bot_id&&(e.viaBotId=e.via_bot_id));const c=this.getDialogOnly(n);c&&l&&l>c[e.pFlags.out?"read_outbox_max_id":"read_inbox_max_id"]&&(e.pFlags.unread=!0),e.reply_to&&(e.reply_to.reply_to_msg_id&&(e.reply_to.reply_to_msg_id=e.reply_to_mid=ee.Z.generateMessageId(e.reply_to.reply_to_msg_id)),e.reply_to.reply_to_top_id&&(e.reply_to.reply_to_top_id=ee.Z.generateMessageId(e.reply_to.reply_to_top_id))),d&&e.replies&&(e.replies.max_id&&(e.replies.max_id=ee.Z.generateMessageId(e.replies.max_id)),e.replies.read_max_id&&(e.replies.read_max_id=ee.Z.generateMessageId(e.replies.read_max_id)));const h=!!n;h||(e.date-=p.Z.serverTimeOffset);const u=N.Z.getSelf().id.toPeerId(),g=d&&e.fwd_from;if(e.peerId=n,e.fromId=n===u?g?g.from_id?x.Z.getPeerId(g.from_id):_.NM:u:e.pFlags.post||!e.from_id?n:x.Z.getPeerId(e.from_id),g){g.saved_from_msg_id&&(g.saved_from_msg_id=ee.Z.generateMessageId(g.saved_from_msg_id)),g.channel_post&&(g.channel_post=ee.Z.generateMessageId(g.channel_post));const t=g.saved_from_peer||g.from_id,s=g.saved_from_msg_id||g.channel_post;if(t&&s){const i=x.Z.getPeerId(t),n=ee.Z.generateMessageId(s);e.savedFrom=i+"_"+n}e.fwdFromId=x.Z.getPeerId(g.from_id),h||(g.date-=p.Z.serverTimeOffset)}const f={type:"message",peerId:n,messageId:l};if(d&&e.media){let s=!1;switch(e.media._){case"messageMediaEmpty":delete e.media;break;case"messageMediaPhoto":e.media.ttl_seconds?s=!0:e.media.photo=L.Z.savePhoto(e.media.photo,f),e.media.photo||delete e.media;break;case"messageMediaPoll":{const t=R.Z.savePoll(e.media.poll,e.media.results,e);e.media.poll=t.poll,e.media.results=t.results;break}case"messageMediaDocument":if(e.media.ttl_seconds)s=!0;else{const t=e.media.document;e.media.document=F.Z.saveDoc(t,f),e.media.document||"documentEmpty"===t._||(s=!0)}break;case"messageMediaWebPage":{const s=B.Z.getMessageKeyForPendingWebPage(n,l,t.isScheduled);e.media.webpage=B.Z.saveWebPage(e.media.webpage,s,f);break}case"messageMediaInvoice":s=!0,e.media={_:"messageMediaUnsupported"};break;case"messageMediaUnsupported":s=!0}s&&(e.media={_:"messageMediaUnsupported"},e.message="",delete e.entities,delete e.totalEntities)}if(!d&&e.action){const t=e.action;let s,a;const d=e.fromId===N.Z.getSelf().id?"You":"";switch(t.photo&&(t.photo=L.Z.savePhoto(t.photo,f)),t.document&&(t.document=F.Z.saveDoc(t.photo,f)),t._){case"messageActionChatEditPhoto":(null===(i=t.photo)||void 0===i?void 0:i.video_sizes)?t._=o?"messageActionChannelEditVideo":"messageActionChatEditVideo":o&&(t._="messageActionChannelEditPhoto");break;case"messageActionGroupCall":{let e;ie.Z.saveGroupCall(t.call),e=void 0===t.duration?"started":"ended",o||(e+="_by"+d),t.type=e;break}case"messageActionChatEditTitle":o&&(t._="messageActionChannelEditTitle");break;case"messageActionChatDeletePhoto":o&&(t._="messageActionChannelDeletePhoto");break;case"messageActionChatAddUser":1===t.users.length?(t.user_id=t.users[0],e.fromId===t.user_id&&(t._=r?"messageActionChatJoined"+d:"messageActionChatReturn"+d)):t.users.length>1&&(t._="messageActionChatAddUsers");break;case"messageActionChatDeleteUser":e.fromId===t.user_id&&(t._="messageActionChatLeave"+d);break;case"messageActionChannelMigrateFrom":s=t.chat_id.toPeerId(!0),a=n;break;case"messageActionChatMigrateTo":s=n,a=t.channel_id.toPeerId(!0);break;case"messageActionHistoryClear":e.clear_history=!0,delete e.pFlags.out,delete e.pFlags.unread;break;case"messageActionPhoneCall":t.type=(t.pFlags.video?"video_":"")+(void 0!==t.duration?e.pFlags.out?"out_":"in_":"")+(void 0!==t.duration?"ok":"phoneCallDiscardReasonMissed"===t.reason._?"missed":"cancelled")}s&&a&&!this.migratedFromTo[s]&&!this.migratedToFrom[a]&&this.migrateChecks(s,a)}d&&e.message.length&&!e.totalEntities&&this.wrapMessageEntities(e),a.set(l,e)}saveMessages(e,t={}){e.saved||(e.saved=!0,e.forEach((e=>{this.saveMessage(e,t)})))}wrapMessageEntities(e){const t=e.entities?e.entities.slice():[];e.message=g.o.fixEmoji(e.message,t);const s=g.o.parseEntities(e.message);e.totalEntities=g.o.mergeEntities(t,s)}wrapMessageForReply(e,t=e.message,s,i,n,a){const r=[];let o=!1;const d=(e,t)=>{if(e){if(void 0===t&&o)return;t=i?l.default.format(e,!0):(0,l.i18n)(e)}if(i)r.push(t);else{const e=document.createElement("i");"string"==typeof t?e.innerHTML=t:e.append(t),r.push(e)}},c=this.isRestricted(e);let h=e.totalEntities;if(e.media&&!c){(0,X.Z)(e);let n=!0;if(e.grouped_id){if(s){const t=this.getMidsByMessage(e);if(s.length===t.length){for(const e of t)if(!s.includes(e)){n=!1;break}}else n=!1}if(n){const s=this.getAlbumText(e.grouped_id);t=s.message,h=s.totalEntities,a||(d("AttachAlbum"),o=!0)}}else n=!1;if(!n&&!a||!t){const s=e.media;switch(s._){case"messageMediaPhoto":d("AttachPhoto");break;case"messageMediaDice":d(void 0,i?s.emoticon:g.o.wrapEmojiText(s.emoticon));break;case"messageMediaVenue":t=s.title,d("AttachLocation");break;case"messageMediaGeo":d("AttachLocation");break;case"messageMediaGeoLive":d("AttachLiveLocation");break;case"messageMediaPoll":d(void 0,i?"📊 "+(s.poll.question||"poll"):s.poll.rReply);break;case"messageMediaContact":d("AttachContact");break;case"messageMediaGame":{const e="🎮 "+s.game.title;d(void 0,i?e:g.o.wrapEmojiText(e));break}case"messageMediaDocument":{const e=s.document;if("video"===e.type)d("AttachVideo");else if("voice"===e.type)d("AttachAudio");else if("gif"===e.type)d("AttachGif");else if("round"===e.type)d("AttachRound");else if("sticker"===e.type)e.stickerEmojiRaw&&d(void 0,(i?e.stickerEmojiRaw:e.stickerEmoji)+" "),d("AttachSticker"),t="";else if("audio"===e.type){const t=e.attributes.find((e=>"documentAttributeAudio"===e._&&(e.title||e.performer))),s="🎵 "+(t?[t.title,t.performer].filter(Boolean).join(" - "):e.file_name);d(void 0,i?s:g.o.wrapEmojiText(s))}else d(void 0,i?e.file_name:g.o.wrapEmojiText(e.file_name));break}case"messageMediaUnsupported":d(l.UNSUPPORTED_LANG_PACK_KEY)}}const c=r.length;t&&c&&r.push(", ")}if(e.action){const t=this.wrapMessageActionTextNew(e,i);t&&d(void 0,t)}if(c&&(t=(0,ae.RP)(e.restriction_reason).text,h=[]),t)if(t=(0,le.Z)(t,100),h||(h=[]),i)r.push(g.o.wrapPlainText(t,h));else{if(n){n=n.trim();let e,s=!1,i=new RegExp((0,de.Z)(n),"gi");for(;null!==(e=i.exec(t));)h.push({_:"messageEntityHighlight",length:n.length,offset:e.index}),s=!0;s&&g.o.sortEntities(h)}const e=g.o.wrapRichText(t,{noLinebreaks:!0,entities:h,noLinks:!0,noTextFormat:!0});r.push((0,W.Z)(e))}if(i)return r.join("");{const e=document.createDocumentFragment();return e.append(...r),e}}wrapSenderToPeer(e){const t=document.createElement("span");t.classList.add("sender-title");const s=e.fromId===f.default.myId&&e.peerId!==f.default.myId;if(t.append(s?(0,l.i18n)("FromYou"):new V.Z(Object.assign(Object.assign({},this.getMessageSenderPeerIdOrName(e)),{dialog:e.peerId===f.default.myId})).element),x.Z.isAnyGroup(e.peerId)||s){const s=new V.Z({peerId:e.peerId}).element;t.append(" ➝ ",s)}return t}getMessageSenderPeerIdOrName(e){var t;return e.fromId?{peerId:e.fromId}:{fromName:null===(t=e.fwd_from)||void 0===t?void 0:t.from_name}}wrapSentTime(e){const t=document.createElement("span");return t.classList.add("sent-time"),t.append((0,r.zM)(new Date(1e3*e.date))),t}wrapJoinVoiceChatAnchor(e){const t=e.action,{onclick:s,url:i}=g.o.wrapUrl(`tg://voicechat?chat_id=${e.peerId.toChatId()}&id=${t.call.id}&access_hash=${t.call.access_hash}`);if(!s)return document.createElement("span");const n=document.createElement("a");return n.href=i,n.setAttribute("onclick",s+"(this)"),n}wrapMessageActionTextNewUnsafe(e,t){const s=t?void 0:document.createElement("span"),i="action"in e&&e.action;if(i.message){const e=i.message;return t?g.o.wrapPlainText(e):(s.innerHTML=g.o.wrapRichText(e,{noLinebreaks:!0}),s)}{let n,a,o=i._;const d=(e,t)=>t?x.Z.getPeerTitle(e,t):new V.Z({peerId:e}).element;switch(i._){case"messageActionPhoneCall":o+="."+i.type,a=[(0,K.Z)(i.duration,t)];break;case"messageActionGroupCall":o+="."+i.type,a=[],o.endsWith("You")||e.pFlags.post||a.push(d(e.fromId,t)),void 0!==i.duration?a.push((0,K.Z)(i.duration,t)):a.push(this.wrapJoinVoiceChatAnchor(e));break;case"messageActionInviteToGroupCall":{const s=[e.fromId,i.users[0].toPeerId()];let r="Chat.Service.VoiceChatInvitation";const o=N.Z.getSelf().id;s[0]===o?r+="ByYou":s[1]===o&&(r+="ForYou"),(0,S.Z)(s,o),n=r,a=s.map((e=>d(e,t))),a.push(this.wrapJoinVoiceChatAnchor(e));break}case"messageActionGroupCallScheduled":{const s=new Date,o=new Date(1e3*i.schedule_date),c=(o.getTime()-s.getTime())/864e5,h=new Date(s);h.setDate(h.getDate()+1);const u=x.Z.isBroadcast(e.peerId);n=u?"ChatList.Service.VoiceChatScheduled.Channel":"ChatList.Service.VoiceChatScheduled",a=[];const p=N.Z.getSelf().id;e.fromId===p?n+="You":u||a.push(d(e.fromId,t));let g,f=[];c<1&&o.getDate()===s.getDate()?g="TodayAtFormattedWithToday":c<2&&o.getDate()===h.getDate()?g="Time.TomorrowAt":(g="formatDateAtTime",f.push(new l.default.IntlDateElement({date:o,options:{day:"2-digit",month:"2-digit",year:"2-digit"}}).element)),f.push((0,r.mr)(o));const m=(0,l.i18n)(g,f);a.push(m);break}case"messageActionChatCreate":{const s=N.Z.getSelf().id;e.fromId===s?o+="You":a=[d(e.fromId,t)];break}case"messageActionPinMessage":{const s=e.peerId,i=this.getMessageByPeer(s,e.reply_to_mid);if(a=[d(e.fromId,t)],i.deleted)n="ActionPinnedNoText",e.reply_to_mid&&this.fetchMessageReplyTo(e).then((t=>{t.deleted||e.deleted||(f.default.dispatchEvent("message_edit",{storage:this.getMessagesStorage(s),peerId:s,mid:e.mid}),this.isMessageIsTopMessage(e)&&f.default.dispatchEvent("dialogs_multiupdate",{[s]:this.getDialogOnly(s)}))}));else{const e=document.createElement("i");e.dataset.savedFrom=i.peerId+"_"+i.mid,e.dir="auto",e.append(this.wrapMessageForReply(i,void 0,void 0,t)),a.push(e)}break}case"messageActionChatJoinedByRequest":{const s=x.Z.isBroadcast(e.peerId);e.pFlags.out?n=s?"RequestToJoinChannelApproved":"RequestToJoinGroupApproved":(n=s?"ChatService.UserJoinedChannelByRequest":"ChatService.UserJoinedGroupByRequest",a=[d(e.fromId,t)]);break}case"messageActionContactSignUp":case"messageActionChatReturn":case"messageActionChatLeave":case"messageActionChatJoined":case"messageActionChatEditPhoto":case"messageActionChatDeletePhoto":case"messageActionChatEditVideo":case"messageActionChatJoinedByLink":case"messageActionChannelEditVideo":case"messageActionChannelDeletePhoto":a=[d(e.fromId,t)];break;case"messageActionChannelEditTitle":case"messageActionChatEditTitle":a=[],"messageActionChatEditTitle"===i._&&a.push(d(e.fromId,t)),a.push(t?i.title:(0,$.Z)(g.o.wrapEmojiText(i.title)));break;case"messageActionChatDeleteUser":case"messageActionChatAddUsers":case"messageActionChatAddUser":{const s=i.users||[i.user_id];if(a=[d(e.fromId,t)],s.length>1){const e=(0,l.join)(s.map((e=>d(e.toPeerId(),t))),!1,t);if(t)a.push(...e);else{const t=document.createElement("span");t.append(...e),a.push(t)}}else a.push(d(s[0].toPeerId(),t));break}case"messageActionBotAllowed":{const e=g.o.wrapRichText(i.domain,{entities:[{_:"messageEntityUrl",length:i.domain.length,offset:0}]});a=[(0,$.Z)(e)];break}default:n=l.langPack[o]||`[${i._}]`}return n||(n=l.langPack[o],void 0===n&&(n="["+o+"]")),t?l.default.format(n,!0,a):(0,l._i18n)(s,n,a)}}wrapMessageActionTextNew(e,t){try{return this.wrapMessageActionTextNewUnsafe(e,t)}catch(e){return this.log.error("wrapMessageActionTextNewUnsafe error:",e),t?"":document.createElement("span")}}reportMessages(e,t,s,i){return h.Z.invokeApiSingle("messages.report",{peer:x.Z.getInputPeerById(e),id:t.map((e=>ee.Z.getServerMessageId(e))),reason:{_:s},message:i})}startBot(e,t,s){const i=t?t.toPeerId(!0):e.toPeerId();if(s){const t=(0,d.a)();return h.Z.invokeApi("messages.startBot",{bot:N.Z.getUserInput(e),peer:x.Z.getInputPeerById(i),random_id:t,start_param:s}).then((e=>{D.Z.processUpdateMessage(e)}))}const n="/start";if(t){let s;return s=T.Z.isChannel(t)?T.Z.inviteToChannel(t,[e]):T.Z.addChatUser(t,e,0),s.catch((e=>{if(!e||"USER_ALREADY_PARTICIPANT"!=e.type)throw e;e.handled=!0})).then((()=>{const t=N.Z.getUser(e);return this.sendText(i,n+"@"+t.username)}))}return this.sendText(i,n)}editPeerFolders(e,t){h.Z.invokeApi("folders.editPeerFolders",{folder_peers:e.map((e=>({_:"inputFolderPeer",peer:x.Z.getInputPeerById(e),folder_id:t})))}).then((e=>{D.Z.processUpdateMessage(e)}))}toggleDialogPin(e,t){var s;if(t>1)return this.filtersStorage.toggleDialogPin(e,t);const i=this.getDialogOnly(e);if(!i)return Promise.reject();const n=!(null===(s=i.pFlags)||void 0===s?void 0:s.pinned)||void 0;if(n){const e=1===t?f.default.config.pinned_infolder_count_max:f.default.config.pinned_dialogs_count_max;if(this.dialogsStorage.getPinnedOrders(t).length>=e)return Promise.reject({type:"PINNED_DIALOGS_TOO_MUCH"})}return h.Z.invokeApi("messages.toggleDialogPin",{peer:x.Z.getInputDialogPeerById(e),pinned:n}).then((s=>{if(s){const s=n?{pinned:n}:{};D.Z.saveUpdate({_:"updateDialogPinned",peer:x.Z.getDialogPeer(e),folder_id:t,pFlags:s})}}))}markDialogUnread(e,t){var s;const i=this.getDialogOnly(e);if(!i)return Promise.reject();const n=!t&&!(null===(s=i.pFlags)||void 0===s?void 0:s.unread_mark)||void 0;return h.Z.invokeApi("messages.markDialogUnread",{peer:x.Z.getInputDialogPeerById(e),unread:n}).then((t=>{if(t){const t=n?{unread:n}:{};this.onUpdateDialogUnreadMark({_:"updateDialogUnreadMark",peer:x.Z.getDialogPeer(e),pFlags:t})}}))}migrateChecks(e,t){if(!this.migratedFromTo[e]&&!this.migratedToFrom[t]&&T.Z.hasChat(t.toChatId())){const s=T.Z.getChat(e.toChatId());s&&s.migrated_to&&s.migrated_to.channel_id===t.toChatId()&&(this.migratedFromTo[e]=t,this.migratedToFrom[t]=e,f.default.dispatchEvent("dialog_migrate",{migrateFrom:e,migrateTo:t}),this.dialogsStorage.dropDialogWithEvent(e))}}canMessageBeEdited(e,t){if(e.pFlags.is_outgoing)return!1;const s=["messageMediaPhoto","messageMediaDocument","messageMediaWebPage"];return"poll"===t&&s.push("messageMediaPoll"),!("message"!==e._||e.deleted||e.fwd_from||e.via_bot_id||e.media&&-1===s.indexOf(e.media._)||e.fromId&&N.Z.isBot(e.fromId)||e.media&&"messageMediaDocument"===e.media._&&(e.media.document.sticker||"round"===e.media.document.type))}canEditMessage(e,t="text"){var s;return!(!e||!this.canMessageBeEdited(e,t)||this.getMessagePeer(e)!==N.Z.getSelf().id&&(!e.pFlags.out||"peerChannel"!==e.peer_id._&&e.date<(0,r.bz)(!0)-f.default.config.edit_time_limit&&"messageMediaPoll"!==(null===(s=e.media)||void 0===s?void 0:s._)))}canDeleteMessage(e){return e&&(e.peerId.isUser()||e.pFlags.out||"chat"===T.Z.getChat(e.peerId.toChatId())._||T.Z.hasRights(e.peerId.toChatId(),"delete_messages"))&&!e.pFlags.is_outgoing}getReplyKeyboard(e){return this.getHistoryStorage(e).replyMarkup}mergeReplyKeyboard(e,t){var s,i;let n=t.reply_markup;if(!n&&!(null===(s=t.pFlags)||void 0===s?void 0:s.out)&&!t.action)return!1;if("replyInlineMarkup"===(null==n?void 0:n._))return!1;const a=e.replyMarkup;if(n)return!(a&&a.mid>=t.mid||n.pFlags.selective||(e.maxOutId&&t.mid<e.maxOutId&&n.pFlags.single_use&&(n.pFlags.hidden=!0),n.mid=t.mid,"replyKeyboardHide"!==n._&&(n.fromId=x.Z.getPeerId(t.from_id)),e.replyMarkup=n,0));if(t.pFlags.out)if(a){if((0,X.Z)(a),a.pFlags.single_use&&!a.pFlags.hidden&&(t.mid>a.mid||t.pFlags.is_outgoing)&&t.message)return a.pFlags.hidden=!0,!0}else(!e.maxOutId||t.mid>e.maxOutId)&&(e.maxOutId=t.mid);return(0,X.Z)(t),!("messageActionChatDeleteUser"!==(null===(i=t.action)||void 0===i?void 0:i._)||!(a?t.action.user_id===a.fromId:N.Z.isBot(t.action.user_id))||(e.replyMarkup={_:"replyKeyboardHide",mid:t.mid,pFlags:{}},0))}getSearchStorage(e,t){return this.searchesStorage[e]||(this.searchesStorage[e]={}),this.searchesStorage[e][t]||(this.searchesStorage[e][t]={history:[]}),this.searchesStorage[e][t]}getSearchCounters(e,t,s=!0){return x.Z.isRestricted(e)?Promise.resolve(t.map((e=>({_:"messages.searchCounter",pFlags:{},filter:e,count:0})))):(s?h.Z.invokeApiCacheable:h.Z.invokeApi).bind(h.Z)("messages.getSearchCounters",{peer:x.Z.getInputPeerById(e),filters:t})}filterMessagesByInputFilter(e,t,s,i){const n=[];if(!t.length)return n;let a=!0;const r={},o=[],d=[];switch(e){case"inputMessagesFilterPhotos":r.messageMediaPhoto=!0;break;case"inputMessagesFilterPhotoVideo":r.messageMediaPhoto=!0,r.messageMediaDocument=!0,o.push("video");break;case"inputMessagesFilterVideo":r.messageMediaDocument=!0,o.push("video");break;case"inputMessagesFilterDocument":r.messageMediaDocument=!0,d.push("video");break;case"inputMessagesFilterVoice":r.messageMediaDocument=!0,o.push("voice");break;case"inputMessagesFilterRoundVoice":r.messageMediaDocument=!0,o.push("round","voice");break;case"inputMessagesFilterRoundVideo":r.messageMediaDocument=!0,o.push("round");break;case"inputMessagesFilterMusic":r.messageMediaDocument=!0,o.push("audio");break;case"inputMessagesFilterUrl":r.url=!0;break;case"inputMessagesFilterChatPhotos":r.avatar=!0;break;default:a=!1}if(!a)return n;for(let e=0,a=t.length;e<a;++e){const a=s.get(t[e]);if(!a)continue;let l=!1;if("message"===a._){if(a.media&&r[a.media._]){const e=a.media.document;if(e&&(o.length&&!o.includes(e.type)||d.includes(e.type)))continue;l=!0}else if(r.url&&a.message){const e=["messageEntityTextUrl","messageEntityUrl"];(a.totalEntities.find((t=>e.includes(t._)))||g.o.matchUrl(a.message))&&(l=!0)}}else r.avatar&&a.action&&["messageActionChannelEditPhoto","messageActionChatEditPhoto","messageActionChannelEditVideo","messageActionChatEditVideo"].includes(a.action._)&&(l=!0);if(l&&(n.push(a),n.length>=i))break}return n}getSearch({peerId:e,query:t,inputFilter:s,maxId:i,limit:n,nextRate:a,backLimit:r,threadId:o,folderId:d,minDate:l,maxDate:c}){if(x.Z.isRestricted(e))return Promise.resolve({count:0,offset_id_offset:0,next_rate:void 0,history:[]});t||(t=""),s||(s={_:"inputMessagesFilterEmpty"}),void 0===n&&(n=20),a||(a=0),r||(r=0),l=l?l/1e3|0:0,c=c?c/1e3|0:0;let u=[];r&&(n+=r);let p;if(!e||r||i||t||1===n||o||(p=this.getHistoryStorage(e),u=this.filterMessagesByInputFilter(s._,p.history.slice,this.getMessagesStorage(e),n)),u.length){if(!(u.length<n))return Promise.resolve({count:0,next_rate:0,offset_id_offset:0,history:u});i=u[u.length-1].mid,n-=u.length}const g=h.Z.invokeApi.bind(h.Z);let f;if(e&&!a&&void 0===d)f=g("messages.search",{peer:x.Z.getInputPeerById(e),q:t||"",filter:s,min_date:l,max_date:c,limit:n,offset_id:ee.Z.getServerMessageId(i)||0,add_offset:r?-r:0,max_id:0,min_id:0,hash:"",top_msg_id:ee.Z.getServerMessageId(o)||0},{noErrorBox:!0});else{let r,o=0,h=i&&this.getMessageByPeer(e,i);h&&h.date&&(o=h.id,r=this.getMessagePeer(h)),f=g("messages.searchGlobal",{q:t,filter:s,min_date:l,max_date:c,offset_rate:a,offset_peer:x.Z.getInputPeerById(r),offset_id:o,limit:n,folder_id:d},{noErrorBox:!0})}return f.then((e=>{N.Z.saveApiUsers(e.users),T.Z.saveApiChats(e.chats),this.saveMessages(e.messages),z.ZP&&this.log("getSearch result:",s,e);const t=e.count||u.length+e.messages.length;return e.messages.forEach((e=>{const t=this.getMessagePeer(e);if(t.isAnyChat()){const e=T.Z.getChat(t.toChatId());e.migrated_to&&this.migrateChecks(t,e.migrated_to.channel_id.toPeerId(!0))}u.push(e)})),{count:t,offset_id_offset:e.offset_id_offset||0,next_rate:e.next_rate,history:u}}))}subscribeRepliesThread(e,t){const s=e+"_"+t;for(const e in this.threadsToReplies)if(this.threadsToReplies[e]===s)return;this.getDiscussionMessage(e,t)}generateThreadServiceStartMessage(e){const t=e.peerId+"_"+e.mid;if(this.threadsServiceMessagesIdsStorage[t])return;const s=ee.Z.getServerMessageId(Math.max(...this.getMidsByMessage(e))),i={_:"messageService",pFlags:{is_single:!0},id:ee.Z.generateMessageId(s,!0),date:e.date,from_id:{_:"peerUser",user_id:_.NM},peer_id:e.peer_id,action:{_:"messageActionDiscussionStarted"},reply_to:this.generateReplyHeader(e.id)};this.saveMessages([i],{isOutgoing:!0}),this.threadsServiceMessagesIdsStorage[t]=i.mid}getDiscussionMessage(e,t){return h.Z.invokeApiSingle("messages.getDiscussionMessage",{peer:x.Z.getInputPeerById(e),msg_id:ee.Z.getServerMessageId(t)}).then((s=>{var i;T.Z.saveApiChats(s.chats),N.Z.saveApiUsers(s.users),this.saveMessages(s.messages);const n=this.filterMessages(s.messages[0],(e=>!!e.replies))[0],a=n.peerId+"_"+n.mid;this.generateThreadServiceStartMessage(n);const r=this.getHistoryStorage(n.peerId,n.mid);return s.max_id=r.maxId=ee.Z.generateMessageId(s.max_id)||0,s.read_inbox_max_id=r.readMaxId=ee.Z.generateMessageId(null!==(i=s.read_inbox_max_id)&&void 0!==i?i:n.mid),s.read_outbox_max_id=r.readOutboxMaxId=ee.Z.generateMessageId(s.read_outbox_max_id)||0,this.threadsToReplies[a]=e+"_"+t,n}))}handleNewMessage(e,t){void 0===this.newMessagesToHandle[e]&&(this.newMessagesToHandle[e]=new Set),this.newMessagesToHandle[e].add(t),this.newMessagesHandleTimeout||(this.newMessagesHandleTimeout=window.setTimeout(this.handleNewMessages,0))}scheduleHandleNewDialogs(e,t){return void 0!==e&&(this.newDialogsToHandle[e]=t),this.newDialogsHandlePromise?this.newDialogsHandlePromise:this.newDialogsHandlePromise=new Promise((e=>{setTimeout((()=>{e(),this.newDialogsHandlePromise=void 0,this.handleNewDialogs()}),0)}))}deleteMessages(e,t,s){var i,n;let a;const r=t.map((e=>ee.Z.getServerMessageId(e)));if(e.isAnyChat()&&x.Z.isChannel(e)){const s=e.toChatId(),o=T.Z.getChat(s);if(!o.pFlags.creator&&!(null===(n=null===(i=o.admin_rights)||void 0===i?void 0:i.pFlags)||void 0===n?void 0:n.delete_messages)&&!(t=t.filter((t=>!!this.getMessageByPeer(e,t).pFlags.out))).length)return;a=h.Z.invokeApi("channels.deleteMessages",{channel:T.Z.getChannelInput(s),id:r}).then((e=>{D.Z.processLocalUpdate({_:"updateDeleteChannelMessages",channel_id:s,messages:t,pts:e.pts,pts_count:e.pts_count})}))}else a=h.Z.invokeApi("messages.deleteMessages",{revoke:s,id:r}).then((e=>{D.Z.processLocalUpdate({_:"updateDeleteMessages",messages:t,pts:e.pts,pts_count:e.pts_count})}));return a}readHistory(e,t=0,s,i=!1){if(this.log("readHistory:",e,t,s),!this.getReadMaxIdIfUnread(e,s)&&!i)return this.log("readHistory: isn't unread"),Promise.resolve();const n=this.getHistoryStorage(e,s);if(n.triedToReadMaxId>=t)return Promise.resolve();let a;return s?(n.readPromise||(a=h.Z.invokeApi("messages.readDiscussion",{peer:x.Z.getInputPeerById(e),msg_id:ee.Z.getServerMessageId(s),read_max_id:ee.Z.getServerMessageId(t)})),D.Z.processLocalUpdate({_:"updateReadChannelDiscussionInbox",channel_id:e.toChatId(),top_msg_id:s,read_max_id:t})):x.Z.isChannel(e)?(n.readPromise||(a=h.Z.invokeApi("channels.readHistory",{channel:T.Z.getChannelInput(e.toChatId()),max_id:ee.Z.getServerMessageId(t)})),D.Z.processLocalUpdate({_:"updateReadChannelInbox",max_id:t,channel_id:e.toChatId(),still_unread_count:void 0,pts:void 0})):(n.readPromise||(a=h.Z.invokeApi("messages.readHistory",{peer:x.Z.getInputPeerById(e),max_id:ee.Z.getServerMessageId(t)}).then((e=>{D.Z.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:e.pts,pts_count:e.pts_count}})}))),D.Z.processLocalUpdate({_:"updateReadHistoryInbox",max_id:t,peer:x.Z.getOutputPeer(e),still_unread_count:void 0,pts:void 0,pts_count:void 0})),q.Z.soundReset(x.Z.getPeerString(e)),n.readPromise?n.readPromise:(n.triedToReadMaxId=t,a.finally((()=>{delete n.readPromise;const{readMaxId:i}=n;this.log("readHistory: promise finally",t,i),i>t&&this.readHistory(e,i,s,!0)})),n.readPromise=a)}readAllHistory(e,t,s=!1){const i=this.getHistoryStorage(e,t);i.maxId&&this.readHistory(e,i.maxId,t,s)}fixDialogUnreadMentionsIfNoMessage(e){const t=this.getDialogOnly(e);(null==t?void 0:t.unread_mentions_count)&&this.reloadConversation(e)}modifyCachedMentions(e,t,s){const i=this.unreadMentions[e];i&&(s?i.first.isEnd(v.D.Top)&&i.insertSlice([t]):i.delete(t))}fixUnreadMentionsCountIfNeeded(e,t){const s=this.getDialogOnly(e);!t.length&&(null==s?void 0:s.unread_mentions_count)&&this.reloadConversation(e)}goToNextMention(e){var t;const s=this.goToNextMentionPromises[e];if(s)return s;const i=null!==(t=this.unreadMentions[e])&&void 0!==t?t:this.unreadMentions[e]=new v.Z,n=i.length,a=i.first.isEnd(v.D.Top);if(!n&&a)return this.fixUnreadMentionsCountIfNeeded(e,i),Promise.resolve();let r=Promise.resolve();return!a&&n<25&&(r=this.loadNextMentions(e)),this.goToNextMentionPromises[e]=r.then((()=>{const t=i.last,s=t&&t[t.length-1];s?(i.delete(s),f.default.dispatchEvent("history_focus",{peerId:e,mid:s})):this.fixUnreadMentionsCountIfNeeded(e,i)})).finally((()=>{delete this.goToNextMentionPromises[e]}))}loadNextMentions(e){const t=this.unreadMentions[e],s=t.first[0]||1;return this.getUnreadMentions(e,s,-50,50).then((e=>{this.mergeHistoryResult(t,e,1===s?0:s,50,-50)}))}getUnreadMentions(e,t,s,i,n=0,a=0){return h.Z.invokeApiSingle("messages.getUnreadMentions",{peer:x.Z.getInputPeerById(e),offset_id:ee.Z.getServerMessageId(t),add_offset:s,limit:i,max_id:ee.Z.getServerMessageId(n),min_id:ee.Z.getServerMessageId(a)}).then((e=>((0,X.Z)(e),N.Z.saveApiUsers(e.users),T.Z.saveApiChats(e.chats),this.saveMessages(e.messages),e)))}readMessages(e,t){if(!t.length)return Promise.resolve();let s,i;if(t=t.map((e=>ee.Z.getServerMessageId(e))),e.isAnyChat()&&x.Z.isChannel(e)){const n=e.toChatId();i={_:"updateChannelReadMessagesContents",channel_id:n,messages:t},s=h.Z.invokeApi("channels.readMessageContents",{channel:T.Z.getChannelInput(n),id:t})}else i={_:"updateReadMessagesContents",messages:t,pts:void 0,pts_count:void 0},s=h.Z.invokeApi("messages.readMessageContents",{id:t}).then((e=>{i.pts=e.pts,i.pts_count=e.pts_count,D.Z.processLocalUpdate(i)}));return D.Z.processLocalUpdate(i),s}getHistoryStorage(e,t){var s,i;return t?(this.threadsStorage[e]||(this.threadsStorage[e]={}),null!==(s=this.threadsStorage[e][t])&&void 0!==s?s:this.threadsStorage[e][t]={count:null,history:new v.Z}):null!==(i=this.historiesStorage[e])&&void 0!==i?i:this.historiesStorage[e]={count:null,history:new v.Z}}getNotifyPeerSettings(e){return Promise.all([q.Z.getNotifyPeerTypeSettings(),q.Z.getNotifySettings(x.Z.getInputNotifyPeerById(e,!0))]).then((([t,s])=>({muted:q.Z.isPeerLocalMuted(e,!0),peerTypeNotifySettings:s})))}setDialogToStateIfMessageIsTop(e){this.isMessageIsTopMessage(e)&&this.dialogsStorage.setDialogToState(this.getDialogOnly(e.peerId))}isMessageIsTopMessage(e){const t=this.getDialogOnly(e.peerId);return t&&t.top_message===e.mid}updateMessageRepliesIfNeeded(e){try{const t=this.getThreadKey(e);if(t){const e=this.threadsToReplies[t];if(e){const[t,s]=e.split("_");this.updateMessage(t.toPeerId(),+s,"replies_updated")}}}catch(t){this.log.error("incrementMessageReplies err",t,e)}}getThreadKey(e){var t;let s="";if((null===(t=e.peerId)||void 0===t?void 0:t.isAnyChat())&&e.reply_to){const t=e.reply_to.reply_to_top_id||e.reply_to.reply_to_msg_id;s=e.peerId+"_"+t}return s}updateMessage(e,t,s){return this.wrapSingleMessage(e,t,!0).then((()=>{const i=this.getMessageByPeer(e,t);return s&&f.default.dispatchEvent(s,i),i}))}checkPendingMessage(e){const t=this.pendingByMessageId[e.mid];let s;if(t){const i=this.pendingByRandomId[t];(s=this.finalizePendingMessage(t,e))&&f.default.dispatchEvent("history_update",{storage:i.storage,peerId:e.peerId,mid:e.mid}),delete this.pendingByMessageId[e.mid]}return s}mutePeer(e,t){const s={_:"inputPeerNotifySettings"};return s.mute_until=t,q.Z.updateNotifySettings({_:"inputNotifyPeer",peer:x.Z.getInputPeerById(e)},s)}togglePeerMute(e,t){return void 0===t&&(t=!q.Z.isPeerLocalMuted(e,!1)),this.mutePeer(e,t?_.rU:0)}canSendToPeer(e,t,s="send_messages"){if(x.Z.isRestricted(e))return!1;if(e.isAnyChat()){const i=T.Z.getChat(e.toChatId());return T.Z.hasRights(e.toChatId(),s,void 0,!!t)&&(!i.pFlags.left||!!t)}return N.Z.canSendToUser(e)}finalizePendingMessage(e,t){const s=this.pendingByRandomId[e];if(s){const{peerId:i,tempId:n,threadId:a,storage:r}=s;[this.getHistoryStorage(i),a?this.getHistoryStorage(i,a):void 0].filter(Boolean).forEach((e=>{e.history.delete(n)}));const o=this.getMessageFromStorage(r,n);return o.deleted||(delete t.pFlags.is_outgoing,delete t.pending,delete t.error,delete t.random_id,delete t.send),f.default.dispatchEvent("messages_pending"),delete this.pendingByRandomId[e],this.finalizePendingMessageCallbacks(r,n,t),o}}finalizePendingMessageCallbacks(e,t,s){const i=this.tempFinalizeCallbacks[t];if(void 0!==i){for(const e in i){const{deferred:t,callback:n}=i[e];n(s).then(t.resolve,t.reject)}delete this.tempFinalizeCallbacks[t]}if(s.media){(0,X.Z)(s);const{photo:e,document:i}=s.media;if(e){const s=L.Z.getPhoto(""+t);if(s){const t=e.sizes[e.sizes.length-1],i=U.Z.getCacheContext(e,t.type),n=U.Z.getCacheContext(s,"full");Object.assign(i,n);const a=e.sizes[e.sizes.length-1],r=L.Z.getPhotoDownloadOptions(e,a),o=(0,G.P)(r.location);U.Z.fakeDownload(o,n.url)}}else if(i){const e=F.Z.getDoc(""+t);if(e&&e.type&&"sticker"!==e.type&&"image/gif"!==e.mime_type){const t=U.Z.getCacheContext(i),s=U.Z.getCacheContext(e);Object.assign(t,s);const n=F.Z.getInputFileName(i);U.Z.fakeDownload(n,s.url)}}else s.media.poll&&(delete R.Z.polls[t],delete R.Z.results[t])}const n=this.getMessageFromStorage(e,t);e.delete(t),this.handleReleasingMessage(n,e),f.default.dispatchEvent("message_sent",{storage:e,tempId:t,tempMessage:n,mid:s.mid,message:s})}incrementMaxSeenId(e){if(!e||this.maxSeenId&&!(e>this.maxSeenId))return!1;this.maxSeenId=e,O.default.pushToState("maxSeenMsgId",e),h.Z.invokeApi("messages.receivedMessages",{max_id:ee.Z.getServerMessageId(e)})}getMessageReactionsListAndReadParticipants(e,t,s,i,n,a){var r,o;const d={reactions:[],count:0,next_offset:void 0},l=this.canViewMessageReadParticipants(e);return l&&void 0===t?t=100:void 0===t&&(t=50),Promise.all([!l||s||n?[]:this.getMessageReadParticipants(e.peerId,e.mid).catch((()=>[])),(null===(o=null===(r=e.reactions)||void 0===r?void 0:r.recent_reactions)||void 0===o?void 0:o.length)&&!a?ne.Z.getMessageReactionsList(e.peerId,e.mid,t,s,i).catch((e=>d)):d]).then((([e,t])=>{const s=e.map((e=>e.toPeerId())),i=s.slice();(0,P.Z)(i,((e,s,i)=>{t.reactions.some((t=>x.Z.getPeerId(t.peer_id)===e))&&i.splice(s,1)}));let n=t.reactions.map((e=>({peerId:x.Z.getPeerId(e.peer_id),reaction:e.reaction})));return n=n.concat(i.map((e=>({peerId:e})))),{reactions:t.reactions,reactionsCount:t.count,readParticipants:s,combined:n,nextOffset:t.next_offset}}))}getMessageReadParticipants(e,t){return h.Z.invokeApiSingle("messages.getMessageReadParticipants",{peer:x.Z.getInputPeerById(e),msg_id:ee.Z.getServerMessageId(t)}).then((e=>e.map((e=>e.toUserId()))))}canViewMessageReadParticipants(e){return!("message"!==e._||e.pFlags.is_outgoing||!e.pFlags.out||!x.Z.isAnyGroup(e.peerId))&&(T.Z.getChat(e.peerId.toChatId()).participants_count<f.default.appConfig.chat_read_mark_size_threshold&&(0,r.bz)(!0)-e.date<f.default.appConfig.chat_read_mark_expire_period)}incrementMessageViews(e,t){if(t.length)return h.Z.invokeApiSingle("messages.getMessagesViews",{peer:x.Z.getInputPeerById(e),id:t.map((e=>ee.Z.getServerMessageId(e))),increment:!0}).then((s=>{const i=new Array(t.length),n=e.toChatId();for(let e=0,a=t.length;e<a;++e)i[e]={_:"updateChannelMessageViews",channel_id:n,id:t[e],views:s.views[e].views};D.Z.processUpdateMessage({_:"updates",updates:i,chats:s.chats,users:s.users})}))}notifyAboutMessage(e,t={}){const s=this.getMessagePeer(e);if(x.Z.isRestricted(s))return;const i=s.isAnyChat(),n={},a=x.Z.getPeerString(s);let r;if(t.peerTypeNotifySettings.show_previews){if("message"===e._&&e.fwd_from&&t.fwdCount)r=l.default.format("Notifications.Forwarded",!0,[t.fwdCount]);else if(r=this.wrapMessageForReply(e,void 0,void 0,!0),t.userReaction){const e="Notification.Contact.Reacted",s=[t.userReaction.reaction,r];r=l.default.format(e,!0,s)}}else r=l.default.format("Notifications.New",!0);n.title=x.Z.getPeerTitle(s,!0),i&&e.fromId!==e.peerId&&(n.title=x.Z.getPeerTitle(e.fromId,!0)+" @ "+n.title),n.title=g.o.wrapPlainText(n.title),n.onclick=()=>{f.default.dispatchEvent("history_focus",{peerId:s,mid:e.mid})},n.message=r,n.key="msg"+e.mid,n.tag=a,n.silent=!0;const o=x.Z.getPeerPhoto(s);o?J.Z.loadAvatar(s,o,"photo_small").loadPromise.then((s=>{(e.pFlags.unread||t.userReaction)&&(n.image=s,q.Z.notify(n))})):q.Z.notify(n)}getScheduledMessagesStorage(e){var t;return null!==(t=this.scheduledMessagesStorage[e])&&void 0!==t?t:this.scheduledMessagesStorage[e]=this.createMessageStorage()}getScheduledMessageByPeer(e,t){return this.getMessageFromStorage(this.getScheduledMessagesStorage(e),t)}getScheduledMessages(e){if(!this.canSendToPeer(e))return Promise.resolve([]);const t=this.getScheduledMessagesStorage(e);return t.size?Promise.resolve([...t.keys()]):h.Z.invokeApiSingle("messages.getScheduledHistory",{peer:x.Z.getInputPeerById(e),hash:""}).then((t=>{if("messages.messagesNotModified"!==t._){N.Z.saveApiUsers(t.users),T.Z.saveApiChats(t.chats);const s=this.getScheduledMessagesStorage(e);return this.saveMessages(t.messages,{storage:s,isScheduled:!0}),[...s.keys()]}return[]}))}sendScheduledMessages(e,t){return h.Z.invokeApi("messages.sendScheduledMessages",{peer:x.Z.getInputPeerById(e),id:t.map((e=>ee.Z.getServerMessageId(e)))}).then((e=>{D.Z.processUpdateMessage(e)}))}deleteScheduledMessages(e,t){return h.Z.invokeApi("messages.deleteScheduledMessages",{peer:x.Z.getInputPeerById(e),id:t.map((e=>ee.Z.getServerMessageId(e)))}).then((e=>{D.Z.processUpdateMessage(e)}))}getMessageWithReplies(e){if(e.peerId===_.hj||(e=this.filterMessages(e,(e=>!!e.replies))[0])&&e.replies&&e.replies.pFlags.comments&&"777"!==e.replies.channel_id)return e}isFetchIntervalNeeded(e){return e.isAnyChat()&&!T.Z.isInChat(e.toChatId())}isRestricted(e){return!(!e.restriction_reason||!(0,ae.X)(e.restriction_reason))}getNewHistory(e,t){var s;return he(this,void 0,void 0,(function*(){if(!this.isFetchIntervalNeeded(e))return;const i=this.getHistoryStorage(e,t),n=i.history.slice;if(!n.isEnd(v.D.Bottom))return;delete i.maxId,n.unsetEnd(v.D.Bottom);let a=this.getHistory(e,null!==(s=n[0])&&void 0!==s?s:1,0,50,t);a instanceof Promise&&(a=yield a);for(let t=0,s=a.history.length;t<s;++t)this.handleNewMessage(e,a.history[t]);return i}))}getHistory(e,t=0,s,i,n){const a=this.getHistoryStorage(e,n);if(x.Z.isRestricted(e)){const e=a.history.first;e.setEnd(v.D.Both);const t=e.slice(0,0);return t.setEnd(v.D.Both),{count:0,history:t,offsetIdOffset:0}}let r=0;i&&(r=-i,s+=i);const o=a.history.sliceMe(t,r,s);return!o||o.slice.length!==s&&(o.fulfilled&v.D.Both)!==v.D.Both?this.fillHistoryStorage(e,t,s,r,a,n).then((()=>{const e=a.history.sliceMe(t,r,s);return{count:a.count,history:(null==e?void 0:e.slice)||a.history.constructSlice(),offsetIdOffset:(null==e?void 0:e.offsetIdOffset)||a.count}})):{count:a.count,history:o.slice,offsetIdOffset:o.offsetIdOffset}}isHistoryResultEnd(e,t,s){const{offset_id_offset:i,messages:n}=e,a=e.count||n.length,r=i||0,o=s<0?t+s:t;return{count:a,offsetIdOffset:r,isTopEnd:r>=a-o||a<o,isBottomEnd:!r||s<0&&r+s<=0}}mergeHistoryResult(e,t,s,i,n){const{messages:a}=t,r=this.isHistoryResultEnd(t,i,n),{count:o,offsetIdOffset:d,isTopEnd:l,isBottomEnd:c}=r,h=a.map((e=>e.mid));if(s&&ee.Z.getServerMessageId(s)&&!h.includes(s)&&d<o){let e=0;for(const t=h.length;e<t&&!(s>h[e]);++e);h.splice(e,0,s)}const u=e.insertSlice(h)||e.slice;return l&&u.setEnd(v.D.Top),c&&u.setEnd(v.D.Bottom),Object.assign({slice:u,mids:h,messages:a},r)}fillHistoryStorage(e,t,s,i,n,a){return this.requestHistory(e,t,s,i,void 0,a).then((a=>{const{count:r,isBottomEnd:o,slice:d,messages:l}=this.mergeHistoryResult(n.history,a,t,s,i);n.count=r;for(let t=0,s=l.length;t<s;++t){const s=l[t];this.mergeReplyKeyboard(n,s)&&f.default.dispatchEvent("history_reply_markup",{peerId:e})}o&&(n.maxId=d[0])}))}requestHistory(e,t,s=0,i=0,n=0,a=0){const r={peer:x.Z.getInputPeerById(e),offset_id:ee.Z.getServerMessageId(t)||0,offset_date:n,add_offset:i,limit:s,max_id:0,min_id:0,hash:0};return a&&(r.msg_id=ee.Z.getServerMessageId(a)||0),h.Z.invokeApiSingle(a?"messages.getReplies":"messages.getHistory",r,{noErrorBox:!0}).then((r=>{z.ZP&&this.log("requestHistory result:",e,r,t,s,i),N.Z.saveApiUsers(r.users),T.Z.saveApiChats(r.chats),this.saveMessages(r.messages),x.Z.isChannel(e)&&D.Z.addChannelState(e.toChatId(),r.pts);let o=r.messages.length,d=r.count;o&&r.messages[o-1].deleted&&(r.messages.splice(o-1,1),o--,d--);const l=this.getHistoryStorage(e,a),c=r.messages[o-1];if(o&&c.grouped_id){const t=l.history.findSlice(c.mid);if(t&&t.slice.length+r.messages.length<d)return this.requestHistory(e,c.mid,10,0,n,a).then((e=>r))}return r}),(t=>{if("CHANNEL_PRIVATE"===t.type){let t=T.Z.getChat(e.toChatId());t={_:"channelForbidden",access_hash:t.access_hash,title:t.title},D.Z.processUpdateMessage({_:"updates",updates:[{_:"updateChannel",channel_id:e.toChatId()}],chats:[t],users:[]})}throw t}))}fetchSingleMessages(){return this.fetchSingleMessagesPromise?this.fetchSingleMessagesPromise:this.fetchSingleMessagesPromise=new Promise((e=>{setTimeout((()=>{const t=[];for(const[e,s]of this.needSingleMessages){const i=[...s.keys()],n=i.map((e=>({_:"inputMessageID",id:ee.Z.getServerMessageId(e)})));let a;a=e.isAnyChat()&&x.Z.isChannel(e)?h.Z.invokeApiSingle("channels.getMessages",{channel:T.Z.getChannelInput(e.toChatId()),id:n}):h.Z.invokeApiSingle("messages.getMessages",{id:n});const r=a.then((e=>{(0,X.Z)(e),N.Z.saveApiUsers(e.users),T.Z.saveApiChats(e.chats),this.saveMessages(e.messages);for(let t=0;t<e.messages.length;++t){const i=e.messages[t],n=ee.Z.generateMessageId(i.id);s.get(n).resolve(e.messages[t]),s.delete(n)}if(s.size)for(const[e,t]of s)t.resolve(this.generateEmptyMessage(e))})).finally((()=>{f.default.dispatchEvent("messages_downloaded",{peerId:e,mids:i})}));t.push(r)}this.needSingleMessages.clear(),Promise.all(t).finally((()=>{this.fetchSingleMessagesPromise=null,this.needSingleMessages.size&&this.fetchSingleMessages(),e()}))}),0)}))}wrapSingleMessage(e,t,s=!1){const i=this.getMessageByPeer(e,t);if(i.deleted||s){let s=this.needSingleMessages.get(e);s||this.needSingleMessages.set(e,s=new Map);let i=s.get(t);return i||(i=(0,a.b)(),s.set(t,i),this.fetchSingleMessages(),i)}return f.default.dispatchEvent("messages_downloaded",{peerId:e,mids:[t]}),Promise.resolve(i)}fetchMessageReplyTo(e){if(!e.reply_to_mid)return Promise.resolve(this.generateEmptyMessage(0));const t=e.reply_to.reply_to_peer_id?x.Z.getPeerId(e.reply_to.reply_to_peer_id):e.peerId;return this.wrapSingleMessage(t,e.reply_to_mid).then((t=>(t.deleted&&delete e.reply_to_mid,t)))}setTyping(e,t,s){var i;let n=this.typings[e];return f.default.myId&&e&&this.canSendToPeer(e)&&e!==f.default.myId&&(s||(null===(i=null==n?void 0:n.action)||void 0===i?void 0:i._)!==t._)?((null==n?void 0:n.timeout)&&clearTimeout(n.timeout),n=this.typings[e]={action:t},h.Z.invokeApi("messages.setTyping",{peer:x.Z.getInputPeerById(e),action:t}).finally((()=>{n===this.typings[e]&&(n.timeout=window.setTimeout((()=>{delete this.typings[e]}),6e3))}))):Promise.resolve(!1)}handleReleasingMessage(e,t){const s=e.media;if(s){const i=s.webpage||s,n=i.photo||i.document;if((null==n?void 0:n.file_reference)&&u.Z.deleteContext(n.file_reference,{type:"message",peerId:e.peerId,messageId:e.mid}),"webpage"in s&&s.webpage){const i=this.getScheduledMessagesStorage(e.peerId)===t,n=B.Z.getMessageKeyForPendingWebPage(e.peerId,e.mid,i);B.Z.deleteWebPageFromPending(s.webpage,n)}s.poll&&R.Z.updatePollToMessage(e,!1)}}handleDeletedMessages(e,t,s){const i={count:0,unread:0,unreadMentions:0,msgs:new Set};for(const n of s){const s=this.getMessageFromStorage(t,n);if(s.deleted){this.fixDialogUnreadMentionsIfNoMessage(e);continue}this.handleReleasingMessage(s,t),this.updateMessageRepliesIfNeeded(s),s.pFlags.out||s.pFlags.is_outgoing||!s.pFlags.unread||(++i.unread,q.Z.cancel("msg"+n),s.pFlags.mentioned&&(++i.unreadMentions,this.modifyCachedMentions(e,n,!1))),++i.count,i.msgs.add(n),s.deleted=!0;const a=s.grouped_id;if(a){const e=this.groupedMessagesStorage[a];e&&(e.delete(n),i.albums||(i.albums={}),(i.albums[a]||(i.albums[a]=new Set)).add(n),e.size||(delete i.albums,delete this.groupedMessagesStorage[a]))}t.delete(n);const r=this.newMessagesToHandle[e];r&&r.has(n)&&r.delete(n)}if(i.albums)for(const t in i.albums)f.default.dispatchEvent("album_edit",{peerId:e,groupId:t,deletedMids:[...i.albums[t]]});return i}handleEditedMessage(e,t){var s;if("message"===e._&&(null===(s=e.media)||void 0===s?void 0:s.webpage)){const t=B.Z.getMessageKeyForPendingWebPage(e.peerId,e.mid,!!e.pFlags.is_scheduled);B.Z.deleteWebPageFromPending(e.media.webpage,t)}}getMediaFromMessage(e){return e.action?e.action.photo:e.media&&(e.media.photo||e.media.document||e.media.webpage&&(e.media.webpage.document||e.media.webpage.photo))}isMentionUnread(e){var t;const s=null===(t=e.media)||void 0===t?void 0:t.document;return e.pFlags.media_unread&&e.pFlags.mentioned&&(!s||!["voice","round"].includes(s.type))}getDialogUnreadCount(e){return e.unread_count||+!!e.pFlags.unread_mark}isDialogUnread(e){return!!this.getDialogUnreadCount(e)}canForward(e){return!e.pFlags.noforwards&&!x.Z.noForwards(e.peerId)}};z.GO.appMessagesManager=ue;const pe=ue},9090:(e,t,s)=>{s.d(t,{Z:()=>C});var i=s(3251),n=s(410),a=s(3725),r=s(632),o=s(4762),d=s(4727),l=s(9518),c=s(6702),h=s(3512),u=s(7922),p=s(5185),g=s(8138),f=s(6440),m=s(1722),v=s(4687),_=s(5555),y=s(2131),I=s(1507),P=s(6724),S=s(6848),M=s(4847);const w=new class{constructor(){this.notificationsShown={},this.notificationIndex=0,this.notificationsCount=0,this.soundsPlayed={},this.vibrateSupport=y.Z,this.peerSettings={notifyPeer:{},notifyUsers:null,notifyChats:null,notifyBroadcasts:null},this.faviconEl=document.head.querySelector('link[rel="icon"]'),this.titleBackup=document.title,this.titleChanged=!1,this.stopped=!1,this.settings={},this.pushInited=!1,this.updateLocalSettings=()=>{Promise.all(["notify_nodesktop","notify_volume","notify_novibrate","notify_nopreview","notify_nopush"].map((e=>u.Z.get(e)))).then((e=>{if(this.settings.nodesktop=e[0],this.settings.volume=void 0===e[1]?.5:e[1],this.settings.novibrate=e[2],this.settings.nopreview=e[3],this.settings.nopush=e[4],this.pushInited){const e=!this.settings.nopush&&!this.settings.nodesktop&&c.default.isAvailable||!1;e!==(!1!==this.registeredDevice)&&(e?c.default.subscribe():c.default.unsubscribe())}c.default.setSettings(this.settings)})),v.default.getState().then((e=>{this.settings.nosound=!e.settings.notifications.sound}))},this.checkMuteUntil=()=>{void 0!==this.checkMuteUntilTimeout&&(clearTimeout(this.checkMuteUntilTimeout),this.checkMuteUntilTimeout=void 0);const e=(0,r.bz)(!0);let t=I.rU;for(const s in this.peerSettings.notifyPeer){const i=this.peerSettings.notifyPeer[s];if(i instanceof Promise)continue;const n=i.mute_until;n&&(n<=e?(i.mute_until=0,h.default.dispatchEvent("updateNotifySettings",{_:"updateNotifySettings",peer:{_:"notifyPeer",peer:f.Z.getOutputPeer(s.toPeerId())},notify_settings:i})):n<t&&(t=n))}const s=Math.min(18e5,1e3*(t-e));this.checkMuteUntilTimeout=window.setTimeout(this.checkMuteUntil,s)},this.requestPermission=()=>{Notification.requestPermission(),window.removeEventListener("click",this.requestPermission)},navigator.vibrate=navigator.vibrate||navigator.mozVibrate||navigator.webkitVibrate,this.notificationsUiSupport="Notification"in window||"mozNotification"in navigator,this.topMessagesDeferred=(0,a.b)(),this.notifySoundEl=document.createElement("div"),this.notifySoundEl.id="notify-sound",document.body.append(this.notifySoundEl),this.checkMuteUntilThrottled=(0,P.Z)(this.checkMuteUntil,1e3,!1),h.default.addEventListener("instance_deactivated",(()=>{this.stop()})),h.default.addEventListener("instance_activated",(()=>{this.stopped&&this.start()})),h.default.addEventListener("idle",(e=>{this.stopped||(e||this.clear(),this.toggleToggler())})),h.default.addMultipleEventsListeners({updateNotifySettings:e=>{const t="notifyPeer"===e.peer._&&f.Z.getPeerId(e.peer.peer),s="notifyPeer"!==e.peer._?e.peer._:void 0;this.savePeerSettings({key:s,peerId:t,settings:e.notify_settings}),h.default.dispatchEvent("notify_settings",e)}}),h.default.addEventListener("push_init",(e=>{this.pushInited=!0,this.settings.nodesktop||this.settings.nopush?this.unregisterDevice(e):e?this.registerDevice(e):c.default.subscribe()})),h.default.addEventListener("push_subscribe",(e=>{this.registerDevice(e)})),h.default.addEventListener("push_unsubscribe",(e=>{this.unregisterDevice(e)})),h.default.addEventListener("dialogs_multiupdate",(()=>{this.topMessagesDeferred.resolve()}),{once:!0}),h.default.addEventListener("push_notification_click",(e=>{if("push_settings"===e.action)return;if("mute1d"===e.action)return void l.Z.invokeApi("account.updateDeviceLocked",{period:86400}).then((()=>{}));const t=e.custom&&e.custom.peerId.toPeerId();console.log("click",e,t),t&&this.topMessagesDeferred.then((()=>{e.custom.channel_id&&!g.Z.hasChat(e.custom.channel_id)||t.isUser()&&!_.Z.hasUser(t)||h.default.dispatchEvent("history_focus",{peerId:t,mid:+e.custom.msg_id})}))}))}toggleToggler(e=h.default.idle.isIDLE){if(o.IS_MOBILE)return;const t=()=>{this.titleChanged=!1,document.title=this.titleBackup,this.setFavicon()};window.clearInterval(this.titleInterval),this.titleInterval=0,e?this.titleInterval=window.setInterval((()=>{const e=this.notificationsCount;if(e)if(this.titleChanged)t();else{this.titleChanged=!0,document.title=d.default.format("Notifications.Count",!0,[e]);const t=document.createElement("canvas");t.width=32*window.devicePixelRatio,t.height=t.width;const s=t.getContext("2d");s.beginPath(),s.arc(t.width/2,t.height/2,t.width/2,0,2*Math.PI,!1),s.fillStyle="#3390ec",s.fill();let n=24,a=""+e;e<10?n=22:e<100?n=20:(a="99+",n=16),n*=window.devicePixelRatio,s.font=`700 ${n}px ${i.P}`,s.textBaseline="middle",s.textAlign="center",s.fillStyle="white",s.fillText(a,t.width/2,.5625*t.height),this.setFavicon(t.toDataURL())}else this.toggleToggler(!1)}),1e3):t()}getLocalSettings(){return this.settings}getNotifySettings(e){let t,s=(0,M.Z)(e._),i=this.peerSettings[s];return"inputNotifyPeer"===e._&&(t=s=f.Z.getPeerId(e.peer),i=i[s]),i||((i||this.peerSettings)[s]=l.Z.invokeApi("account.getNotifySettings",{peer:e}).then((e=>(this.savePeerSettings({key:s,peerId:t,settings:e}),e))))}getNotifyPeerTypeSettings(){if(this.getNotifyPeerTypePromise)return this.getNotifyPeerTypePromise;const e=["inputNotifyBroadcasts","inputNotifyUsers","inputNotifyChats"].map((e=>this.getNotifySettings({_:e})));return this.getNotifyPeerTypePromise=Promise.all(e)}updateNotifySettings(e,t){return l.Z.invokeApi("account.updateNotifySettings",{peer:e,settings:t}).then((s=>{s&&p.Z.processLocalUpdate({_:"updateNotifySettings",peer:Object.assign(Object.assign({},e),{_:(0,M.Z)(e._)}),notify_settings:Object.assign(Object.assign({},t),{_:"peerNotifySettings"})})}))}getNotifyExceptions(){l.Z.invokeApi("account.getNotifyExceptions",{compare_sound:!0}).then((e=>{p.Z.processUpdateMessage(e)}))}getContactSignUpNotification(){return this.notifyContactsSignUp?this.notifyContactsSignUp:this.notifyContactsSignUp=l.Z.invokeApi("account.getContactSignUpNotification")}setContactSignUpNotification(e){l.Z.invokeApi("account.setContactSignUpNotification",{silent:e}).then((t=>{this.notifyContactsSignUp=Promise.resolve(!e)}))}setFavicon(e="assets/img/favicon.ico"){if(this.prevFavicon===e)return;const t=this.faviconEl.cloneNode();t.href=e,this.faviconEl.parentNode.replaceChild(t,this.faviconEl),this.faviconEl=t,this.prevFavicon=e}savePeerSettings({key:e,peerId:t,settings:s}){let i;t&&(e=t,i=this.peerSettings.notifyPeer),(i||this.peerSettings)[e]=s,t?this.checkMuteUntilThrottled():(h.default.dispatchEvent("notify_peer_type_settings",{key:e,settings:s}),v.default.getState().then((t=>{const i=t.notifySettings;i[e]=s,v.default.pushToState("notifySettings",i)})))}isMuted(e){return"peerNotifySettings"===e._&&(e.silent||void 0!==e.mute_until&&1e3*e.mute_until>(0,r.bz)())}getPeerMuted(e){const t=this.getNotifySettings({_:"inputNotifyPeer",peer:f.Z.getInputPeerById(e)});return(t instanceof Promise?t:Promise.resolve(t)).then((e=>this.isMuted(e)))}getPeerLocalSettings(e,t=!0){const s={_:"peerNotifySettings"},i=this.peerSettings.notifyPeer[e];if(!i||i instanceof Promise||Object.assign(s,i),t){const t=f.Z.getInputNotifyPeerById(e,!0),i=(0,M.Z)(t._),n=this.peerSettings[i];if(n&&!(n instanceof Promise))for(let e in n)void 0===s[e]&&(s[e]=n[e])}return s}isPeerLocalMuted(e,t=!0){if(e===h.default.myId)return!1;const s=this.getPeerLocalSettings(e,t);return this.isMuted(s)}start(){if(this.updateLocalSettings(),h.default.addEventListener("settings_updated",this.updateLocalSettings),c.default.start(),!this.notificationsUiSupport)return!1;"Notification"in window&&"granted"!==Notification.permission&&"denied"!==Notification.permission&&window.addEventListener("click",this.requestPermission);try{"onbeforeunload"in window&&window.addEventListener("beforeunload",this.clear)}catch(e){}}stop(){this.clear(),window.clearInterval(this.titleInterval),this.titleInterval=0,this.setFavicon(),this.stopped=!0}notify(e){if(this.stopped)return;e.image||(e.image="assets/img/logo_filled_rounded.png"),this.notificationsCount++,this.titleInterval||this.toggleToggler();const t=++this.notificationIndex,s=e.key||"k"+t;this.notificationsShown[s]=!0;const i=(0,r.bz)();if(this.settings.volume>0&&!this.settings.nosound&&(this.testSound(this.settings.volume),this.soundsPlayed[e.tag]=i),!this.notificationsUiSupport||"Notification"in window&&"granted"!==Notification.permission)return!1;if(this.settings.nodesktop)return this.vibrateSupport&&!this.settings.novibrate?void navigator.vibrate([200,100,200]):void 0;let n;if("Notification"in window){try{if(e.tag)for(let t in this.notificationsShown){const s=this.notificationsShown[t];"boolean"!=typeof s&&s.tag===e.tag&&(s.hidden=!0)}n=new Notification(e.title,{icon:e.image||"",body:e.message||"",tag:e.tag||"",silent:e.silent||!1})}catch(e){return this.notificationsUiSupport=!1,void c.default.setLocalNotificationsDisabled()}n.onclick=()=>{n.close(),m.Z.focus(),this.clear(),e.onclick&&e.onclick()},n.onclose=()=>{n.hidden||(delete this.notificationsShown[s],this.clear())},n.show&&n.show(),this.notificationsShown[s]=n,o.IS_MOBILE||setTimeout((()=>{this.hide(s)}),8e3)}}testSound(e){const t=(0,r.bz)();if(this.nextSoundAt&&t<this.nextSoundAt&&this.prevSoundVolume===e)return;this.nextSoundAt=t+1e3,this.prevSoundVolume=e;const s="assets/audio/notification.mp3",i=document.createElement("audio");i.autoplay=!0,i.setAttribute("mozaudiochannel","notification"),i.volume=e,i.innerHTML=`\n      <source src="${s}" type="audio/mpeg" />\n      <embed hidden="true" autostart="true" loop="false" volume="${100*e}" src="${s}" />\n    `,this.notifySoundEl.append(i),i.addEventListener("ended",(()=>{i.remove()}),{once:!0})}cancel(e){const t=this.notificationsShown[e];if(t){this.notificationsCount>0&&--this.notificationsCount;try{"boolean"!=typeof t&&t.close&&(t.hidden=!0,t.close())}catch(e){}delete this.notificationsShown[e]}}hide(e){const t=this.notificationsShown[e];if(t&&"boolean"!=typeof t)try{t.close&&(t.hidden=!0,t.close())}catch(e){}}soundReset(e){delete this.soundsPlayed[e]}clear(){for(const e in this.notificationsShown){const t=this.notificationsShown[e];try{"boolean"!=typeof t&&t.close&&t.close()}catch(e){}}this.notificationsShown={},this.notificationsCount=0,c.default.hidePushNotifications()}registerDevice(e){if(this.registeredDevice&&(0,S.Z)(this.registeredDevice,e))return!1;l.Z.invokeApi("account.registerDevice",{token_type:e.tokenType,token:e.tokenValue,other_uids:[],app_sandbox:!1,secret:new Uint8Array}).then((()=>{this.registeredDevice=e}),(e=>{e.handled=!0}))}unregisterDevice(e){if(!this.registeredDevice)return!1;l.Z.invokeApi("account.unregisterDevice",{token_type:e.tokenType,token:e.tokenValue,other_uids:[]}).then((()=>{this.registeredDevice=!1}),(e=>{e.handled=!0}))}getVibrateSupport(){return this.vibrateSupport}};n.GO.appNotificationsManager=w;const C=w},6440:(e,t,s)=>{s.d(t,{Z:()=>v});var i=s(410),n=s(8598),a=s(3512),r=s(8138),o=s(5555),d=s(4727),l=s(1507),c=s(677),h=s(5880),u=s(8456);const p=["#fc5c51","#0fb297","#d09306","#3d72ed","#895dd5","#cd4073","#00c1a6","#fa790f"],g=["red","green","yellow","blue","violet","pink","cyan","orange"],f=[0,7,4,1,6,3,5];["isChannel","isMegagroup","isAnyGroup","isBroadcast","isBot","isContact","isUser","isAnyChat"].forEach((e=>{const t=Array.isArray(e)?e[0]:e,s=Array.isArray(e)?e[1]:e;String.prototype[t]=function(){return m[s](this.toString())},Number.prototype[t]=function(){return m[s](this)}}));const m=new class{canPinMessage(e){return e.isUser()||r.Z.hasRights(e.toChatId(),"pin_messages")}getPeerPhoto(e){if(this.isRestricted(e))return;const t=e.isUser()?o.Z.getUserPhoto(e.toUserId()):r.Z.getChatPhoto(e.toChatId());return"chatPhotoEmpty"!==t._&&"userProfilePhotoEmpty"!==t._?t:void 0}getPeerMigratedTo(e){if(e.isUser())return!1;const t=r.Z.getChat(e.toChatId());return!!(t&&t.migrated_to&&t.pFlags.deactivated)&&this.getPeerId(t.migrated_to)}getPeerTitle(e,t=!1,s=!1,i){e||(e=a.default.myId);let l="";if(e.isUser()){const t=o.Z.getUser(e.toUserId());t.first_name&&(l+=t.first_name),!t.last_name||s&&l||(l+=" "+t.last_name),l=l?l.trim():t.pFlags.deleted?d.default.format("HiddenName",!0):t.username}else l=r.Z.getChat(e.toChatId()).title,s&&(l=l.split(" ")[0]);return void 0!==i&&(l=(0,u.Z)(l,i,i)),t?l:n.o.wrapEmojiText(l)}getOutputPeer(e){if(e.isUser())return{_:"peerUser",user_id:e.toUserId()};const t=e.toChatId();return r.Z.isChannel(t)?{_:"peerChannel",channel_id:t}:{_:"peerChat",chat_id:t}}getPeerString(e){return e.isUser()?o.Z.getUserString(e.toUserId()):r.Z.getChatString(e.toChatId())}getPeerUsername(e){return this.getPeer(e).username||""}getPeer(e){return e.isUser()?o.Z.getUser(e.toUserId()):r.Z.getChat(e.toChatId())}getPeerId(e){if(void 0!==e&&e.isPeerId&&e.isPeerId())return e;if((0,h.Z)(e)){const t=e.user_id;if(void 0!==t)return t.toPeerId(!1);const s=e.channel_id||e.chat_id;return void 0!==s?s.toPeerId(!0):a.default.myId}if(!e)return l.NM;const t="u"===e.charAt(0),s=e.substr(1).split("_");return t?s[0].toPeerId():(s[0]||"").toPeerId(!0)}getDialogPeer(e){return{_:"dialogPeer",peer:this.getOutputPeer(e)}}isChannel(e){return!e.isUser()&&r.Z.isChannel(e.toChatId())}isMegagroup(e){return!e.isUser()&&r.Z.isMegagroup(e.toChatId())}isAnyGroup(e){return!e.isUser()&&!r.Z.isBroadcast(e.toChatId())}isBroadcast(e){return this.isChannel(e)&&!this.isMegagroup(e)}isBot(e){return e.isUser()&&o.Z.isBot(e.toUserId())}isContact(e){return e.isUser()&&o.Z.isContact(e.toUserId())}isUser(e){return+e>=0}isAnyChat(e){return!this.isUser(e)}isRestricted(e){return e.isUser()?o.Z.isRestricted(e.toUserId()):r.Z.isRestricted(e.toChatId())}getRestrictionReasonText(e){const t=this.getPeer(e),s=t.restriction_reason?(0,c.RP)(t.restriction_reason):void 0;return s?s.text:e.isUser()?"This user is restricted":"This chat is restricted"}getInputNotifyPeerById(e,t){return t?e.isUser()?{_:"inputNotifyUsers"}:this.isBroadcast(e)?{_:"inputNotifyBroadcasts"}:{_:"inputNotifyChats"}:{_:"inputNotifyPeer",peer:this.getInputPeerById(e)}}getInputPeerById(e){if(!e)return{_:"inputPeerEmpty"};if(!e.isUser()){const t=e.toChatId();return r.Z.getInputPeer(t)}const t=e.toUserId();return o.Z.getUserInputPeer(t)}getInputPeerSelf(){return{_:"inputPeerSelf"}}getInputDialogPeerById(e){return{_:"inputDialogPeer",peer:(0,h.Z)(e)?e:this.getInputPeerById(e)}}getPeerColorById(e,t=!0){if(!e)return"";const s=f[Math.abs(+e)%7];return(t?g:p)[s]}getPeerSearchText(e){let t;return t=this.isUser(e)?"%pu "+o.Z.getUserSearchText(e.toUserId()):"%pg "+(r.Z.getChat(e.toChatId()).title||""),t}getDialogType(e){return this.isMegagroup(e)?"megagroup":this.isChannel(e)?"channel":this.isUser(e)?e===a.default.myId?"saved":"chat":"group"}getDeleteButtonText(e){switch(this.getDialogType(e)){case"channel":return r.Z.hasRights(e.toChatId(),"delete_chat")?"ChannelDelete":"ChatList.Context.LeaveChannel";case"megagroup":case"group":return r.Z.hasRights(e.toChatId(),"delete_chat")?"DeleteMega":"ChatList.Context.LeaveGroup";default:return"ChatList.Context.DeleteChat"}}noForwards(e){var t;return!e.isUser()&&!!(null===(t=r.Z.getChatTyped(e.toChatId()).pFlags)||void 0===t?void 0:t.noforwards)}};i.GO.appPeersManager=m;const v=m},3714:(e,t,s)=>{s.d(t,{Z:()=>I});var i=s(8801),n=s(4762),a=s(9518),r=s(2003),o=s(7309),d=s(5555),l=s(6705),c=s(410),h=s(6740),u=s(9897),p=s(4755),g=s(241),f=s(3306),m=s(5880),v=s(4463);class _{constructor(){this.photos={}}savePhoto(e,t){var s;if("photoEmpty"===e._)return;const i=this.photos[e.id];if(e.file_reference&&((0,v.Z)("file_reference",i,e),r.Z.saveContext(e.file_reference,t)),null===(s=e.sizes)||void 0===s?void 0:s.length){const t=e.sizes[e.sizes.length-1];"photoSizeProgressive"===t._&&(t.size=t.sizes[t.sizes.length-1])}return i?Object.assign(i,e):this.photos[e.id]=e}choosePhotoSize(e,t=0,s=0,i=!1,n=!1){window.devicePixelRatio>1&&(t*=2,s*=2);let a={_:"photoSizeEmpty",type:""},r=e.sizes||e.thumbs;if(n&&r&&"document"===e._&&(r=r.concat({_:"photoSize",w:e.w,h:e.h,size:e.size,type:void 0})),null==r?void 0:r.length){for(let e=0,i=r.length;e<i;++e){const i=r[e];if(!("w"in i)&&!("h"in i))continue;a=i;const n=(0,u.Z)(i.w,i.h,t,s);if(n.width>=t||n.height>=s)break}i&&"photoSizeEmpty"===a._&&"photoStrippedSize"===r[0]._&&(a=r[0])}return a}getUserPhotos(e,t="0",s=20){const i=d.Z.getUserInput(e);return a.Z.invokeApiCacheable("photos.getUserPhotos",{user_id:i,offset:0,limit:s,max_id:t},{cacheSeconds:60}).then((s=>{d.Z.saveApiUsers(s.users);const i=s.photos.map(((t,i)=>(s.photos[i]=this.savePhoto(t,{type:"profilePhoto",peerId:e.toPeerId()}),t.id)));if("0"!==t&&t){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}return{count:s.count||i.length,photos:i}}))}getPreviewURLFromBytes(e,t=!1){let s,i;t?s=e instanceof Uint8Array?e:new Uint8Array(e):(s=new Uint8Array(_.jpegHeader.concat(Array.from(e.slice(3)),_.jpegTail)),s[164]=e[1],s[166]=e[2]),i=t?n.IS_SAFARI?"image/png":"image/webp":"image/jpeg";const a=new Blob([s],{type:i});return URL.createObjectURL(a)}getPathFromPhotoPathSize(e){const t=e.bytes;let s="M";for(let e=0,i=t.length;e<i;++e){const i=t[e];i>=192?s+="AACAAAAHAAALMAAAQASTAVAAAZaacaaaahaaalmaaaqastava.az0123456789-,"[i-128-64]:(i>=128?s+=",":i>=64&&(s+="-"),s+=""+(63&i))}return s+="z",s}getPreviewURLFromThumb(e,t,s=!1){const i=o.Z.getCacheContext(e,t.type);return i.url||(i.url=this.getPreviewURLFromBytes(t.bytes,s))}getImageFromStrippedThumb(e,t,s){const i=this.getPreviewURLFromThumb(e,t,!1),n=new Image;n.classList.add("thumbnail");const a=(s?(0,l.Z)(i):Promise.resolve(i)).then((e=>(0,h.cj)(n,e)));return{image:n,loadPromise:a}}setAttachmentSize(e,t,s,i,n=!0,a,r,o){let d;o||(o=this.choosePhotoSize(e,s,i,void 0,r));const l="document"===e._;d=l?(0,p.CJ)(e.w||o.w||512,e.h||o.h||512):(0,p.CJ)(o.w||100,o.h||100);let c=(0,p.CJ)(s,i);c=d=d.aspect(c,n);let h=!0;return l&&!["video","gif"].includes(e.type)||(c.width<200&&c.height<200&&(c=d=d.aspectCovered((0,p.CJ)(200,200))),a&&(a.message||a.reply_to_mid||a.media.webpage||a.replies&&a.replies.pFlags.comments&&777!==a.replies.channel_id)&&c.width<320&&(c=(0,p.CJ)(320,c.height),h=!1),h&&c.width<120&&a&&(c=(0,p.CJ)(120,c.height),h=!1)),t.style.width=c.width+"px",t.style.height=c.height+"px",{photoSize:o,size:d,isFit:h}}getStrippedThumbIfNeeded(e,t,s,i=!1){if(!t.downloaded||["video","gif"].includes(e.type)||i){if("document"===e._&&t.downloaded&&!i)return null;const n=e.sizes||e.thumbs,a=(null==n?void 0:n.length)?n.find((e=>"photoStrippedSize"===e._)):null;if(a&&"bytes"in a)return this.getImageFromStrippedThumb(e,a,s)}return null}getPhotoDownloadOptions(e,t,s,i){const n="document"===e._;if(!t||"photoSizeEmpty"===t._)throw new Error("photoSizeEmpty!");const a=("photoSize"===t._||"photoSizeProgressive"===t._)&&e.access_hash&&e.file_reference,r={_:n?"inputDocumentFileLocation":"inputPhotoFileLocation",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference,thumb_size:t.type};return{dcId:e.dc_id,location:r,size:a?t.size:void 0,queueId:s,onlyCache:i}}preloadPhoto(e,t,s,n){const a=this.getPhoto(e);if(!a||"photoEmpty"===a._)throw new Error("preloadPhoto photoEmpty!");if(!t){const e=g.Z.width,s=g.Z.height;t=this.choosePhotoSize(a,e,s)}const r=o.Z.getCacheContext(a,t.type);if(r.downloaded>=("size"in t?t.size:0)&&r.url)return Promise.resolve();const d=this.getPhotoDownloadOptions(a,t,s,n),l=(0,i.P)(d.location);let c=o.Z.getDownload(l);return c||(c=o.Z.download(d),c.then((e=>{if(!r.downloaded||r.downloaded<e.size){const t=URL.createObjectURL(e);r.downloaded=e.size,r.url=t}return e})).catch((()=>{})),c)}getPhoto(e){return(0,m.Z)(e)?e:this.photos[e]}getInput(e){return{_:"inputPhoto",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference}}getMediaInput(e){return{_:"inputMediaPhoto",id:this.getInput(e),ttl_seconds:0}}savePhotoFile(e,t){const s=this.choosePhotoSize(e,65535,65535);if("photoSize"!==s._&&"photoSizeProgressive"!==s._)return;const i=this.getPhotoDownloadOptions(e,s,t);i.fileName="photo"+e.id+".jpg",o.Z.downloadToDisc(i,i.fileName)}}_.jpegHeader=(0,f.Z)("ffd8ffe000104a46494600010100000100010000ffdb004300281c1e231e19282321232d2b28303c64413c37373c7b585d4964918099968f808c8aa0b4e6c3a0aadaad8a8cc8ffcbdaeef5ffffff9bc1fffffffaffe6fdfff8ffdb0043012b2d2d3c353c76414176f8a58ca5f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8ffc00011080000000003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00"),_.jpegTail=(0,f.Z)("ffd9");const y=new _;c.GO&&(c.GO.appPhotosManager=y);const I=y},7995:(e,t,s)=>{s.d(t,{Z:()=>f});var i=s(410),n=s(8479),a=s(5003),r=s(9518),o=s(8598),d=s(3512),l=s(5185),c=s(9492),h=s(7223),u=s(6440),p=s(5555);const g=new class{constructor(){this.polls={},this.results={},this.pollToMessages={},this.log=(0,a.kg)("POLLS",a.v9.Error),d.default.addMultipleEventsListeners({updateMessagePoll:e=>{this.log("updateMessagePoll:",e);let t=e.poll||this.polls[e.poll_id];if(!t)return;let s=e.results;const i=this.savePoll(t,s);t=i.poll,s=i.results,d.default.dispatchEvent("poll_update",{poll:t,results:s})}})}savePoll(e,t,s){s&&this.updatePollToMessage(s,!0);const i=e.id;return this.polls[i]?(e=Object.assign(this.polls[i],e),t=this.saveResults(e,t)):(this.polls[i]=e,e.rQuestion=o.o.wrapEmojiText(e.question),e.rReply=o.o.wrapEmojiText("📊")+" "+(e.rQuestion||"poll"),e.chosenIndexes=[],t=this.saveResults(e,t)),{poll:e,results:t}}saveResults(e,t){var s;return this.results[e.id]?t=Object.assign(this.results[e.id],t):this.results[e.id]=t,t.pFlags.min||(e.chosenIndexes.length=0,(null===(s=null==t?void 0:t.results)||void 0===s?void 0:s.length)&&t.results.forEach(((t,s)=>{var i;(null===(i=t.pFlags)||void 0===i?void 0:i.chosen)&&e.chosenIndexes.push(s)}))),t}getPoll(e){return{poll:this.polls[e],results:this.results[e]}}getInputMediaPoll(e,t,s,i){return s?(i||(i=[]),s=o.o.parseMarkdown(s,i)):s=void 0,{_:"inputMediaPoll",poll:e,correct_answers:t,solution:s,solution_entities:s?i:void 0}}updatePollToMessage(e,t){const{id:s}=e.media.poll;let i=this.pollToMessages[s];if(!t&&!i)return;i||(i=this.pollToMessages[s]=new Set);const n=e.peerId+"_"+e.mid;t?i.add(n):i.delete(n),t||i.size||(delete this.polls[s],delete this.results[s],delete this.pollToMessages[s])}sendVote(e,t){const s=e.media.poll,i=t.map((e=>s.answers[e].option)),n=e.mid,a=e.peerId,o=u.Z.getInputPeerById(a);return e.pFlags.is_outgoing?h.Z.invokeAfterMessageIsSent(n,"sendVote",(e=>(this.log("invoke sendVote callback"),this.sendVote(e,t)))):r.Z.invokeApi("messages.sendVote",{peer:o,msg_id:c.Z.getServerMessageId(e.mid),options:i}).then((e=>{this.log("sendVote updates:",e),l.Z.processUpdateMessage(e)}))}getResults(e){const t=u.Z.getInputPeerById(e.peerId);return r.Z.invokeApi("messages.getPollResults",{peer:t,msg_id:c.Z.getServerMessageId(e.mid)}).then((e=>{l.Z.processUpdateMessage(e),this.log("getResults updates:",e)}))}getVotes(e,t,s,i=20){return r.Z.invokeApi("messages.getPollVotes",{peer:u.Z.getInputPeerById(e.peerId),id:c.Z.getServerMessageId(e.mid),option:t,offset:s,limit:i}).then((e=>(this.log("getPollVotes messages:",e),p.Z.saveApiUsers(e.users),e)))}stopPoll(e){const t=e.media.poll;if(t.pFlags.closed)return Promise.resolve();const s=(0,n.Z)(t);return s.pFlags.closed=!0,h.Z.editMessage(e,void 0,{newMedia:this.getInputMediaPoll(s)}).then((()=>{}),(e=>{this.log.error("stopPoll error:",e)}))}};i.GO.appPollsManager=g;const f=g},8209:(e,t,s)=>{s.r(t),s.d(t,{AppProfileManager:()=>_,default:()=>I});var i=s(410),n=s(632),a=s(2575),r=s(4727),o=s(9518),d=s(3512),l=s(7381),c=s(5185),h=s(8138),u=s(9492),p=s(9090),g=s(6440),f=s(3714),m=s(5555),v=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class _{constructor(){this.usersFull={},this.chatsFull={},this.onUpdateUserTyping=e=>{var t;const s=e.user_id?e.user_id.toPeerId():g.Z.getPeerId(e.from_id);if(d.default.myId===s||"speakingInGroupCallAction"===e.action._)return;const i=g.Z.getPeerId(e),n=null!==(t=this.typingsInPeer[i])&&void 0!==t?t:this.typingsInPeer[i]=[];let a=n.find((e=>e.userId===s));const r=()=>{delete a.timeout;const e=n.indexOf(a);-1!==e&&n.splice(e,1),d.default.dispatchEvent("peer_typings",{peerId:i,typings:n}),n.length||delete this.typingsInPeer[i]};if(a&&void 0!==a.timeout&&clearTimeout(a.timeout),"sendMessageCancelAction"===e.action._){if(!a)return;return void r()}a||(a={userId:s},n.push(a)),a.action=e.action;const o=m.Z.hasUser(s);o?m.Z.forceUserOnline(s):"updateChatUserTyping"===e._&&e.chat_id&&h.Z.hasChat(e.chat_id)&&!h.Z.isChannel(e.chat_id)&&Promise.resolve(this.getChatFull(e.chat_id)).then((()=>{void 0!==a.timeout&&m.Z.hasUser(s)&&d.default.dispatchEvent("peer_typings",{peerId:i,typings:n})})),a.timeout=window.setTimeout(r,6e3),o&&d.default.dispatchEvent("peer_typings",{peerId:i,typings:n})},this.onUpdatePeerBlocked=e=>{const t=g.Z.getPeerId(e.peer_id);if(g.Z.isUser(t)){const s=t.toUserId(),i=this.usersFull[s];i&&(e.blocked?i.pFlags.blocked=!0:delete i.pFlags.blocked),d.default.dispatchEvent("user_full_update",s)}d.default.dispatchEvent("peer_block",{peerId:t,blocked:e.blocked})},d.default.addMultipleEventsListeners({updateChatParticipants:e=>{const t=e.participants;if("chatParticipants"===t._){const e=t.chat_id,s=this.chatsFull[e];void 0!==s&&(s.participants=t,d.default.dispatchEvent("chat_full_update",e))}},updateChatParticipantAdd:e=>{const t=this.chatsFull[e.chat_id];if(void 0!==t){const s=t.participants,i=s.participants||[];for(let t=0,s=i.length;t<s;t++)if(i[t].user_id===e.user_id)return;i.push({_:"chatParticipant",user_id:e.user_id,inviter_id:e.inviter_id,date:(0,n.bz)(!0)}),s.version=e.version,d.default.dispatchEvent("chat_full_update",e.chat_id)}},updateChatParticipantDelete:e=>{const t=this.chatsFull[e.chat_id];if(void 0!==t){const s=t.participants,i=s.participants||[];for(let t=0,n=i.length;t<n;t++)if(i[t].user_id===e.user_id)return i.splice(t,1),s.version=e.version,void d.default.dispatchEvent("chat_full_update",e.chat_id)}},updateUserTyping:this.onUpdateUserTyping,updateChatUserTyping:this.onUpdateUserTyping,updateChannelUserTyping:this.onUpdateUserTyping,updatePeerBlocked:this.onUpdatePeerBlocked}),d.default.addEventListener("chat_update",(e=>{var t,s;const i=this.chatsFull[e],n=h.Z.getChat(e);if(!i||!n)return;let a=!1;!!i.call!=!!(null===(t=n.pFlags)||void 0===t?void 0:t.call_active)&&(a=!0);const{photo:r}=n;if(r){const e="chatPhotoEmpty"!==r._;(e!==!(!i.chat_photo||"photoEmpty"===i.chat_photo._)||e&&r.photo_id!==(null===(s=i.chat_photo)||void 0===s?void 0:s.id))&&(a=!0)}a&&this.refreshFullPeer(e.toPeerId(!0))})),d.default.addEventListener("channel_update",(e=>{this.refreshFullPeer(e.toPeerId(!0))})),d.default.addEventListener("chat_full_update",(e=>{d.default.dispatchEvent("peer_full_update",e.toPeerId(!0))})),d.default.addEventListener("user_full_update",(e=>{d.default.dispatchEvent("peer_full_update",e.toPeerId(!1))})),d.default.addEventListener("invalidate_participants",(e=>{this.invalidateChannelParticipants(e)})),this.typingsInPeer={}}getProfile(e,t){return this.usersFull[e]&&!t?this.usersFull[e]:o.Z.invokeApiSingleProcess({method:"users.getFullUser",params:{id:m.Z.getUserInput(e)},processResult:t=>{h.Z.saveApiChats(t.chats,!0),m.Z.saveApiUsers(t.users);const s=t.full_user,i=e.toPeerId(!1);return s.profile_photo&&(s.profile_photo=f.Z.savePhoto(s.profile_photo,{type:"profilePhoto",peerId:i})),p.Z.savePeerSettings({peerId:i,settings:s.notify_settings}),this.usersFull[e]=s,d.default.dispatchEvent("user_full_update",e),s}})}getProfileByPeerId(e,t){return g.Z.isAnyChat(e)?this.getChatFull(e.toChatId(),t):this.getProfile(e.toUserId(),t)}getCachedFullChat(e){return this.chatsFull[e]}getCachedFullUser(e){return this.usersFull[e]}getCachedProfileByPeerId(e){return e.isUser()?this.getCachedFullUser(e.toUserId()):this.getCachedFullChat(e.toChatId())}getFullPhoto(e){return v(this,void 0,void 0,(function*(){const t=yield this.getProfileByPeerId(e);switch(t._){case"userFull":return t.profile_photo;case"channelFull":case"chatFull":return t.chat_photo}}))}getChatFull(e,t){if(h.Z.isChannel(e))return this.getChannelFull(e,t);const s=this.chatsFull[e];if(s&&!t){const t=h.Z.getChat(e);if(t.version===s.participants.version||t.pFlags.left)return s}return o.Z.invokeApiSingleProcess({method:"messages.getFullChat",params:{chat_id:e},processResult:t=>{h.Z.saveApiChats(t.chats,!0),m.Z.saveApiUsers(t.users);const s=t.full_chat,i=e.toPeerId(!0);return s&&s.chat_photo&&s.chat_photo.id&&(s.chat_photo=f.Z.savePhoto(s.chat_photo,{type:"profilePhoto",peerId:i})),p.Z.savePeerSettings({peerId:i,settings:s.notify_settings}),this.chatsFull[e]=s,d.default.dispatchEvent("chat_full_update",e),s}})}getChatInviteLink(e,t){return v(this,void 0,void 0,(function*(){const s=yield this.getChatFull(e);return!t&&s.exported_invite&&"chatInviteExported"==s.exported_invite._?s.exported_invite.link:o.Z.invokeApi("messages.exportChatInvite",{peer:g.Z.getInputPeerById(e.toPeerId(!0))}).then((t=>(void 0!==this.chatsFull[e]&&(this.chatsFull[e].exported_invite=t),t.link)))}))}getChannelParticipants(e,t={_:"channelParticipantsRecent"},s=200,i=0){if("channelParticipantsRecent"===t._){const t=h.Z.getChat(e);if(t&&t.pFlags&&(t.pFlags.kicked||t.pFlags.broadcast&&!t.pFlags.creator&&!t.admin_rights))return Promise.reject()}return o.Z.invokeApiCacheable("channels.getParticipants",{channel:h.Z.getChannelInput(e),filter:t,offset:i,limit:s,hash:"0"},{cacheSeconds:60}).then((e=>(m.Z.saveApiUsers(e.users),e)))}getChannelParticipant(e,t){return o.Z.invokeApiSingle("channels.getParticipant",{channel:h.Z.getChannelInput(e),participant:g.Z.getInputPeerById(t)}).then((e=>(m.Z.saveApiUsers(e.users),e.participant)))}getChannelFull(e,t){return void 0===this.chatsFull[e]||t?o.Z.invokeApiSingleProcess({method:"channels.getFullChannel",params:{channel:h.Z.getChannelInput(e)},processResult:t=>{const s=e.toPeerId(!0);h.Z.saveApiChats(t.chats,!0),m.Z.saveApiUsers(t.users);const i=t.full_chat;return i&&i.chat_photo.id&&(i.chat_photo=f.Z.savePhoto(i.chat_photo,{type:"profilePhoto",peerId:s})),p.Z.savePeerSettings({peerId:s,settings:i.notify_settings}),this.chatsFull[e]=i,d.default.dispatchEvent("chat_full_update",e),i},processError:t=>{if("CHANNEL_PRIVATE"===t.type){let t=h.Z.getChat(e);t={_:"channelForbidden",access_hash:t.access_hash,title:t.title},c.Z.processUpdateMessage({_:"updates",updates:[{_:"updateChannel",channel_id:e}],chats:[t],users:[]})}throw t}}):this.chatsFull[e]}getMentions(e,t,s){let i;return i=h.Z.isChannel(e)?this.getChannelParticipants(e,{_:"channelParticipantsMentions",q:t,top_msg_id:u.Z.getServerMessageId(s)},50,0).then((e=>e.participants.map((e=>h.Z.getParticipantPeerId(e))))):e?Promise.resolve(this.getChatFull(e)).then((e=>e.participants.participants.map((e=>e.user_id.toPeerId())))):Promise.resolve([]),Promise.all([m.Z.getTopPeers("bots_inline").catch((()=>[])),i]).then((e=>(e=>{"@"===t.charAt(0)&&(t=t.slice(1));const s=new l.Z({ignoreCase:!0}),i=new Map;e.forEach((e=>{s.indexObject(e.id,m.Z.getUserSearchText(e.id)),i.set(e.id,e.rating)}));const n=Array.from(s.search(t));return n.sort(((e,t)=>i.get(t)-i.get(e))),n})(e[0].concat(e[1].map((e=>({id:e,rating:0})))))))}invalidateChannelParticipants(e){o.Z.clearCache("channels.getParticipants",(t=>t.channel.channel_id===e)),this.refreshFullPeer(e.toPeerId(!0))}refreshFullPeer(e){if(e.isUser()){const t=e.toUserId();delete this.usersFull[t],d.default.dispatchEvent("user_full_update",t)}else{const t=e.toChatId();delete this.chatsFull[t],d.default.dispatchEvent("chat_full_update",t)}}updateProfile(e,t,s){return o.Z.invokeApi("account.updateProfile",{first_name:e,last_name:t,about:s}).then((e=>{if(m.Z.saveApiUser(e),void 0!==s){const t=e.id.toPeerId(),i=this.usersFull[e.id];i&&(i.about=s),d.default.dispatchEvent("peer_bio_edit",t)}return this.getProfile(d.default.myId,!0)}))}uploadProfilePhoto(e){return o.Z.invokeApi("photos.uploadProfilePhoto",{file:e}).then((e=>{const t=e.photo;if(!e.users.length){const s=t.sizes.find((e=>"photoStrippedSize"===e._));e.users.push(Object.assign(Object.assign({},m.Z.getSelf()),{photo:{_:"userProfilePhoto",dc_id:t.dc_id,photo_id:t.id,stripped_thumb:null==s?void 0:s.bytes,pFlags:{}}}))}m.Z.saveApiUsers(e.users);const s=d.default.myId;f.Z.savePhoto(e.photo,{type:"profilePhoto",peerId:s});const i=s.toUserId();c.Z.processLocalUpdate({_:"updateUserPhoto",user_id:i,date:(0,n.bz)(!0),photo:m.Z.getUser(i).photo,previous:!0})}))}deletePhotos(e){return o.Z.invokeApiSingle("photos.deletePhotos",{id:e.map((e=>{const t=f.Z.getPhoto(e);return f.Z.getInput(t)}))}).then((e=>{}))}getChatMembersString(e){var t,s;const i=h.Z.getChat(e);if("chatForbidden"===i._)return(0,r.i18n)("YouWereKicked");const n=this.chatsFull[e];let o;o=n?"channelFull"===n._?n.participants_count:null===(t=n.participants.participants)||void 0===t?void 0:t.length:i.participants_count||(null===(s=i.participants)||void 0===s?void 0:s.participants.length),o=o||1;let d=h.Z.isBroadcast(e)?"Peer.Status.Subscribers":"Peer.Status.Member";return(0,r.i18n)(d,[(0,a.Z)(o)])}verifyParticipantForOnlineCount(e){const t=m.Z.getUser(e.user_id);return!(!t||!t.status||"userStatusOnline"!==t.status._)}reduceParticipantsForOnlineCount(e){return e.reduce(((e,t)=>e+ +this.verifyParticipantForOnlineCount(t)),0)}getOnlines(e){var t;return v(this,void 0,void 0,(function*(){if(h.Z.isBroadcast(e))return 1;const s=yield this.getChatFull(e);if(h.Z.isMegagroup(e)){if(s.participants_count<=100){const t=yield this.getChannelParticipants(e,{_:"channelParticipantsRecent"},100);return this.reduceParticipantsForOnlineCount(t.participants)}const i=yield o.Z.invokeApiCacheable("messages.getOnlines",{peer:h.Z.getChannelInputPeer(e)},{cacheSeconds:60});return null!==(t=i.onlines)&&void 0!==t?t:1}const i=s.participants;return(null==i?void 0:i.participants)?this.reduceParticipantsForOnlineCount(i.participants):1}))}getPeerTypings(e){return this.typingsInPeer[e]}}const y=new _;i.GO.appProfileManager=y;const I=y},6689:(e,t,s)=>{s.d(t,{Z:()=>y});var i=s(410),n=s(8938),a=s(6654);function r(e,t){return e.some((e=>e instanceof Promise))?Promise.all(e).then(t):t(e)}var o=s(8479),d=s(9518),l=s(3512),c=s(5185),h=s(1592),u=s(9492),p=s(6440),g=s(8209),f=s(5555);const m=["static_icon","appear_animation","select_animation","activate_animation","effect_animation","around_animation","center_icon"],v={type:"reactions"},_=new class{constructor(){l.default.addEventListener("language_change",(()=>{this.availableReactions=void 0,this.getAvailableReactions()})),this.sendReactionPromises=new Map,this.lastSendingTimes=new Map,setTimeout((()=>{Promise.resolve(this.getAvailableReactions()).then((e=>{return t=this,s=void 0,n=function*(){for(const t of e)yield Promise.all([t.around_animation&&h.Z.downloadDoc(t.around_animation),t.static_icon&&h.Z.downloadDoc(t.static_icon),t.appear_animation&&h.Z.downloadDoc(t.appear_animation),t.center_icon&&h.Z.downloadDoc(t.center_icon)])},new((i=void 0)||(i=Promise))((function(e,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(r,o)}d((n=n.apply(t,s||[])).next())}));var t,s,i,n}))}),7500)}getAvailableReactions(){return this.availableReactions?this.availableReactions:d.Z.invokeApiSingleProcess({method:"messages.getAvailableReactions",processResult:e=>{(0,n.Z)(e);const t=this.availableReactions=e.reactions;for(const e of t)for(const t of m)e[t]&&(e[t]=h.Z.saveDoc(e[t],v));return t},params:{hash:0}})}getActiveAvailableReactions(){return(0,a.Z)(this.getAvailableReactions(),(e=>e.filter((e=>!e.pFlags.inactive))))}getAvailableReactionsForPeer(e){const t=this.getActiveAvailableReactions();return e.isUser()?this.unshiftQuickReaction(t):r([t,g.default.getChatFull(e.toChatId()),this.getQuickReaction()],(([e,t,s])=>{var i;const n=(null!==(i=t.available_reactions)&&void 0!==i?i:[]).map((t=>e.find((e=>e.reaction===t)))).filter(Boolean);return this.unshiftQuickReactionInner(n,s)}))}unshiftQuickReactionInner(e,t){const s=e.findAndSplice((e=>e.reaction===t.reaction));return s&&e.unshift(s),e}unshiftQuickReaction(e,t=this.getQuickReaction()){return r([e,t],(([e,t])=>this.unshiftQuickReactionInner(e,t)))}getAvailableReactionsByMessage(e){var t;const s=(null===(t=e.fwd_from)||void 0===t?void 0:t.channel_post)&&p.Z.isMegagroup(e.peerId)&&e.fwdFromId||e.peerId;return this.getAvailableReactionsForPeer(s)}isReactionActive(e){return!!this.availableReactions&&!!this.availableReactions.find((t=>t.reaction===e))}getQuickReaction(){return r([d.Z.getAppConfig(),this.getAvailableReactions()],(([e,t])=>t.find((t=>t.reaction===e.reactions_default))))}getReactionCached(e){return this.availableReactions.find((t=>t.reaction===e))}getReaction(e){return(0,a.Z)(this.getAvailableReactions(),(()=>this.getReactionCached(e)))}getMessagesReactions(e,t){return d.Z.invokeApiSingleProcess({method:"messages.getMessagesReactions",params:{id:t.map((e=>u.Z.getServerMessageId(e))),peer:p.Z.getInputPeerById(e)},processResult:e=>{c.Z.processUpdateMessage(e)}})}getMessageReactionsList(e,t,s,i,n){return d.Z.invokeApiSingleProcess({method:"messages.getMessageReactionsList",params:{peer:p.Z.getInputPeerById(e),id:u.Z.getServerMessageId(t),limit:s,reaction:i,offset:n},processResult:e=>(f.Z.saveApiUsers(e.users),e)})}setDefaultReaction(e){return d.Z.invokeApi("messages.setDefaultReaction",{reaction:e}).then((t=>{if(t){const t=l.default.appConfig;t?t.reactions_default=e:d.Z.getAppConfig(!0),l.default.dispatchEvent("quick_reaction",e)}return t}))}sendReaction(e,t,s){const i=e.peerId+"_"+e.mid;if(this.lastSendingTimes.get(i))return;this.lastSendingTimes.set(i,Date.now()),setTimeout((()=>{this.lastSendingTimes.delete(i)}),333);const{peerId:a,mid:r}=e,h=l.default.myId;let g=s?e.reactions:(0,o.Z)(e.reactions),f=g?g.results.findIndex((e=>e.pFlags.chosen)):-1,m=-1!==f&&g.results[f];if(m&&(--m.count,delete m.pFlags.chosen,t===m.reaction&&(t=void 0),m.count||g.results.splice(f,1),g.recent_reactions&&g.recent_reactions.findAndSplice((e=>p.Z.getPeerId(e.peer_id)===h)),g.results.length||(g=void 0)),t){g||(g={_:"messageReactions",results:[],pFlags:{}},p.Z.isBroadcast(e.peerId)||(g.pFlags.can_see_list=!0));let s=g.results.findIndex((e=>e.reaction===t)),i=-1!==s&&g.results[s];if(i||(i={_:"reactionCount",count:0,reaction:t,pFlags:{}},s=g.results.push(i)-1),++i.count,i.pFlags.chosen=!0,!g.recent_reactions&&g.pFlags.can_see_list&&(g.recent_reactions=[]),g.recent_reactions){const e={_:"messagePeerReaction",reaction:t,peer_id:p.Z.getOutputPeer(h)};p.Z.isMegagroup(a)?(g.recent_reactions.unshift(e),g.recent_reactions=g.recent_reactions.slice(0,3)):(g.recent_reactions.push(e),g.recent_reactions=g.recent_reactions.slice(-3))}}const v=this.availableReactions;if(g&&(null==v?void 0:v.length)){const e=new Map;v.forEach(((t,s)=>{e.set(t.reaction,s)})),g.results.sort(((t,s)=>s.count-t.count||e.get(t.reaction)-e.get(s.reaction)))}if(s)return e.reactions=g,l.default.dispatchEvent("message_reactions",{message:e,changedResults:[]}),Promise.resolve();c.Z.processLocalUpdate({_:"updateMessageReactions",peer:e.peer_id,msg_id:e.id,reactions:g,local:!0});const _=[a,r].join("-"),y=u.Z.getServerMessageId(r),I=d.Z.invokeApi("messages.sendReaction",{peer:p.Z.getInputPeerById(a),msg_id:y,reaction:t}).then((e=>{(0,n.Z)(e);const t=e.updates.findIndex((e=>"updateEditMessage"===e._||"updateEditChannelMessage"===e._));if(-1!==t){const s=e.updates[t];e.updates[t]={_:"updateMessageReactions",msg_id:y,peer:p.Z.getOutputPeer(a),reactions:s.message.reactions,pts:s.pts,pts_count:s.pts_count}}c.Z.processUpdateMessage(e)})).catch((t=>{"REACTION_INVALID"===t.type&&this.sendReactionPromises.get(_)===I&&this.sendReaction(e,null==m?void 0:m.reaction,!0)})).finally((()=>{this.sendReactionPromises.get(_)===I&&this.sendReactionPromises.delete(_)}));return this.sendReactionPromises.set(_,I),I}};i.GO&&(i.GO.appReactionsManager=_);const y=_},3847:(e,t,s)=>{s.d(t,{Z:()=>S});var i=s(9518),n=s(3512),a=s(1592),r=s(6947),o=s(410),d=s(3127),l=s(2897),c=s(4755),h=s(671),u=s(8598),p=s(8938),g=s(8079),f=s(393),m=s(7625),v=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};const _="emoji",y="emojiAnimations",I=new Set([_,y]),P=new class{constructor(){this.storage=new r.Z(d.Z,"stickerSets"),this.getStickerSetPromises={},this.getStickersByEmoticonsPromises={},this.sounds={},this.getAnimatedEmojiStickerSet(),n.default.addMultipleEventsListeners({updateNewStickerSet:e=>{const t=e.stickerset;this.saveStickerSet(t,t.set.id),n.default.dispatchEvent("stickers_installed",t.set)}}),this.getGreetingStickersTimeout=window.setTimeout((()=>{this.getGreetingStickersTimeout=void 0,this.getGreetingSticker(!0)}),5e3)}getGreetingSticker(e=!1){return this.getGreetingStickersTimeout&&(clearTimeout(this.getGreetingStickersTimeout),this.getGreetingStickersTimeout=void 0),this.getGreetingStickersPromise||(this.getGreetingStickersPromise=this.getStickersByEmoticon("👋⭐️",!1).then((e=>{if(!e.length)throw"NO_STICKERS";this.greetingStickers=e.slice(),this.greetingStickers.sort(((e,t)=>Math.random()-Math.random()))}))),this.getGreetingStickersPromise.then((()=>{let t;return e||(t=this.greetingStickers.shift(),this.greetingStickers.push(t)),a.Z.downloadDoc(this.greetingStickers[0]),t}))}saveStickers(e){(0,m.Z)(e,((t,s)=>{(t=a.Z.saveDoc(t))?e[s]=t:e.splice(s,1)}))}getStickerSet(e,t={}){return v(this,void 0,void 0,(function*(){const s=e.id;return this.getStickerSetPromises[s]?this.getStickerSetPromises[s]:this.getStickerSetPromises[s]=new Promise((n=>v(this,void 0,void 0,(function*(){var a;if(!t.overwrite){const e=yield this.storage.get(s);if(e&&(null===(a=e.documents)||void 0===a?void 0:a.length)&&(Date.now()-e.refreshTime<36e5||t.useCache))return this.saveStickers(e.documents),n(e),void delete this.getStickerSetPromises[s]}try{const a=yield i.Z.invokeApi("messages.getStickerSet",{stickerset:this.getStickerSetInput(e),hash:0}),r=t.saveById?s:a.set.id;this.saveStickerSet(a,r),n(a)}catch(e){n(null)}delete this.getStickerSetPromises[s]}))))}))}getAnimatedEmojiStickerSet(){return Promise.all([this.getStickerSet({id:_},{saveById:!0}),this.getStickerSet({id:y},{saveById:!0}),this.getAnimatedEmojiSounds()]).then((([e,t])=>({emoji:e,animations:t})))}getAnimatedEmojiSounds(e){if(this.getAnimatedEmojiSoundsPromise&&!e)return this.getAnimatedEmojiSoundsPromise;const t=this.getAnimatedEmojiSoundsPromise=Promise.resolve(i.Z.getAppConfig(e)).then((e=>{if(this.getAnimatedEmojiSoundsPromise===t)for(const t in e.emojies_sounds){const s=e.emojies_sounds[t],i=atob((0,g.Z)(s.file_reference_base64,!1)),r=new Uint8Array(i.length);for(let e=0,t=r.length;e<t;++e)r[e]=i[e].charCodeAt(0);const o=a.Z.saveDoc({_:"document",pFlags:{},flags:0,id:s.id,access_hash:s.access_hash,attributes:[{_:"documentAttributeAudio",duration:1,pFlags:{voice:!0}}],date:0,dc_id:n.default.config.this_dc,file_reference:r,mime_type:"audio/ogg",size:1},{type:"emojiesSounds"});this.sounds[t]=o}}));return t}getRecentStickers(){return v(this,void 0,void 0,(function*(){return yield i.Z.invokeApiHashable({method:"messages.getRecentStickers",processResult:e=>((0,p.Z)(e),this.saveStickers(e.stickers),e)})}))}cleanEmoji(e){return e.replace(/\ufe0f/g,"").replace(/🏻|🏼|🏽|🏾|🏿/g,"")}getAnimatedEmojiSticker(e,t){const s=this.storage.getFromCache(t?y:_);if(!s||!s.documents)return;t&&["🧡","💛","💚","💙","💜","🖤","🤍","🤎"].includes(e)&&(e="❤️"),e=this.cleanEmoji(e);const i=s.packs.find((t=>t.emoticon===e));return i?a.Z.getDoc(i.documents[0]):void 0}getAnimatedEmojiSoundDocument(e){return this.sounds[this.cleanEmoji(e)]}preloadAnimatedEmojiSticker(e,t,s){const i=this.getAnimatedEmojiStickerSet().then((()=>{const i=this.getAnimatedEmojiSticker(e);if(i)return a.Z.downloadDoc(i).then((n=>v(this,void 0,void 0,(function*(){const r=c.ZP.active.emojiSticker,o=(0,h.tB)(e),d=yield l.Z.loadAnimationWorker({container:void 0,animationData:n,width:null!=t?t:r.width,height:null!=s?s:r.height,name:"doc"+i.id,autoplay:!1,loop:!1,toneIndex:o},"none");d.addEventListener("firstFrame",(()=>{a.Z.saveLottiePreview(i,d.canvas,o),d.remove()}),{once:!0})}))))}));return Promise.all([i,this.preloadAnimatedEmojiStickerAnimation(e)])}preloadAnimatedEmojiStickerAnimation(e){return this.getAnimatedEmojiStickerSet().then((()=>{const t=this.getAnimatedEmojiSticker(e,!0);if(t){const s=this.getAnimatedEmojiSoundDocument(e);return Promise.all([a.Z.downloadDoc(t),s?a.Z.downloadDoc(s):void 0])}}))}saveStickerSet(e,t){const s={_:"messages.stickerSet",set:e.set,packs:e.packs,documents:e.documents};let i=this.storage.getFromCache(t);i?Object.assign(i,s):i=this.storage.setToCache(t,s),this.saveStickers(e.documents);const n=i.set.installed_date||I.has(t);i.refreshTime=Date.now(),this.storage.set({[t]:i},!n)}getStickerSetThumbDownloadOptions(e){var t;const s=e.thumbs.find((e=>"photoSize"===e._)),i=e.thumb_dc_id,n=null===(t=e.pFlags)||void 0===t?void 0:t.animated;return{dcId:i,location:{_:"inputStickerSetThumb",stickerset:this.getStickerSetInput(e),thumb_version:e.thumb_version},size:s.size,mimeType:n?"application/x-tgsticker":"image/webp"}}getStickerSetInput(e){return e.id===_?{_:"inputStickerSetAnimatedEmoji"}:e.id===y?{_:"inputStickerSetAnimatedEmojiAnimations"}:e.access_hash?{_:"inputStickerSetID",id:e.id,access_hash:e.access_hash}:{_:"inputStickerSetShortName",short_name:""+e.id}}getFeaturedStickers(){return v(this,void 0,void 0,(function*(){return(yield i.Z.invokeApiHashable({method:"messages.getFeaturedStickers",processResult:e=>((0,p.Z)(e),(0,m.Z)(e.sets,((e,t,s)=>{e.set.pFlags.videos&&!f.Z&&s.splice(t,1)})),e.sets.forEach((e=>{this.saveStickerSet({set:e.set,documents:[],packs:[]},e.set.id)})),e)})).sets}))}toggleStickerSet(e){return v(this,void 0,void 0,(function*(){if(e.installed_date){if(yield i.Z.invokeApi("messages.uninstallStickerSet",{stickerset:this.getStickerSetInput(e)}))return delete e.installed_date,n.default.dispatchEvent("stickers_deleted",e),this.storage.delete(e.id,!0),!0}else if(yield i.Z.invokeApi("messages.installStickerSet",{stickerset:this.getStickerSetInput(e),archived:!1}))return e.installed_date=Date.now()/1e3|0,n.default.dispatchEvent("stickers_installed",e),!0;return!1}))}searchStickerSets(e,t=!0){return v(this,void 0,void 0,(function*(){const s=t?1:0,n=yield i.Z.invokeApiHashable({method:"messages.searchStickerSets",params:{flags:s,exclude_featured:t||void 0,q:e},processResult:e=>((0,p.Z)(e),(0,m.Z)(e.sets,((e,t,s)=>{e.set.pFlags.videos&&!f.Z&&s.splice(t,1)})),e.sets.forEach((e=>{this.saveStickerSet({set:e.set,documents:[],packs:[]},e.set.id)})),e)}),a=[],r=this.storage.getCache();for(let t in r){const{set:s}=r[t];s.title.toLowerCase().includes(e.toLowerCase())&&!n.sets.find((e=>e.set.id===s.id))&&a.push({_:"stickerSetCovered",set:s,cover:null})}return n.sets.concat(a)}))}getAllStickers(){return i.Z.invokeApiHashable({method:"messages.getAllStickers",processResult:e=>((0,p.Z)(e),(0,m.Z)(e.sets,((e,t,s)=>{e.pFlags.videos&&!f.Z&&s.splice(t,1)})),e)})}preloadStickerSets(){return this.getAllStickers().then((e=>Promise.all(e.sets.map((e=>this.getStickerSet(e,{useCache:!0}))))))}getStickersByEmoticon(e,t=!0){return e=u.Z.fixEmoji(e),this.getStickersByEmoticonsPromises[e]?this.getStickersByEmoticonsPromises[e]:this.getStickersByEmoticonsPromises[e]=Promise.all([i.Z.invokeApiHashable({method:"messages.getStickers",params:{emoticon:e},processResult:e=>e}),t?this.preloadStickerSets():[],t?this.getRecentStickers():void 0]).then((([t,s,i])=>{const n=t.stickers.map((e=>a.Z.saveDoc(e))),r=[],o=[],d=t=>{for(const s of t)if(u.Z.fixEmoji(s.emoticon).includes(e))for(const e of s.documents){const t=a.Z.getDoc(e);(t.animated?r:o).push(t)}};if(i){d(i.packs);const e=i.stickers;[r,o].forEach((t=>{t.sort(((t,s)=>e.indexOf(t)-e.indexOf(s)))}))}for(const e of s)d(e.packs);const l=[...new Set(r.concat(o,n))];return(0,m.Z)(l,((e,t,s)=>{3!==e.sticker||f.Z||s.splice(t,1)})),l}))}pushRecentSticker(e){const t=u.Z.fixEmoji(e.stickerEmojiRaw);for(const s in this.getStickersByEmoticonsPromises)this.getStickersByEmoticonsPromises[s].then((i=>{const n=i.findAndSplice((t=>t.id===e.id));n?i.unshift(n):s.includes(t)&&i.unshift(e)}))}};o.GO.appStickersManager=P;const S=P},5555:(e,t,s)=>{s.d(t,{Z:()=>Z});var i=s(410),n=s(6690),a=s(1655),r=s(3725),o=s(467);function d(e){return e&&e.toLowerCase()||""}var l=s(632),c=s(6272),h=s(5880),u=s(3442),p=s(677),g=s(4727),f=s(9518),m=s(1507),v=s(8045),_=s(8598),y=s(3512),I=s(7381),P=s(5185),S=s(8138),M=s(6440),w=s(4687);const C=new class{constructor(){this.storage=w.default.storages.users,this.updateUsersStatuses=()=>{const e=(0,l.bz)(!0);for(const t in this.users){const s=this.users[t];this.updateUserStatus(s,e)}},this.clear(!0),setInterval(this.updateUsersStatuses,6e4),y.default.addEventListener("state_synchronized",this.updateUsersStatuses),y.default.addMultipleEventsListeners({updateUserStatus:e=>{const t=e.user_id,s=this.users[t];s&&(s.status=e.status,s.status&&("expires"in s.status&&(s.status.expires-=v.Z.serverTimeOffset),"was_online"in s.status&&(s.status.was_online-=v.Z.serverTimeOffset)),y.default.dispatchEvent("user_update",t),this.setUserToStateIfNeeded(s))},updateUserPhoto:e=>{var t,s;const i=e.user_id,n=this.users[i];if(n){if((null===(t=n.photo)||void 0===t?void 0:t.photo_id)===(null===(s=e.photo)||void 0===s?void 0:s.photo_id))return;this.forceUserOnline(i,e.date),"userProfilePhotoEmpty"===e.photo._?delete n.photo:n.photo=(0,u.Z)(n.photo,e.photo),this.setUserToStateIfNeeded(n),y.default.dispatchEvent("user_update",i),y.default.dispatchEvent("avatar_update",i.toPeerId())}else console.warn("No user by id:",i)},updateUserName:e=>{const t=e.user_id,s=this.users[t];s&&(this.forceUserOnline(t),this.saveApiUser(Object.assign(Object.assign({},s),{first_name:e.first_name,last_name:e.last_name,username:e.username}),!0))}}),y.default.addEventListener("language_change",(e=>{const t=this.getSelf().id;this.contactsIndex.indexObject(t,this.getUserSearchText(t))})),w.default.getState().then((e=>{const t=w.default.storagesResults.users;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];s&&(this.users[s.id]=s,this.setUserNameToCache(s))}const s=e.contactsList;s&&Array.isArray(s)&&(s.forEach((e=>{this.pushContact(e)})),s.length&&(this.contactsFillPromise=(0,r.b)(),this.contactsFillPromise.resolve(this.contactsList))),w.default.addEventListener("peerNeeded",(e=>{if(!M.Z.isUser(e))return;const t=e.toUserId();this.storage.getFromCache(t)||this.storage.set({[t]:this.getUser(t)})})),w.default.addEventListener("peerUnneeded",(e=>{if(!M.Z.isUser(e))return;const t=e.toUserId();this.storage.getFromCache(t)&&this.storage.delete(t)}))}))}clear(e=!1){if(e)this.users={},this.usernames={};else{const e=w.default.storagesResults.users;for(const t in this.users){if(!t)continue;const s=t.toPeerId();if(!w.default.isPeerNeeded(s)){const s=this.users[t];s.username&&delete this.usernames[d(s.username)],e.findAndSplice((e=>e.id===t)),this.storage.delete(t),delete this.users[t]}}}this.getTopPeersPromises={},this.contactsIndex=this.createSearchIndex(),this.contactsFillPromise=void 0,this.contactsList=new Set,this.updatedContactsList=!1}onContactsModified(){const e=[...this.contactsList];w.default.pushToState("contactsList",e)}fillContacts(){var e;if(this.contactsFillPromise&&this.updatedContactsList)return{cached:this.contactsFillPromise.isFulfilled,promise:this.contactsFillPromise};this.updatedContactsList=!0;const t=(0,r.b)();return f.Z.invokeApi("contacts.getContacts").then((e=>{"contacts.contacts"===e._&&(this.contactsList.clear(),this.saveApiUsers(e.users),e.contacts.forEach((e=>{this.pushContact(e.user_id)})),this.onContactsModified(),this.contactsFillPromise=t),t.resolve(this.contactsList)}),(()=>{this.updatedContactsList=!1})),{cached:null===(e=this.contactsFillPromise)||void 0===e?void 0:e.isFulfilled,promise:this.contactsFillPromise||(this.contactsFillPromise=t)}}resolveUsername(e){return"@"===e[0]&&(e=e.slice(1)),e=e.toLowerCase(),this.usernames[e]?Promise.resolve(this.users[this.usernames[e]]):f.Z.invokeApi("contacts.resolveUsername",{username:e}).then((e=>(this.saveApiUsers(e.users),S.Z.saveApiChats(e.chats),M.Z.getPeer(M.Z.getPeerId(e.peer)))))}pushContact(e){this.contactsList.add(e),this.contactsIndex.indexObject(e,this.getUserSearchText(e)),w.default.requestPeerSingle(e.toPeerId(),"contact")}popContact(e){this.contactsList.delete(e),this.contactsIndex.indexObject(e,""),w.default.releaseSinglePeer(e.toPeerId(),"contact")}getUserSearchText(e){const t=this.users[e];return t?[t.first_name,t.last_name,t.phone,t.username,t.pFlags.self?g.default.format("SavedMessages",!0):"",t.pFlags.self?"Saved Messages":""].filter(Boolean).join(" "):""}getContacts(e,t=!1,s="name"){return this.fillContacts().promise.then((i=>{let n=[...i];if(e){const t=this.contactsIndex.search(e);n=[...n].filter((e=>t.has(e)))}"name"===s?n.sort(((e,t)=>{const s=(this.users[e]||{}).sortName||"",i=(this.users[t]||{}).sortName||"";return s.localeCompare(i)})):"online"===s&&n.sort(((e,t)=>{const s=C.getUserStatusForSort(C.getUser(e).status);return C.getUserStatusForSort(C.getUser(t).status)-s}));const r=y.default.myId.toUserId();return(0,a.Z)(n,r),t&&this.testSelfSearch(e)&&n.unshift(r),n}))}getContactsPeerIds(e,t,s){return this.getContacts(e,t,s).then((e=>e.map((e=>e.toPeerId(!1)))))}toggleBlock(e,t){return f.Z.invokeApiSingle(t?"contacts.block":"contacts.unblock",{id:M.Z.getInputPeerById(e)}).then((s=>(s&&P.Z.processLocalUpdate({_:"updatePeerBlocked",peer_id:M.Z.getOutputPeer(e),blocked:t}),s)))}testSelfSearch(e){const t=this.getSelf(),s=this.createSearchIndex();return s.indexObject(t.id,this.getUserSearchText(t.id)),s.search(e).has(t.id)}createSearchIndex(){return new I.Z({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0})}saveApiUsers(e,t){e.saved||(e.saved=!0,e.forEach((e=>this.saveApiUser(e,t))))}setUserNameToCache(e,t){if(!t||t.username!==e.username){if(null==t?void 0:t.username){const e=d(t.username);delete this.usernames[e]}if(e.username){const t=d(e.username);this.usernames[t]=e.id}}}saveApiUser(e,t){var s,i;if("userEmpty"===e._)return;const n=e.id,a=this.users[n];if(void 0===e.pFlags&&(e.pFlags={}),e.pFlags.min&&void 0!==a)return;if(this.setUserNameToCache(e,a),a&&void 0!==a.initials&&void 0!==a.sortName&&a.first_name===e.first_name&&a.last_name===e.last_name)e.sortName=a.sortName,e.initials=a.initials;else{const t=e.first_name+(e.last_name?" "+e.last_name:"");e.sortName=e.pFlags.deleted?"":(0,o.ZP)(t,!1),e.initials=_.o.getAbbreviation(t)}e.status&&(e.status.expires&&(e.status.expires-=v.Z.serverTimeOffset),e.status.was_online&&(e.status.was_online-=v.Z.serverTimeOffset));let r=!1,d=!1;if(void 0===a)this.users[n]=e;else{e.first_name===a.first_name&&e.last_name===a.last_name&&e.username===a.username||(d=!0),(null===(s=a.photo)||void 0===s?void 0:s.photo_id)!==(null===(i=e.photo)||void 0===i?void 0:i.photo_id)&&(r=!0);const t=!!a.pFlags.contact,o=!!e.pFlags.contact;(0,u.Z)(a,e),y.default.dispatchEvent("user_update",n),t!==o&&this.onContactUpdated(n,o,t)}r&&y.default.dispatchEvent("avatar_update",e.id.toPeerId()),d&&y.default.dispatchEvent("peer_title_edit",e.id.toPeerId()),this.setUserToStateIfNeeded(e)}setUserToStateIfNeeded(e){w.default.isPeerNeeded(e.id.toPeerId())&&this.storage.set({[e.id]:e})}formatUserPhone(e){return"+"+(0,c.u)(e).formatted}isUserOnlineVisible(e){return this.getUserStatusForSort(e)>3}getUserStatusForSort(e){if("object"!=typeof e&&(e=this.getUser(e).status),e){const t="userStatusOnline"===e._?e.expires:"userStatusOffline"===e._?e.was_online:0;if(t)return t;switch(e._){case"userStatusRecently":return 3;case"userStatusLastWeek":return 2;case"userStatusLastMonth":return 1}}return 0}getUser(e){return(0,h.Z)(e)?e:this.users[e]||{id:e,pFlags:{deleted:!0},access_hash:""}}getSelf(){return this.getUser(y.default.myId)}getUserStatusString(e){var t;let s,i;switch(e){case m.hj:s="Peer.RepliesNotifications";break;case m.yF:s="Peer.ServiceNotifications";break;default:{if(this.isBot(e)){s="Bot";break}const n=this.getUser(e);if(!n){s="";break}if(n.pFlags.support){s="SupportStatus";break}switch(null===(t=n.status)||void 0===t?void 0:t._){case"userStatusRecently":s="Lately";break;case"userStatusLastWeek":s="WithinAWeek";break;case"userStatusLastMonth":s="WithinAMonth";break;case"userStatusOffline":{const e=n.status.was_online,t=new Date,a=(t.getTime()/1e3|0)-e;if(a<60)s="Peer.Status.justNow";else if(a<3600)s="Peer.Status.minAgo",i=[a/60|0];else if(a<86400&&t.getDate()===new Date(1e3*e).getDate())s="LastSeen.HoursAgo",i=[a/3600|0];else{s="Peer.Status.LastSeenAt";const{dateEl:t,timeEl:n}=(0,l.rz)(e);i=[t,n]}break}case"userStatusOnline":s="Online";break;default:s="ALongTimeAgo"}break}}return(0,g.i18n)(s,i)}isBot(e){return this.users[e]&&!!this.users[e].pFlags.bot}isContact(e){return this.contactsList.has(e)||!(!this.users[e]||!this.users[e].pFlags.contact)}isRegularUser(e){const t=this.users[e];return t&&!this.isBot(e)&&!t.pFlags.deleted&&!t.pFlags.support}isNonContactUser(e){return this.isRegularUser(e)&&!this.isContact(e)&&e.toPeerId()!==y.default.myId}hasUser(e,t){const s=this.users[e];return(0,h.Z)(s)&&(t||!s.pFlags.min)}canSendToUser(e){const t=this.getUser(e);return!t.pFlags.deleted&&t.id.toPeerId()!==m.hj}getUserPhoto(e){const t=this.getUser(e);return t&&t.photo||{_:"userProfilePhotoEmpty"}}getUserString(e){const t=this.getUser(e);return"u"+e+(t.access_hash?"_"+t.access_hash:"")}getUserInput(e){const t=this.getUser(e);return t.pFlags&&t.pFlags.self?{_:"inputUserSelf"}:{_:"inputUser",user_id:e,access_hash:t.access_hash}}getUserInputPeer(e){const t=this.getUser(e);return t.pFlags&&t.pFlags.self?{_:"inputPeerSelf"}:{_:"inputPeerUser",user_id:e,access_hash:t.access_hash}}getContactMediaInput(e){const t=this.getUser(e);return{_:"inputMediaContact",first_name:t.first_name,last_name:t.last_name,phone_number:t.phone,vcard:"",user_id:e}}updateUserStatus(e,t=(0,l.bz)(!0)){e.status&&"userStatusOnline"===e.status._&&e.status.expires<t&&(e.status={_:"userStatusOffline",was_online:e.status.expires},y.default.dispatchEvent("user_update",e.id),this.setUserToStateIfNeeded(e))}forceUserOnline(e,t){if(this.isBot(e))return;const s=(0,l.bz)(!0);if(t){if(s-t>=60)return}else if(P.Z.updatesState.syncLoading)return;const i=this.getUser(e);i&&i.status&&"userStatusOnline"!==i.status._&&"userStatusEmpty"!==i.status._&&!i.pFlags.support&&!i.pFlags.deleted&&(i.status={_:"userStatusOnline",expires:s+60},y.default.dispatchEvent("user_update",e),this.setUserToStateIfNeeded(i))}importContact(e,t,s){return this.importContacts([{first_name:e,last_name:t,phones:[s]}]).then((e=>{if(!e.length){const e=new Error;throw e.type="NO_USER",e}return e[0]}))}importContacts(e){const t=[];for(let s=0;s<e.length;++s)for(let i=0;i<e[s].phones.length;++i)t.push({_:"inputPhoneContact",client_id:(s<<16|i).toString(10),phone:e[s].phones[i],first_name:e[s].first_name,last_name:e[s].last_name});return f.Z.invokeApi("contacts.importContacts",{contacts:t}).then((e=>(this.saveApiUsers(e.users),e.imported.map((e=>(this.onContactUpdated(e.user_id,!0),e.user_id))))))}getTopPeers(e){return this.getTopPeersPromises[e]?this.getTopPeersPromises[e]:this.getTopPeersPromises[e]=w.default.getState().then((t=>{const s=t.topPeersCache[e];return s&&s.cachedTime+864e5>Date.now()&&s.peers?s.peers:f.Z.invokeApi("contacts.getTopPeers",{[e]:!0,offset:0,limit:15,hash:"0"}).then((s=>{let i=[];return"contacts.topPeers"===s._&&(this.saveApiUsers(s.users),S.Z.saveApiChats(s.chats),s.categories.length&&(i=s.categories[0].peers.map((e=>{const t=M.Z.getPeerId(e.peer);return w.default.requestPeer(t,"topPeer"),{id:t,rating:e.rating}})))),t.topPeersCache[e]={peers:i,cachedTime:Date.now()},w.default.pushToState("topPeersCache",t.topPeersCache),i}))}))}getBlocked(e=0,t=0){return f.Z.invokeApiSingle("contacts.getBlocked",{offset:e,limit:t}).then((e=>(this.saveApiUsers(e.users),S.Z.saveApiChats(e.chats),{count:"contacts.blocked"===e._?e.users.length+e.chats.length:e.count,peerIds:e.users.map((e=>e.id.toPeerId())).concat(e.chats.map((e=>e.id.toPeerId(!0))))})))}getLocated(e,t,s,i=!1,n=0){const a={_:"inputGeoPoint",lat:e,long:t,accuracy_radius:s};return f.Z.invokeApi("contacts.getLocated",{geo_point:a,background:i}).then((e=>(P.Z.processUpdateMessage(e),e)))}searchContacts(e,t=20){const s=_.o.parseEntities(e);if(s.length&&s[0].length===e.trim().length&&"messageEntityUrl"===s[0]._)try{const t=new URL(_.o.wrapUrl(e).url).pathname.slice(1);t&&(e=t)}catch(e){}return f.Z.invokeApiCacheable("contacts.search",{q:e,limit:t},{cacheSeconds:60}).then((e=>(this.saveApiUsers(e.users),S.Z.saveApiChats(e.chats),{my_results:(0,n.Z)(e.my_results.map((e=>M.Z.getPeerId(e)))),results:e.results.map((e=>M.Z.getPeerId(e)))})))}onContactUpdated(e,t,s=this.isContact(e)){t!==s&&(t?this.pushContact(e):this.popContact(e),this.onContactsModified(),y.default.dispatchEvent("contacts_update",e))}updateUsername(e){return f.Z.invokeApi("account.updateUsername",{username:e}).then((e=>{this.saveApiUser(e)}))}setUserStatus(e,t){if(this.isBot(e))return;const s=this.users[e];if(s){const i=t?{_:"userStatusOffline",was_online:(0,l.bz)(!0)}:{_:"userStatusOnline",expires:(0,l.bz)(!0)+50};s.status=i,y.default.dispatchEvent("user_update",e),this.setUserToStateIfNeeded(s)}}addContact(e,t,s,i,n){return f.Z.invokeApi("contacts.addContact",{id:this.getUserInput(e),first_name:t,last_name:s,phone:i,add_phone_privacy_exception:n}).then((t=>{P.Z.processUpdateMessage(t,{override:!0}),this.onContactUpdated(e,!0)}))}deleteContacts(e){return f.Z.invokeApi("contacts.deleteContacts",{id:e.map((e=>this.getUserInput(e)))}).then((t=>{P.Z.processUpdateMessage(t,{override:!0}),e.forEach((e=>{this.onContactUpdated(e,!1)}))}))}isRestricted(e){const t=this.getUser(e),s=t.restriction_reason;return!!(t.pFlags.restricted&&s&&(0,p.X)(s))}};i.GO.appUsersManager=C;const Z=C},646:(e,t,s)=>{s.d(t,{Z:()=>u});var i=s(3714),n=s(1592),a=s(8598),r=s(3512),o=s(410),d=s(3442),l=s(8456);const c=new Set(["photo","video","gif","document"]),h=new class{constructor(){this.webpages={},this.pendingWebPages={},r.default.addMultipleEventsListeners({updateWebPage:e=>{this.saveWebPage(e.webpage)}})}saveWebPage(e,t,s){var o,h;if("webPageNotModified"===e._)return;const{id:u}=e,p=this.webpages[u],g=p&&p._===e._&&p.hash==p.hash;if("webPage"===e._){"photo"===(null===(o=e.photo)||void 0===o?void 0:o._)?e.photo=i.Z.savePhoto(e.photo,s):delete e.photo,"document"===(null===(h=e.document)||void 0===h?void 0:h._)?e.document=n.Z.saveDoc(e.document,s):("document"===e.type&&delete e.type,delete e.document);const t=e.site_name;let r=e.title||e.author||t||"";t&&r===t&&delete e.site_name,r=(0,l.Z)(r,80,100),e.rTitle=a.o.wrapRichText(r,{noLinks:!0,noLinebreaks:!0});let d="";if("GitHub"===t){const t=e.url.match(/(https?:\/\/github\.com\/[^\/]+\/[^\/]+)/);t&&(d=t[0]+"/issues/{1}")}const u=(0,l.Z)(e.description||"",150,180);e.rDescription=a.o.wrapRichText(u,{contextSite:t||"external",contextHashtag:d}),c.has(e.type)||e.description||!e.photo||(e.type="photo")}let f=this.pendingWebPages[u];if(t&&(f||(f=this.pendingWebPages[u]=new Set),f.add(t)),void 0===p?this.webpages[u]=e:(0,d.Z)(p,e),!t&&void 0!==f&&g){const e=[];f.forEach((t=>{const[s,i,n]=t.split("_");e.push({peerId:s.toPeerId(),mid:+i,isScheduled:!!n})})),r.default.dispatchEvent("webpage_updated",{id:u,msgs:e})}return e}getMessageKeyForPendingWebPage(e,t,s){return e+"_"+t+(s?"_s":"")}deleteWebPageFromPending(e,t){const s=e.id;if(!s)return;const i=this.pendingWebPages[s];i&&i.has(t)&&(i.delete(t),i.size||delete this.pendingWebPages[s])}getWebPage(e){return this.webpages[e]}};o.GO&&(o.GO.appWebPagesManager=h);const u=h},3075:(e,t,s)=>{s.d(t,{Z:()=>r});var i=s(5953),n=s(5003),a=s(6752);class r{constructor(e){var t;(0,i.Z)(this,e),this.log||(this.log=(null===(t=this.connection)||void 0===t?void 0:t.log)||(0,n.kg)("CALL-CONNECTION-BASE")),this.sources={}}createPeerConnection(e){return this.connection||(this.connection=function(e,t){t||(t=(0,n.kg)("RTCPeerConnection")),t("constructor");const s=new RTCPeerConnection(e);return s.addEventListener("track",(e=>{t("ontrack",e)})),s.addEventListener("signalingstatechange",(()=>{t("onsignalingstatechange",s.signalingState)})),s.addEventListener("connectionstatechange",(()=>{t("onconnectionstatechange",s.connectionState)})),s.addEventListener("negotiationneeded",(()=>{t("onnegotiationneeded",s.signalingState)})),s.addEventListener("icecandidate",(e=>{t("onicecandidate",e)})),s.addEventListener("iceconnectionstatechange",(()=>{t("oniceconnectionstatechange",s.iceConnectionState)})),s.addEventListener("datachannel",(()=>{t("ondatachannel")})),s.log=t,{connection:s}}(e,this.log.bindPrefix("connection")).connection)}createDataChannel(e){return this.dataChannel||(this.dataChannel=function(e,t,s){s||(s=(0,n.kg)("RTCDataChannel"));const i=e.createDataChannel("data",t);return i.addEventListener("message",(e=>{s("onmessage",e)})),i.addEventListener("open",(()=>{s("onopen")})),i.addEventListener("close",(()=>{s("onclose")})),i.log=s,i}(this.connection,e,this.log.bindPrefix("data")))}createDescription(){return this.description||(this.description=new a.ZP(this.connection))}appendStreamToConference(){return this.streamManager.appendToConference(this.description)}closeConnection(){const{connection:e}=this;if(e)try{e.log("close"),e.close()}catch(e){this.log.error(e)}}closeConnectionAndStream(e){this.closeConnection(),e&&this.streamManager.stop()}negotiate(){return this.negotiating||(this.negotiating=this.negotiateInternal().finally((()=>{this.negotiating=void 0})))}sendDataChannelData(e){"open"===this.dataChannel.readyState&&this.dataChannel.send(JSON.stringify(e))}}},8500:(e,t,s)=>{s.d(t,{Z:()=>p});var i=s(3241),n=s(319),a=s(9125),r=s(9337),o=s(382),d=s(5424);function l(){const e={main:{},screen:{}};return t=>{return s=this,i=void 0,a=function*(){const{isScreen:s,constraints:i}=t,n=e[s?"screen":"main"];let a=n[i.audio?"audio":"video"];a||(a=(s?o.Z:d.Z)(i,t.muted),i.audio&&!n.audio&&(n.audio=a.finally((()=>n.audio=void 0))),i.video&&!n.video&&(n.video=a.finally((()=>n.video=void 0))));try{return yield a}catch(e){throw e}},new((n=void 0)||(n=Promise))((function(e,t){function r(e){try{d(a.next(e))}catch(e){t(e)}}function o(e){try{d(a.throw(e))}catch(e){t(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(r,o)}d((a=a.apply(s,i||[])).next())}));var s,i,n,a}}window.getStreamCached=l;var c=s(312),h=s(49),u=s(4081);class p extends i.Z{constructor(){super(!1);const e=this.player=document.createElement("div");e.classList.add("call-player"),e.style.display="none",document.body.append(e),this.elements=new Map;const t=this.audio=new Audio;t.autoplay=!0,t.volume=1,this.player.append(t),this.elements.set("audio",t),this.fixSafariAudio(),this.getStream=l()}get isSharingAudio(){return!!this.streamManager.hasInputTrackKind("audio")}get isSharingVideo(){return!!this.streamManager.hasInputTrackKind("video")}fixSafariAudio(){this.audio.play().catch(n.Z)}requestAudioSource(e){return this.requestInputSource(!0,!1,e)}requestInputSource(e,t,s){const{streamManager:i}=this;if(i){const s=!e||this.isSharingAudio,i=!t||this.isSharingVideo;if(s&&i)return Promise.resolve()}const n={audio:e&&(0,a.Z)(),video:t&&(0,c.Z)()};return this.getStream({constraints:n,muted:s}).then((e=>{this.onInputStream(e)}))}requestScreen(){return this.getStream({isScreen:!0,constraints:(0,r.Z)(!0)}).then((e=>{this.onInputStream(e)}))}getElement(e){return this.elements.get(""+e)}cleanup(){this.player.textContent="",this.player.remove(),this.elements.clear(),this.streamManager.stop(),super.cleanup()}onTrack(e){this.tryAddTrack({stream:e.streams[0],track:e.track,type:"output"})}saveInputVideoStream(e,t){const s=e.getVideoTracks()[0];this.tryAddTrack({stream:e,track:s,type:"input",source:t||"main"})}tryAddTrack({stream:e,track:t,type:s,source:i}){i||(i=u.Z.getSource(e,s)),this.log("tryAddTrack",e,t,s,i);const a="output"===s,{player:r,elements:o,streamManager:d}=this,l=t.kind,c="video"===l,h=c?i:l;let p=o.get(h);c&&t.addEventListener("ended",(()=>{this.log("[track] onended"),o.delete(h)}),{once:!0}),a&&d.addTrack(e,t,s);const g=c?e:d.outputStream;if(p)p.paused&&p.play().catch(n.Z),p.srcObject=g;else{if(p=document.createElement(l),p.autoplay=!0,p.srcObject=g,p.volume=1,"undefined"!==p.sinkId){const{outputDeviceId:e}=this;e&&p.setSinkId(e)}c?(p.setAttribute("playsinline","true"),p.muted=!0):r.appendChild(p),o.set(h,p)}return i}setMuted(e){this.streamManager.inputStream.getAudioTracks().forEach((t=>{"audio"===(null==t?void 0:t.kind)&&(t.enabled=void 0===e?!t.enabled:!e)}))}onInputStream(e){if(this.isClosing)e.getTracks().forEach((e=>{(0,h.Z)(e)}));else{e.getVideoTracks().length&&this.saveInputVideoStream(e,"main");const{streamManager:t,description:s}=this;t.addStream(e,"input"),s&&t.appendToConference(s)}}}},1677:(e,t,s)=>{s.d(t,{KM:()=>i,iK:()=>n});const i=50,n=100},9078:(e,t,s)=>{s.d(t,{Z:()=>T});var i=s(4762),n=s(1655),a=s(5953),r=s(6724),o=s(5185),d=s(2459),l=s(6440),c=s(5003),h=s(9518),u=s(1507),p=s(3512),g=s(8500),f=s(7625),m=s(3075),v=s(8479),_=s(6752),y=s(9124),I=s(4373),P=s(3773),S=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class M extends m.Z{constructor(e){super(e),this.negotiateThrottled=(0,r.Z)(this.negotiate.bind(this),0,!1)}createPeerConnection(){return this.connection||super.createPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",iceCandidatePoolSize:0})}createDataChannel(){if(this.dataChannel)return this.dataChannel;const e=super.createDataChannel();return e.addEventListener("open",(()=>{this.maybeUpdateRemoteVideoConstraints()})),e.addEventListener("close",(()=>{this.updateConstraintsInterval&&(clearInterval(this.updateConstraintsInterval),this.updateConstraintsInterval=void 0)})),e}createDescription(){return this.description?this.description:super.createDescription()}appendStreamToConference(){super.appendStreamToConference()}invokeJoinGroupCall(e,t,s){return S(this,void 0,void 0,(function*(){const{groupCall:i,description:n}=this,a=i.id,r=t.map((t=>{const s=function(e,t){const s=(0,P.Z)(e,t),i=t.mediaType,n={source:s.source,sourceGroups:s.sourceGroups,type:i};s.fingerprint.setup="active";const a={fingerprints:[s.fingerprint],pwd:s.pwd,ssrc:s.source,"ssrc-groups":s.sourceGroups||[],ufrag:s.ufrag};return{params:{_:"dataJSON",data:JSON.stringify(a)},source:s.source,media:t,sourceGroups:s.sourceGroups,entry:n}}(e,t);return this.sources[s.entry.type]=s.entry,s}));let l;const c=r.find((e=>"audio"===e.media.mediaType)),u=r.find((e=>"video"===e.media.mediaType));let{source:g,params:m}=c||{};const v=u||c,_={audio:c,video:u};if(n.entries.forEach((e=>{if("sendonly"===e.direction){const t=_[e.type];if(!t)return;n.setEntrySource(e,t.sourceGroups||t.source),n.setEntryPeerId(e,p.default.myId)}})),m!==v.params){const e=JSON.parse(v.params.data);g?e.ssrc=g:delete e.ssrc,m={_:"dataJSON",data:JSON.stringify(e)}}const y=d.Z.getGroupCallInput(a);if("main"===s.type){const e={call:y,join_as:{_:"inputPeerSelf"},params:m,muted:s.isMuted,video_stopped:!s.joinVideo};l=h.Z.invokeApi("phone.joinGroupCall",e),this.log(`[api] joinGroupCall id=${a}`,e)}else{const e={call:y,params:m};l=h.Z.invokeApi("phone.joinGroupCallPresentation",e),this.log(`[api] joinGroupCallPresentation id=${a}`,e)}const I=yield l;o.Z.processUpdateMessage(I);const S=I.updates.find((e=>"updateGroupCallConnection"===e._)),M=JSON.parse(S.params.data);return M.audio=M.audio||i.connections.main.description.audio,n.setData(M),function(e,t){["audio","video"].filter((e=>t[e])).map((e=>[t[e],e])).forEach((([t,s])=>{const i=e.find((e=>e.mediaType===s));if(!i)return;const n=(e=>{const t={};return e.attributes.get("extmap").forEach((e=>{const s=e.key.split("/",1)[0];t[s]=e.value})),t})(i);(0,f.Z)(t["rtp-hdrexts"],((e,t,i)=>{n[e.id]!==e.uri&&(i.splice(t,1),console.log("[sdp] filtered extmap:",e,t,s))}))}))}(t,M),M}))}negotiateInternal(){return S(this,void 0,void 0,(function*(){const{connection:e,description:t}=this,s="new"===e.iceConnectionState&&!t.getEntryByMid("0").source,i=this.log.bindPrefix("startNegotiation");i("start");const n=yield e.createOffer({iceRestart:!1});s&&this.dataChannel&&t.createEntry("application").setDirection("sendrecv");const{sdp:a,offer:r}=function(e){const{offer:t,data:s}=e,i=(0,y.DV)(t.sdp);let n=!1;if(e.skipAddingMulticast||(n=(0,y.e6)(i)||n),(0,f.Z)(i.media,((e,t,a)=>{if(e.isSending)return;if("application"===e.mediaType)return;const r=e.mediaLine,o=r.mediaLineParts,d=(o.ids,r.toString()),l=s[e.mediaType]["payload-types"].map((e=>""+e.id));if(d!==(0,I.Px)(e.mediaType,void 0,l)){const r=(0,P.Z)(i,e);let d=Object.assign({},s);d.transport=(0,v.Z)(d.transport),d.transport.ufrag=r.ufrag,d.transport.pwd=r.pwd,d.transport.fingerprints=[r.fingerprint],d.transport.candidates=[];const l=new _.Lp(r.mid,o.type);l.setPort(o.port),r.source&&l.setSource(r.sourceGroups||r.source),l.setDirection(e.direction);const c=(new I.DY).addSsrcEntry(l,d).finalize(),h=(0,y.DV)(c).media[0];a[t]=h,n=!0}})),n){const e=i.toString();t.sdp=e}return{offer:t,sdp:i}}({offer:n,data:t});i("[sdp] setLocalDescription",r.sdp),yield e.setLocalDescription(r);const o=a.media.filter((e=>"application"!==e.mediaType&&e.isSending));if(s)try{yield this.invokeJoinGroupCall(a,o,this.options)}catch(e){this.log.error("[tdweb] joinGroupCall error",e)}const d=[],l=a.bundle;(0,f.Z)(l,((e,s,i)=>{const n=t.getEntryByMid(e);n.shouldBeSkipped(!0)&&(i.splice(s,1),d.push(n))}));const c=a.media.map((e=>{const s=e.mid;let i=t.getEntryByMid(s);return i||(i=new _.Lp(s,e.mediaType),i.setDirection("inactive")),i})),h={type:"answer",sdp:t.generateSdp({bundle:l,entries:c,isAnswer:!0})};d.forEach((e=>{t.deleteEntry(e)})),i(`[sdp] setRemoteDescription signaling=${e.signalingState} ice=${e.iceConnectionState} gathering=${e.iceGatheringState} connection=${e.connectionState}`,h.sdp),yield e.setRemoteDescription(h),i("end")}))}negotiate(){let e=this.negotiating;return e||(e=super.negotiate(),this.updateConstraints&&e.then((()=>{this.maybeUpdateRemoteVideoConstraints(),this.updateConstraints=!1})),"presentation"===this.options.type&&e.then((()=>{this.connection.getTransceivers().find((e=>{var t,s;"video"===(null===(s=null===(t=e.sender)||void 0===t?void 0:t.track)||void 0===s?void 0:s.kind)&&e.sender.setParameters(Object.assign(Object.assign({},e.sender.getParameters()),{degradationPreference:"maintain-resolution"}))}))})),e)}maybeUpdateRemoteVideoConstraints(){if("open"!==this.dataChannel.readyState)return;this.log("maybeUpdateRemoteVideoConstraints");const e={colibriClass:"ReceiverVideoConstraints",constraints:{},defaultConstraints:{maxHeight:0},onStageEndpoints:[]};for(const t of this.description.entries){if("recvonly"!==t.direction||"video"!==t.type)continue;const{endpoint:s}=t;e.onStageEndpoints.push(s),e.constraints[s]={minHeight:180,maxHeight:720}}this.sendDataChannelData(e),e.onStageEndpoints.length?this.updateConstraintsInterval||(this.updateConstraintsInterval=window.setInterval(this.maybeUpdateRemoteVideoConstraints.bind(this),5e3)):this.updateConstraintsInterval&&(clearInterval(this.updateConstraintsInterval),this.updateConstraintsInterval=void 0)}addInputVideoStream(e){this.groupCall.saveInputVideoStream(e,this.type),this.streamManager.addStream(e,"input"),this.appendStreamToConference()}}var w=s(2207),C=s(9337),Z=s(382),b=s(5424),k=s(312),E=s(49),A=s(4081),D=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function r(e){try{d(i.next(e))}catch(e){a(e)}}function o(e){try{d(i.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class T extends g.Z{constructor(e){super(),(0,a.Z)(this,e),this.log||(this.log=(0,c.kg)("GROUP-CALL")),this.connections||(this.connections={}),this.isSpeakingMap||(this.isSpeakingMap=new Map),this.pinnedSources=[],this.participantsSsrcs=new Map,this.hadAutoPinnedSources=new Set,this.dispatchPinnedThrottled=(0,r.Z)((()=>{this.dispatchEvent("pinned",this.pinnedSource)}),0,!1),this.addEventListener("state",(e=>{e===w.Z.CLOSED&&this.cleanup()}))}get connectionState(){return this.connections.main.connection.iceConnectionState}get state(){const{connectionState:e}=this;if("closed"===e)return w.Z.CLOSED;if("connected"===e||i.IS_SAFARI&&"completed"===e){const{participant:e}=this;return e.pFlags.can_self_unmute?e.pFlags.muted?w.Z.MUTED:w.Z.UNMUTED:w.Z.MUTED_BY_ADMIN}return w.Z.CONNECTING}get participants(){return d.Z.getCachedParticipants(this.id)}get isSharingScreen(){return!!this.connections.presentation}get pinnedSource(){return this.pinnedSources[this.pinnedSources.length-1]}get isMuted(){return this.state!==w.Z.UNMUTED}get isClosing(){const{state:e}=this;return e===w.Z.CLOSED}get streamManager(){return this.connections.main.streamManager}get description(){return this.connections.main.description}pinSource(e){(0,n.Z)(this.pinnedSources,e),this.pinnedSources.push(e),this.dispatchPinnedThrottled()}unpinSource(e){this.hadAutoPinnedSources.delete(e),(0,n.Z)(this.pinnedSources,e),this.dispatchPinnedThrottled()}unpinAll(){this.pinnedSources.length=0,this.dispatchPinnedThrottled()}getParticipantByPeerId(e){return u.NM===e?this.participant:this.participants.get(e)}toggleMuted(){return this.requestAudioSource(!0).then((()=>d.Z.toggleMuted()))}getElement(e){return super.getElement(e)}getVideoElementFromParticipantByType(e,t){let s;s=e.pFlags.self?"video"===t?"main":"presentation":e[t].source_groups[0].sources[0];const i=this.getElement(s);if(!i)return;const n=i.cloneNode();return n.srcObject=i.srcObject,{video:n,source:s}}createConnectionInstance(e){return this.connections[e.type]=new M(Object.assign({groupCall:this,log:this.log.bindPrefix(e.type)},e))}changeRaiseHand(e){return d.Z.editParticipant(this.id,this.participant,{raiseHand:e})}startScreenSharingInternal(){return D(this,void 0,void 0,(function*(){try{const e="presentation",t=yield(0,Z.Z)((0,C.Z)()),s=new A.Z,i=this.createConnectionInstance({streamManager:s,type:e,options:{type:e}});i.createPeerConnection().addEventListener("negotiationneeded",(()=>{i.negotiate()})),t.getVideoTracks()[0].addEventListener("ended",(()=>{this.connections.presentation&&this.stopScreenSharing()}),{once:!0}),i.createDescription(),i.addInputVideoStream(t)}catch(e){this.log.error("start screen sharing error",e)}}))}startScreenSharing(){return this.startScreenSharingPromise||(this.startScreenSharingPromise=this.startScreenSharingInternal().finally((()=>{this.startScreenSharingPromise=void 0})))}stopScreenSharing(){const e=this.connections.presentation;return e?(delete this.connections.presentation,this.unpinSource("presentation"),e.closeConnectionAndStream(!0),delete this.participant.presentation,d.Z.saveApiParticipant(this.id,this.participant),h.Z.invokeApi("phone.leaveGroupCallPresentation",{call:d.Z.getGroupCallInput(this.id)}).then((e=>{o.Z.processUpdateMessage(e)}))):Promise.resolve()}toggleScreenSharing(){return this.isSharingScreen?this.stopScreenSharing():this.startScreenSharing()}startVideoSharingInternal(){return D(this,void 0,void 0,(function*(){const e={video:(0,k.Z)()};try{const t=yield(0,b.Z)(e,!1);this.connections.main.addInputVideoStream(t),yield d.Z.editParticipant(this.id,this.participant,{videoPaused:!1,videoStopped:!1})}catch(t){this.log.error("startVideoSharing error",t,e)}}))}startVideoSharing(){return this.startVideoSharingPromise||(this.startVideoSharingPromise=this.startVideoSharingInternal().finally((()=>{this.startVideoSharingPromise=void 0})))}stopVideoSharing(){return D(this,void 0,void 0,(function*(){const e=this.connections.main,t=e.streamManager.inputStream.getVideoTracks()[0];t&&((0,E.Z)(t),e.streamManager.appendToConference(e.description),yield d.Z.editParticipant(this.id,this.participant,{videoStopped:!0}))}))}toggleVideoSharing(){return this.isSharingVideo?this.stopVideoSharing():this.startVideoSharing()}hangUp(e=!1,t=!1,s=!1){return D(this,void 0,void 0,(function*(){for(const e in this.connections)this.connections[e].closeConnectionAndStream(!t);if(this.dispatchEvent("state",this.state),!s&&!t){let t;const s=d.Z.getGroupCallInput(this.id);if(e)this.log(`[api] discardGroupCall id=${this.id}`),t=h.Z.invokeApi("phone.discardGroupCall",{call:s});else if(this.joined){this.log(`[api] leaveGroupCall id=${this.id}`);const e=this.connections.main;t=h.Z.invokeApi("phone.leaveGroupCall",{call:s,source:e.sources.audio.source})}else this.log(`[api] id=${this.id} payload=null`),t=h.Z.invokeApi("phone.joinGroupCall",{call:s,join_as:{_:"inputPeerSelf"},muted:!0,video_stopped:!0,params:{_:"dataJSON",data:""}});const i=yield t;o.Z.processUpdateMessage(i)}}))}tryAddTrack(e){const{description:t}=this,s=super.tryAddTrack(e);if("output"===e.type){const e=t.getEntryBySource(+s),i=this.participants.get(e.peerId);i&&p.default.dispatchEvent("group_call_participant",{groupCallId:this.id,participant:i})}return s}onParticipantUpdate(e,t){const s=this.connections.main,{connection:i,description:n}=s,a=l.Z.getPeerId(e.peer),r=!!e.pFlags.left,o=this.participantsSsrcs.get(a)||[];if(e.presentation&&!r){const{source:t}=d.Z.makeSsrcFromParticipant(e,"video",e.presentation.source_groups,e.presentation.endpoint);this.hadAutoPinnedSources.has(t)||(this.hadAutoPinnedSources.add(t),this.pinSource(e.pFlags.self?"presentation":t))}if(e.pFlags.self){this.participant=e,s.sources.audio.source!==e.source&&this.hangUp();let i=!1;return e.pFlags.can_self_unmute?e.pFlags.muted&&(i=!0):(this.stopScreenSharing(),this.stopVideoSharing(),i=!0),i&&this.setMuted(!0),void(t!==a&&this.dispatchEvent("state",this.state))}const c=r?[]:d.Z.makeSsrcsFromParticipant(e);r?this.participantsSsrcs.delete(a):this.participantsSsrcs.set(a,c);const h=new Set;o.forEach((e=>{const t=e.source;if(!c.find((e=>e.source===t))){this.unpinSource(t);const e=n.getEntryBySource(t);e&&"inactive"!==e.direction&&(e.setDirection("inactive"),h.add(e.type))}})),c.forEach((e=>{let t=n.getEntryBySource(e.source);t?"inactive"===t.direction&&(t.setDirection(t.originalDirection),h.add(t.type)):(t=n.createEntry(e.type),n.setEntrySource(t,e.sourceGroups||e.source),n.setEntryPeerId(t,a),"video"===e.type&&t.setEndpoint(e.endpoint),t.createTransceiver(i,{direction:"recvonly"}),h.add(t.type))})),h.size&&(h.has("video")&&(s.updateConstraints=!0),s.negotiateThrottled())}}},2207:(e,t,s)=>{var i;s.d(t,{Z:()=>n}),function(e){e[e.UNMUTED=0]="UNMUTED",e[e.MUTED=1]="MUTED",e[e.MUTED_BY_ADMIN=2]="MUTED_BY_ADMIN",e[e.CONNECTING=3]="CONNECTING",e[e.CLOSED=4]="CLOSED"}(i||(i={}));const n=i},9125:(e,t,s)=>{function i(){const e={channelCount:2};return["noiseSuppression","echoCancellation","autoGainControl"].forEach((t=>{(function(e){var t;return(!!(null===(t=null===navigator||void 0===navigator?void 0:navigator.mediaDevices)||void 0===t?void 0:t.getSupportedConstraints()))[e]})(t)&&(e[t]=!0)})),e}s.d(t,{Z:()=>i})},9337:(e,t,s)=>{function i(e){const t={video:{width:{max:1920},height:{max:1080},frameRate:{max:30}}};return e||(t.audio=!0),t}s.d(t,{Z:()=>i})},382:(e,t,s)=>{s.d(t,{Z:()=>i});function i(e){return t=this,s=void 0,n=function*(){const t=yield navigator.mediaDevices.getDisplayMedia(e);return t.getVideoTracks()[0].contentHint="text",t},new((i=void 0)||(i=Promise))((function(e,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(r,o)}d((n=n.apply(t,s||[])).next())}));var t,s,i,n}},5424:(e,t,s)=>{s.d(t,{Z:()=>i});function i(e,t){return s=this,i=void 0,a=function*(){const s=yield navigator.mediaDevices.getUserMedia(e);return s.getTracks().forEach((e=>{e.enabled=!t})),s},new((n=void 0)||(n=Promise))((function(e,t){function r(e){try{d(a.next(e))}catch(e){t(e)}}function o(e){try{d(a.throw(e))}catch(e){t(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(r,o)}d((a=a.apply(s,i||[])).next())}));var s,i,n,a}window.getStream=i},312:(e,t,s)=>{function i(){return{width:{min:1280,max:1920},height:{min:720,max:1080},frameRate:{min:24,max:30}}}s.d(t,{Z:()=>i})},3773:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(8957);function n(e,t){const s=t.lookupAttributeKeys({"ice-ufrag":!0,"ice-pwd":!0,fingerprint:!0,setup:!0,ssrc:!0,mid:!0,"ssrc-group":!1});if(!s.fingerprint){const t=e.session.lines.find((e=>{var t;return"fingerprint"===(null===(t=e.parsed)||void 0===t?void 0:t.key)}));s.fingerprint=t.parsed.value}const n=function(e){const t=e.map((e=>{const[t,...s]=e.split(" ");return{_:"groupCallParticipantVideoSourceGroup",semantics:t,sources:s.map((e=>(0,i.Fk)(+e)))}}));return t.length?t:void 0}(s["ssrc-group"]),[a,r]=s.fingerprint.split(" ",2),o=s.ssrc&&(0,i.Fk)(+s.ssrc.split(" ",1)[0]);return{raw:s,ufrag:s["ice-ufrag"],pwd:s["ice-pwd"],fingerprint:{fingerprint:r,setup:s.setup,hash:a},source:o,sourceGroups:n,mid:s.mid}}},49:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(6669);function n(e){e.stop(),(0,i.Z)(e,"ended")}},6752:(e,t,s)=>{s.d(t,{Lp:()=>r,ZP:()=>d,z_:()=>o});var i=s(1655),n=s(5953),a=s(4373);class r{constructor(e,t){this.mid=e,this.type=t,this.port=a._D}setDirection(e){return this.originalDirection||(this.originalDirection=e),this.direction=e}setPort(e){return this.port=e}setEndpoint(e){return this.endpoint=e}setPeerId(e){return this.peerId=e}createTransceiver(e,t){return(null==t?void 0:t.direction)&&this.setDirection(t.direction),this.transceiver=e.addTransceiver((0,a.pl)(this.type),t)}setSource(e){let t;if(Array.isArray(e)){if(!e[0])return;t=e,e=t[0].sources[0]}return this.sourceGroups=t,this.source=e}shouldBeSkipped(e){return e&&"inactive"===this.direction}}function o(e,t,s){let i;if(Array.isArray(t)){if(!t[0])return;i=t,t=i[0].sources[0]}return{endpoint:s,type:e,source:t,sourceGroups:i}}class d{constructor(e){this.connection=e,this.sessionId=""+Date.now(),this.maxSeenId=-1,this.entries=[],this.entriesByMid=new Map,this.entriesBySource=new Map,this.entriesByPeerId=new Map}setData(e){return(0,n.Z)(this,e)}createEntry(e){const t=""+ ++this.maxSeenId,s=new r(t,e);return this.entries.push(s),this.entriesByMid.set(t,s),s}deleteEntry(e){(0,i.Z)(this.entries,e),this.entriesByMid.delete(e.mid),this.entriesBySource.delete(e.source);const t=this.entriesByPeerId.get(e.peerId);t&&(t.delete(e),t.size||this.entriesByPeerId.delete(e.peerId))}setEntrySource(e,t){e.setSource(t),this.entriesBySource.set(e.source,e)}setEntryPeerId(e,t){e.setPeerId(t);let s=this.entriesByPeerId.get(t);s||this.entriesByPeerId.set(t,s=new Set),s.add(e)}findEntry(e){return this.entries.find(e)}findFreeSendRecvEntry(e,t){let s=this.entries.find((s=>"sendrecv"===s.direction&&s.type===e&&!(t?s.sendEntry:s.recvEntry)));return s||(s=this.createEntry(e),s.setDirection("sendrecv")),s}getEntryByMid(e){return this.entriesByMid.get(e)}getEntryBySource(e){return this.entriesBySource.get(e)}getEntriesByPeerId(e){return this.entriesByPeerId.get(e)}generateSdp(e){return a.DY.fromConference(Object.assign({conference:this},e))}}},9124:(e,t,s)=>{s.d(t,{e6:()=>de,DV:()=>re});var i,n,a=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},r=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class o{constructor(e,t){i.set(this,void 0),n.set(this,void 0),a(this,i,e,"f"),a(this,n,t,"f")}get session(){return r(this,i,"f")}get media(){return r(this,n,"f")}get bundle(){return this.session.lines.find((e=>{var t;return"group"===(null===(t=e.parsed)||void 0===t?void 0:t.key)})).value.split(" ").slice(1)}toString(){return this.session.lines.concat(...this.media.map((e=>e.lines))).map((e=>e.toString())).join("\r\n")+"\r\n"}}function d(e,t,s){const i=e.split(t),n=[];for(;s>0&&i.length;)n.push(i.shift()),--s;return i.length&&n.push(i.join(t)),n}i=new WeakMap,n=new WeakMap;var l,c,h,u=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},p=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class g{constructor(e,t){l.set(this,void 0),c.set(this,void 0),h.set(this,void 0),u(this,l,new Set,"f"),u(this,c,e,"f"),u(this,h,t,"f")}generate(){const e=p(this,c,"f"),t=p(this,h,"f"),s=p(this,l,"f"),i=t-e+1;let n=Math.floor(e+i*Math.random()),a=0;for(;s.has(n);)if(n<t?++n:n=e,++a>=i)return null;return s.add(n),n}add(e){p(this,l,"f").add(e)}}l=new WeakMap,c=new WeakMap,h=new WeakMap;var f,m,v=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},_=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class y{constructor(e,t){f.set(this,void 0),m.set(this,void 0),v(this,f,e,"f"),v(this,m,t,"f")}get key(){return _(this,f,"f")}get value(){return _(this,m,"f")}}f=new WeakMap,m=new WeakMap;var I,P,S,M,w=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},C=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class Z{constructor(e,t,s,i){I.set(this,void 0),P.set(this,void 0),S.set(this,void 0),M.set(this,void 0),w(this,I,e,"f"),w(this,P,t,"f"),w(this,S,s,"f"),w(this,M,i,"f")}get type(){return C(this,I,"f")}get port(){return C(this,P,"f")}get protocol(){return C(this,S,"f")}get ids(){return C(this,M,"f")}toString(){return this.type+" "+this.port+" "+this.protocol+" "+this.ids.join(" ")}}I=new WeakMap,P=new WeakMap,S=new WeakMap,M=new WeakMap;var b,k,E,A,D=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},T=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class F{constructor(e,t){if(b.set(this,void 0),k.set(this,void 0),E.set(this,void 0),A.set(this,void 0),D(this,b,e,"f"),"string"==typeof t){if(D(this,k,t,"f"),"m"===e){const e=t.split(" ");D(this,E,new Z(e[0],e[1],e[2],e.slice(3)),"f")}else if("a"===e){const e=d(t,":",1);t=e[0],D(this,A,1===e.length?new y(t,null):new y(t,e[1]),"f")}}else t instanceof Z?(D(this,E,t,"f"),D(this,k,t.toString(),"f")):t instanceof y&&(D(this,A,t,"f"),D(this,k,t.value?`${t.key}:${t.value}`:t.key,"f"))}get key(){return T(this,b,"f")}get value(){return T(this,k,"f")}get parsed(){return T(this,A,"f")}get mediaLineParts(){return T(this,E,"f")}toString(){return`${this.key}=${this.value}`}}b=new WeakMap,k=new WeakMap,E=new WeakMap,A=new WeakMap;var U,x,L,R,O,N,B=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},j=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class G{constructor(e,t,s=":",i=!1){U.set(this,void 0),x.set(this,void 0),L.set(this,void 0),R.set(this,void 0),O.set(this,void 0),N.set(this,void 0),B(this,U,e,"f"),B(this,x,t,"f"),B(this,L,s,"f"),B(this,O,i,"f"),B(this,R,i?new Map:null,"f"),B(this,N,i?[]:null,"f")}get lines(){return j(this,x,"f")}get value(){return j(this,O,"f")||!this.lines.length?null:this.lines[0]}get exists(){return!j(this,O,"f")}get key(){return j(this,U,"f")}get keys(){return G.fill(this),j(this,N,"f")}forEach(e){G.fill(this),j(this,R,"f").forEach(e)}get(e){return G.fill(this),j(this,R,"f").get(e)||new G(e,[],":",!0)}static fill(e){if(null!==j(e,R,"f"))return;const t=new Map;e.lines.forEach((s=>{const[i,n]=d(s,j(e,L,"f"),1),a=t.get(i)||[];t.set(i,[...a,n||""])}));const s=B(e,R,G.makeAttributes(t),"f");B(e,N,Array.from(s.keys()),"f")}static makeAttributes(e){const t=new Map;return e.forEach(((e,s)=>{t.set(s,new G(s,e))})),t}}U=new WeakMap,x=new WeakMap,L=new WeakMap,R=new WeakMap,O=new WeakMap,N=new WeakMap;var H,z,q=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},V=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class W{constructor(e){H.set(this,void 0),z.set(this,void 0),q(this,H,e,"f"),q(this,z,new Map,"f"),W.fillAttributes(this)}get(e){return V(this,z,"f").get(e)||new G(e,[]," ",!0)}static fillAttributes(e){const t=new Map;V(e,H,"f").forEach((e=>{if("a"===e.key){const{key:s,value:i}=e.parsed;let n=t.get(s);n||(n=[],t.set(s,n)),n.push(i||"")}})),t.forEach(((t,s)=>{V(e,z,"f").set(s,new G(s,t," ",!1))}))}}H=new WeakMap,z=new WeakMap;var $,K,J,Q,Y=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},X=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class ee{constructor(e){$.set(this,void 0),K.set(this,void 0),J.set(this,void 0),Q.set(this,void 0),Y(this,$,e,"f"),Y(this,K,e[0],"f"),Y(this,J,Y(this,Q,null,"f"),"f")}get lines(){return X(this,$,"f")}get mediaLine(){return X(this,K,"f")}get mediaLineParts(){return X(this,K,"f").mediaLineParts}get mediaType(){return this.mediaLineParts.type}get direction(){if(!X(this,Q,"f")){const e=this.attributes;let t;t=e.get("sendonly").exists?"sendonly":e.get("recvonly").exists?"recvonly":e.get("inactive").exists?"inactive":"sendrecv",Y(this,Q,t,"f")}return X(this,Q,"f")}get isSending(){return"sendrecv"===this.direction||"sendonly"===this.direction}get isReceiving(){return"sendrecv"===this.direction||"recvonly"===this.direction}get attributes(){return X(this,J,"f")||Y(this,J,new W(this.lines),"f"),X(this,J,"f")}get mid(){return this.attributes.get("mid").value}lookupAttributeKeys(e){const t={};for(const s in e){const i=this.attributes.get(s),n=!e[s];t[s]=i?n?i.lines:i.value:n?[]:void 0}return t}}$=new WeakMap,K=new WeakMap,J=new WeakMap,Q=new WeakMap;var te,se,ie=function(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s},ne=function(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)};class ae{constructor(e){te.set(this,void 0),se.set(this,void 0),ie(this,te,e,"f"),ie(this,se,e.filter((e=>"o"===e.key)).map((e=>e.value.split(" ")[1]))[0],"f")}get lines(){return ne(this,te,"f")}get sessionId(){return ne(this,se,"f")}}function re(e){function t(){s?i.push(new ee(n)):s=new ae(n)}let s=null,i=[],n=[];return e.split(/\r?\n/).forEach((e=>{if(!function(e){return/^[\s\xa0]*$/.test(e)}(e)){const s=oe(e);"m"===s.key&&(t(),n=[]),n.push(s)}})),t(),new o(s,i)}function oe(e){const t=d(e,"=",1);return new F(t[0],t[1])}function de(e){let t;return e.media.forEach(((s,i)=>{if("video"===s.mediaType&&s.isSending&&!s.attributes.get("ssrc-group").get("SIM").exists){t||(t=new g(2,4294967295));const n=s.attributes.get("ssrc-group").get("FID").value.split(" "),a=s.lines;n.forEach((e=>t.add(+e)));const r=[n[0],t.generate(),t.generate()],o=[n[1],t.generate(),t.generate()];a.push(oe("a=ssrc-group:SIM "+r.join(" ")));const d=s.attributes.get("ssrc").get(n[0]).lines;r.forEach(((e,t)=>{const s=o[t];t>0&&(a.push(oe("a=ssrc-group:FID "+e+" "+s)),d.forEach((t=>{a.push(oe("a=ssrc:"+e+" "+t))})),d.forEach((e=>{a.push(oe("a=ssrc:"+s+" "+e))})))})),e.media[i]=new ee(a)}})),!!t}te=new WeakMap,se=new WeakMap},4373:(e,t,s)=>{s.d(t,{DY:()=>c,Px:()=>l,_D:()=>r,pl:()=>o});var i=s(4762),n=s(630),a=s(8957);const r="9";function o(e){return"screencast"===e?"video":e}function d(e){return"application"===e?"DTLS/SCTP":"UDP/TLS/RTP/SAVPF"}function l(e,t=r,s){const i=d(e);return`m=${o(e)} ${t} ${i} ${s.join(" ")}`}class c extends n.Z{addCandidate(e){return this.add(function(e){const t=[];return t.push("a=candidate:"),t.push(`${e.foundation} ${e.component} ${e.protocol.toUpperCase()} ${e.priority} ${e.ip} ${e.port} typ ${e.type}`),void 0!==e["rel-addr"]&&t.push(` raddr ${e["rel-addr"]} rport ${e["rel-port"]}`),t.push(` generation ${e.generation}`),t.join("")}(e))}addHeader(e,t){const s=t.join(" ");return this.add("v=0",`o=- ${e} 2 IN IP4 0.0.0.0`,"s=-","t=0 0","a=extmap-allow-mixed",`a=group:BUNDLE ${s}`,"a=ice-options:trickle","a=msid-semantic:WMS *")}addTransport(e,t){this.add(`a=ice-ufrag:${e.ufrag}`,`a=ice-pwd:${e.pwd}`,"a=ice-options:trickle");for(const t of e.fingerprints)this.add(`a=fingerprint:${t.hash} ${t.fingerprint}`,`a=setup:${t.setup}`);if(!t&&e.candidates)for(const t of e.candidates)this.addCandidate(t);return this}addSsrc(e){let t="stream",{type:s,sourceGroups:i}=e;const n=(0,a.h)(e.source);t+=n,s+=n;const r=e=>{this.add(`a=ssrc:${e} cname:${t}`,`a=ssrc:${e} msid:${t} ${s}`,`a=ssrc:${e} mslabel:${t}`,`a=ssrc:${e} label:${s}`)};return(()=>{this.add(`a=msid:${t} ${s}`)})(),(null==i?void 0:i.length)?i.forEach((e=>{if(e.sources.length){const t=e.sources.map(a.h);this.add(`a=ssrc-group:${e.semantics} ${t.join(" ")}`),t.forEach(r)}})):r(n),this}addSsrcEntry(e,t,s){const i=(...e)=>this.add(...e),{type:n,mid:a,direction:r,port:c}=e,h=t.transport,u="application"===n,p=u?void 0:t[n],g="inactive"===r;if(e.shouldBeSkipped(s))return i(`m=${o(n)} 0 ${d(n)} 0`,"c=IN IP4 0.0.0.0","a=inactive",`a=mid:${a}`);const f=u?[{id:5e3}]:p["payload-types"],m=f.map((e=>e.id));i(l(n,c,m),"c=IN IP4 0.0.0.0",`a=rtcp:${c} IN IP4 0.0.0.0`),h["rtcp-mux"]&&i("a=rtcp-mux"),i(`a=mid:${a}`);let v=r;if("sendrecv"===r||!s||g||u||(v="sendonly"===r?"recvonly":"sendonly"),i(`a=${v}`),this.addTransport(h),u)i(`a=sctpmap:${f[0].id} webrtc-datachannel 256`);else{const e=p["rtp-hdrexts"];(null==e?void 0:e.length)&&e.forEach((e=>{i(`a=extmap:${e.id} ${e.uri}`)})),f.forEach((e=>{i(`a=rtpmap:${e.id} ${e.name}/${e.clockrate}${e.channels&&e.channels>1?`/${e.channels}`:""}`);const t=e.parameters;if(Array.isArray(t))t.length&&console.error("parameters is array???",t);else if(t&&Object.keys(t).length){const s=[];for(const e in t)s.push(`${e}=${t[e]}`);i(`a=fmtp:${e.id} ${s.join(";")}`)}const s=e["rtcp-fbs"];(null==s?void 0:s.length)&&s.forEach((t=>{i(`a=rtcp-fb:${e.id} ${t.type}${t.subtype?" "+t.subtype:""}`)}))}))}return!e.source||"sendonly"!==v&&"sendrecv"!==v||this.addSsrc(e),this}addConference(e){const{conference:t,entries:s,bundle:n,isAnswer:a}=e;this.addHeader(t.sessionId,n),i.IS_FIREFOX&&this.addTransport(t.transport);for(const e of s)this.addSsrcEntry((a?e.recvEntry||e.sendEntry:e.sendEntry||e.recvEntry)||e,t,a);return this}static fromConference(e){return(new c).addConference(e).finalize()}}},4081:(e,t,s)=>{s.d(t,{Z:()=>c});var i=s(5003),n=s(3512),a=s(1677),r=s(49),o=s(4373),d=s(8957);class l{constructor(e,t){const s=this.streamSource=e.createMediaStreamSource(t),i=this.analyser=e.createAnalyser();this.gain=e.createGain(),i.minDecibels=-100,i.maxDecibels=-30,i.smoothingTimeConstant=.05,i.fftSize=1024,s.connect(i)}}class c{constructor(e){this.interval=e,this.getAmplitude=e=>{const{streamAnalyser:t,stream:s,track:i,source:n,type:a}=e,r=t.analyser;if(!r)return;const o=new Uint8Array(r.frequencyBinCount);return r.getByteFrequencyData(o),{type:a,source:n,stream:s,track:i,value:(0,d.UN)(o)}},this.analyse=()=>{const e=this.counter%3==0,t=(e?this.items:this.items.filter((e=>"input"===e.type))).filter((e=>"audio"===e.kind)).slice(0,a.KM).map(this.getAmplitude);++this.counter>=1e3&&(this.counter=0),n.default.dispatchEvent("group_call_amplitude",{amplitudes:t,type:e?"all":"input"})},this.context=new(window.AudioContext||window.webkitAudioContext),this.items=[],this.outputStream=new MediaStream,this.inputStream=new MediaStream,this.counter=0,this.log=(0,i.kg)("SM"),this.direction="sendonly",this.canCreateConferenceEntry=!0,this.types=["audio","video"]}addStream(e,t){e.getTracks().forEach((s=>{this.addTrack(e,s,t)}))}addTrack(e,t,s){this.log("addTrack",s,t,e);const{context:i,items:n,inputStream:a,outputStream:r}=this,o=t.kind,d=c.getSource(e,s);switch(s){case"input":a?a.addTrack(t):this.inputStream=e;break;case"output":for(let e=0;e<n.length;++e){const{track:t,type:s,source:i}=n[e];if(i===d&&"input"===s){n.splice(e,1),r.removeTrack(t);break}}"video"!==o&&r.addTrack(t)}this.finalizeAddingTrack({type:s,source:d,stream:e,track:t,kind:o,streamAnalyser:"audio"===o?new l(i,e):void 0}),"audio"===o&&this.interval&&this.changeTimer()}finalizeAddingTrack(e){const{track:t}=e;t.addEventListener("ended",(()=>{this.removeTrack(t)}),{once:!0}),this.items.push(e)}hasInputTrackKind(e){return this.items.find((t=>"input"===t.type&&t.kind===e))}static getSource(e,t){return"input"===t?e.source||e.id:""+(0,d.Fk)(+e.id.substring(6))}removeTrack(e){this.log("removeTrack",e);const{items:t}=this;let s=!1;for(let i=0,n=t.length;!s&&i<n;++i){const{track:n,type:a}=t[i];switch(a){case"output":n===e&&(t.splice(i,1),this.outputStream.removeTrack(e),s=!0);break;case"input":n===e&&(t.splice(i,1),this.inputStream.removeTrack(e),s=!0)}}"audio"===e.kind&&this.interval&&this.changeTimer()}replaceInputAudio(e,t){this.removeTrack(t),this.addStream(e,"input")}changeTimer(){void 0!==this.timer&&clearInterval(this.timer),this.items.length&&(this.timer=window.setInterval(this.analyse,this.interval))}appendToConference(e){if(this.locked)return;const{inputStream:t,direction:s,canCreateConferenceEntry:i}=this,n={direction:s,streams:[t]},a=this.types.map((e=>[e,n])),r=t.getTracks();for(const[t,n]of a){let a=e.findEntry((e=>e.direction===s&&e.type===t));if(!a){if(!i)continue;a=e.createEntry(t)}let{transceiver:d}=a;d||(d=a.createTransceiver(e.connection,n)),a.direction!==d.direction&&(d.direction=a.direction);const l=(0,o.pl)(t),c=r.findIndex((e=>e.kind===l)),h=-1!==c?r.splice(c,1)[0]:void 0,u=d.sender;u.track!==h&&u.replaceTrack(h).catch((e=>{this.log.error(e)}))}}stop(){try{this.inputStream.getTracks().concat(this.outputStream.getTracks()).forEach((e=>{(0,r.Z)(e)}))}catch(e){this.log.error(e)}}}},630:(e,t,s)=>{s.d(t,{Z:()=>i});class i{constructor(e="\r\n"){this.joiner=e,this.lines=[],this.newLine=[]}add(...e){return this.lines.push(...e),this}push(e){return this.newLine.push(e),this}addJoined(e=""){return this.add(this.newLine.join(e)),this.newLine=[],this}join(){return this.lines.join(this.joiner)}finalize(){return this.join()+this.joiner}}},8957:(e,t,s)=>{function i(e){return e<<0}function n(e){return e>>>0}function a(e,t=3){if(!e)return 0;const{length:s}=e;let i=0;for(let t=0;t<s;++t)i+=e[t]*e[t];const n=Math.sqrt(i/s)/255;return Math.min(1,n*t)}s.d(t,{Fk:()=>i,UN:()=>a,h:()=>n})},2003:(e,t,s)=>{s.d(t,{Z:()=>u});var i=s(7223),n=s(3847),a=s(410),r=s(9518),o=s(8938),d=s(5003),l=s(1549),c=s(6848);const h=new class{constructor(){this.contexts=new Map,this.links={},this.log=(0,d.kg)("RD",void 0,!0),r.Z.addTaskListener("refreshReference",(e=>{const t=e.payload;(0,o.Z)(e),e.originalPayload=t,this.refreshReference(t).then((t=>{e.payload=t}),(t=>{e.error=t})).then((()=>r.Z.postMessage(e)))}))}saveContext(e,t,s){[s,e]=this.getContexts(e),s||(s=new Set,this.contexts.set(e,s)),this.links[(0,l.Z)(e)]=e;for(const e of s)if((0,c.Z)(e,t))return;s.add(t)}getReferenceByLink(e){return this.links[(0,l.Z)(e)]}getContexts(e){return[this.contexts.get(e)||(e=this.getReferenceByLink(e)||e,this.contexts.get(e)),e]}getContext(e){const t=this.getContexts(e);return t[0]?[t[0].values().next().value,t[1]]:void 0}deleteContext(e,t,s){if([s,e]=this.getContexts(e),s)for(const i of s)if((0,c.Z)(i,t))return s.delete(i),s.size||(this.contexts.delete(e),delete this.links[(0,l.Z)(e)]),!0;return!1}refreshReference(e,t){if(this.log("refreshReference: start",e.slice(),t),!t){const s=this.getContext(e);if(!s)return this.log("refreshReference: got no context for reference:",e.slice()),Promise.reject("NO_CONTEXT");[t,e]=s}let s;switch(null==t?void 0:t.type){case"message":s=i.Z.wrapSingleMessage(t.peerId,t.messageId,!0);break;case"emojiesSounds":s=this.refreshEmojiesSoundsPromise||n.Z.getAnimatedEmojiSounds(!0).then((()=>{this.refreshEmojiesSoundsPromise=void 0}));break;default:return this.log.warn("refreshReference: not implemented context",t),Promise.reject()}const a=(0,l.Z)(e);return this.log("refreshReference: refreshing reference:",a),s.then((()=>{const s=(0,l.Z)(e);if(this.log("refreshReference: refreshed, reference before:",a,"after:",s),a!==s)return e;this.deleteContext(e,t);const i=this.getContext(e);if(i)return this.refreshReference(e,i[0]);throw this.log.error("refreshReference: no new context, reference before:",a,"after:",s,t),"NO_NEW_CONTEXT"}))}};a.GO.referenceDatabase=h;const u=h},8045:(e,t,s)=>{s.d(t,{Z:()=>o});var i=s(410),n=s(7487),a=s(9518);const r=new class{constructor(){this.serverTimeOffset=0,n.Z.get("server_time_offset").then((e=>{e&&(this.serverTimeOffset=e)})),a.Z.addTaskListener("applyServerTimeOffset",(e=>{this.serverTimeOffset=e.payload}))}};i.GO&&(i.GO.serverTimeManager=r);const o=r},9043:(e,t,s)=>{s.d(t,{Z:()=>o});var i=s(410),n=s(4762),a=s(5003);const r=new class{constructor(){this.sampleRate=48e3,this.tasks=[],this.keepAlive=!1,this.log=(0,a.kg)("OPUS",a.v9.Error)}isPlaySupported(){if(void 0!==this.isPlaySupportedResult)return this.isPlaySupportedResult;const e=document.createElement("audio");return this.isPlaySupportedResult=!(!e.canPlayType||!e.canPlayType("audio/ogg;").replace(/no/,""))}loadWavWorker(){this.wavWorker||(this.wavWorker=new Worker("waveWorker.min.js"),this.wavWorker.addEventListener("message",(e=>{const t=e.data;if(this.log("[WAV] got message:",t),t&&t.page){const e=t.page;this.onTaskEnd(this.tasks.shift(),e)}})))}loadWorker(){this.worker||(this.worker=new Worker("decoderWorker.min.js"),this.worker.addEventListener("message",(e=>{const t=e.data;this.log("[DECODER] got message",t),"done"===t.type?(this.wavWorker.postMessage({command:"done"}),t.waveform&&(this.tasks[0].waveform=t.waveform)):this.wavWorker.postMessage({command:"encode",buffers:e.data},n.IS_SAFARI?void 0:t.map((e=>e.buffer)))})))}setKeepAlive(e){this.keepAlive=e,this.keepAlive?(this.loadWorker(),this.loadWavWorker()):this.tasks.length||this.terminateWorkers()}onTaskEnd(e,t){t?(clearTimeout(e.timeout),e.callback.resolve({bytes:t,waveform:e.waveform})):e.callback.reject("timeout"),this.tasks.length&&this.executeNewTask(this.tasks[0]),this.terminateWorkers()}terminateWorkers(e=!1){(!this.keepAlive&&!this.tasks.length||e)&&(this.worker&&(this.worker.terminate(),this.worker=null),this.wavWorker&&(this.wavWorker.terminate(),this.wavWorker=null))}executeNewTask(e){this.worker.postMessage({command:"init",decoderSampleRate:this.sampleRate,outputBufferSampleRate:this.sampleRate}),this.wavWorker.postMessage({command:"init",wavBitDepth:16,wavSampleRate:this.sampleRate}),this.log("[DECODER] send decode"),this.worker.postMessage({command:"decode",pages:e.pages,waveform:e.withWaveform},n.IS_SAFARI?void 0:[e.pages.buffer]),e.timeout=window.setTimeout((()=>{this.log.error("decode timeout"),this.terminateWorkers(!0),this.tasks.length&&(this.loadWorker(),this.loadWavWorker()),this.onTaskEnd(this.tasks.shift())}),1e4)}pushDecodeTask(e,t){return new Promise(((s,i)=>{const n={pages:e,withWaveform:t,callback:{resolve:s,reject:i},timeout:0};this.loadWorker(),this.loadWavWorker(),1===this.tasks.push(n)&&this.executeNewTask(n)}))}decode(e,t=!1){return s=this,i=void 0,a=function*(){return this.pushDecodeTask(e,t).then((e=>{const t=new Blob([e.bytes],{type:"audio/wav"});return{url:URL.createObjectURL(t),waveform:e.waveform}}))},new((n=void 0)||(n=Promise))((function(e,t){function r(e){try{d(a.next(e))}catch(e){t(e)}}function o(e){try{d(a.throw(e))}catch(e){t(e)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(r,o)}d((a=a.apply(s,i||[])).next())}));var s,i,n,a}};i.GO.opusDecodeController=r;const o=r},7381:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(467);class n{constructor(e,t=0){this.options=e,this.minChars=t,this.fullTexts=new Map}indexObject(e,t){if(this.options&&t.trim()&&(t=(0,i.gV)(t,this.options)),!t)return this.fullTexts.delete(e),!1;this.fullTexts.set(e,t)}search(e){const t=this.fullTexts;this.options&&(e=(0,i.gV)(e,this.options));const s=[],n=e.split(" "),a=n.length;return t.forEach(((e,t)=>{let i=!0,r=0;for(let t=0;t<a;++t){const s=n[t],a=e.indexOf(s);if(-1===a||0!==a&&" "!==e[a-1]){i=!1;break}r+=s.length}if(i){r+=a-1;const i=e.length;(this.minChars<=r||i<=r)&&s.push({fullText:e,fullTextLength:i,what:t,foundChars:r})}})),s.sort(((e,t)=>e.fullTextLength-t.fullTextLength||t.foundChars-e.foundChars)),new Set(s.map((e=>e.what)))}}}}]);
//# sourceMappingURL=714.57babe030f5e6d0e0a5d.chunk.js.map